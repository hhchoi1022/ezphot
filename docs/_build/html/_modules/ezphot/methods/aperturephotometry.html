

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ezphot.methods.aperturephotometry &mdash; ezphot 0.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=bbaf98b3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ezphot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imageobjects.html">Imageobjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dataobjects.html">DataObjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ezphot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ezphot.methods.aperturephotometry</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ezphot.methods.aperturephotometry</h1><div class="highlight"><pre>
<span></span><span class="c1">#%%</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span><span class="p">,</span> <span class="n">Ellipse</span><span class="p">,</span> <span class="n">Circle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean</span> <span class="k">as</span> <span class="n">ndi_mean</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">pixel_to_skycoord</span><span class="p">,</span> <span class="n">skycoord_to_pixel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span><span class="p">,</span>
    <span class="n">EllipticalAperture</span><span class="p">,</span> <span class="n">EllipticalAnnulus</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_total_error</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundGenerator</span><span class="p">,</span> <span class="n">ErrormapGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.imageobjects</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">,</span>
    <span class="n">Background</span><span class="p">,</span> <span class="n">Mask</span><span class="p">,</span> <span class="n">Errormap</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.dataobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Catalog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="AperturePhotometry">
<a class="viewcode-back" href="../../../api/aperturephotometry.html#ezphot.methods.aperturephotometry.AperturePhotometry">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AperturePhotometry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method class for performing aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    This class provides methods </span>
<span class="sd">    </span>
<span class="sd">    1. SExtractor-based aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    2. Photutils-based aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    3. Circular aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    4. Elliptical aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    5. Kron aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    6. Circular aperture photometry.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the AperturePhotometry class.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">BackgroundGenerator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errormap</span> <span class="o">=</span> <span class="n">ErrormapGenerator</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sex_photometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="c1"># Input parameters</span>
                       <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">],</span> 
                       <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Background</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># If target_bkg is given, subtract background before sextractor</span>
                       <span class="n">target_bkgrms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># It must be background error map</span>
                       <span class="n">target_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># For masking certain source (such as hot pixels)</span>
                       <span class="n">sex_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">detection_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                       <span class="n">aperture_diameter_arcsec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                       <span class="n">aperture_diameter_seeing</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">],</span> <span class="c1"># If given, use seeing to calculate aperture size</span>
                       <span class="n">saturation_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                       <span class="n">kron_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
                       
                       <span class="c1"># Others</span>
                       <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span>
                       <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform aperture photometry using SExtractor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : Union[ScienceImage, ReferenceImage, CalibrationImage]</span>
<span class="sd">            The target image to perform aperture photometry on.</span>
<span class="sd">        target_bkg : Optional[Background], optional</span>
<span class="sd">            The background to subtract from the target image. Defaults to None.</span>
<span class="sd">        target_bkgrms : Optional[Errormap], optional</span>
<span class="sd">            The background RMS to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        detection_sigma : float, optional</span>
<span class="sd">            The detection sigma for the aperture photometry. Defaults to 5.</span>
<span class="sd">        aperture_diameter_arcsec : Union[float, list], optional</span>
<span class="sd">            The aperture diameter in arcseconds. Defaults to [5, 7, 10].</span>
<span class="sd">        aperture_diameter_seeing : Union[float, list], optional</span>
<span class="sd">            The aperture diameter in seeing units. Defaults to [3.5, 4.5].</span>
<span class="sd">        saturation_level : float, optional</span>
<span class="sd">            The saturation level for the aperture photometry. Defaults to 60000.</span>
<span class="sd">        kron_factor : float, optional</span>
<span class="sd">            The Kron factor for the aperture photometry. Defaults to 2.5.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry catalog. Defaults to True.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output. Defaults to True.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the aperture photometry. Defaults to True.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry figure. Defaults to False.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: If target_img is not a ScienceImage, ReferenceImage, or CalibrationImage.</span>
<span class="sd">        RuntimeError: If the source extractor fails.</span>
<span class="sd">        RuntimeError: If the source extractor fails.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The aperture photometry catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_img</span><span class="p">,</span> <span class="p">(</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;target_img must be a ScienceImage, ReferenceImage, or CalibrationImage.&#39;</span><span class="p">)</span>
        
        <span class="c1"># If target_bkg is given, subtract background before sextractor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_img</span><span class="o">.</span><span class="n">is_saved</span><span class="p">:</span>
            <span class="n">target_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        
        <span class="c1"># If sex_params is None, use default parameters</span>
        <span class="k">if</span> <span class="n">sex_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sex_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="c1">#target_img = target_img.copy()</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
        <span class="n">cat_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span>
        <span class="n">sexconfig_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SEX_CONFIG&#39;</span><span class="p">]</span>
        <span class="n">all_sexconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">sexconfig_path</span><span class="p">)</span>
        
        <span class="c1"># Image</span>
        <span class="n">remove_subbkg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span> 
                <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_bkg</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">saturation_level</span> <span class="o">-=</span> <span class="n">target_bkg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">BKGVALU</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">target_img_sub</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
            <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;BACK_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MANUAL&#39;</span>
            <span class="n">remove_subbkg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="n">target_img</span>
            <span class="k">if</span> <span class="s1">&#39;BACK_TYPE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;BACK_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AUTO&#39;</span>
            
        <span class="c1"># Background RMS</span>
        <span class="n">remove_bkgrms</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">target_bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">is_saved</span><span class="p">:</span>
                <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="n">remove_bkgrms</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">bkgrms_path</span> <span class="o">=</span> <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bkgrms_path</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Mask</span>
        <span class="n">remove_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">target_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_mask</span><span class="o">.</span><span class="n">is_saved</span><span class="p">:</span>
                <span class="n">target_mask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="n">remove_mask</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">target_mask</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="kc">None</span>
                    
        <span class="c1"># First Sextractor run to estimate seeing if not provided</span>
        <span class="k">if</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">catalog_first</span><span class="p">,</span> <span class="n">global_bkgval</span><span class="p">,</span> <span class="n">global_bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">run_sextractor</span><span class="p">(</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">img_path</span><span class="p">,</span>
                <span class="n">sex_configfile</span> <span class="o">=</span> <span class="n">sexconfig_path</span><span class="p">,</span>
                <span class="n">sex_params</span> <span class="o">=</span> <span class="n">sex_params</span><span class="p">,</span>
                <span class="n">target_mask</span> <span class="o">=</span> <span class="n">mask_path</span><span class="p">,</span>
                <span class="n">target_weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">weight_type</span> <span class="o">=</span> <span class="s1">&#39;MAP_RMS&#39;</span><span class="p">,</span>
                <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span>
                <span class="n">return_result</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="p">)</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Source extractor is failed.&#39;</span><span class="p">)</span>
            
            <span class="n">seeing_estimate</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;FLAGS&#39;</span> <span class="ow">in</span> <span class="n">catalog_first</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">rough_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;FLAGS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;MAG_AUTO&#39;</span> <span class="ow">in</span> <span class="n">catalog_first</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;FLUX_MAX&#39;</span> <span class="ow">in</span> <span class="n">catalog_first</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;FLUX_MAX&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ELONGATION&#39;</span> <span class="ow">in</span> <span class="n">catalog_first</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;ELONGATION&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;CLASS_STAR&#39;</span> <span class="ow">in</span> <span class="n">catalog_first</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">seeing_arcsec</span> <span class="o">=</span> <span class="n">catalog_first</span><span class="p">[</span><span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">seeing_arcsec</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">rough_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">seeing_arcsec</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">catalog_filtered</span> <span class="o">=</span> <span class="n">catalog_first</span><span class="p">[</span><span class="n">rough_flags</span><span class="p">]</span>
            <span class="n">seeing_estimate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">catalog_filtered</span><span class="p">[</span><span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seeing_estimate</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span>
        
        <span class="k">if</span> <span class="s2">&quot;SEEING_FWHM&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;SEEING_FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">seeing_estimate</span>            
        <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;PIXEL_SCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>
        
        <span class="n">all_apertures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">aperture_diameter_arcsec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aperture_size</span> <span class="ow">in</span> <span class="n">aperture_diameter_arcsec</span><span class="p">:</span>
            <span class="n">all_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aperture_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aperture_diameter_seeing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">aperture_diameter_seeing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aperture_seeing_ratio</span> <span class="ow">in</span> <span class="n">aperture_diameter_seeing</span><span class="p">:</span>
                <span class="n">all_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seeing_estimate</span> <span class="o">*</span> <span class="n">aperture_seeing_ratio</span><span class="p">)</span>
        
        <span class="n">aperture_diameter_pixel</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">[</span><span class="s1">&#39;pixelscale&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">all_apertures</span><span class="p">])</span>
        <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;PHOT_APERTURES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aperture_diameter_pixel</span> <span class="c1"># This is aperture size in pixel</span>
        <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;SATUR_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation_level</span>
        <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;PHOT_AUTOPARAMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kron_factor</span><span class="si">}</span><span class="s2">,3.5&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;DETECT_MINAREA&#39;</span> <span class="ow">in</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;DETECT_MINAREA&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;DETECT_MINAREA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] DETECT_MINAREA is less than 3. It is set to 3.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;DETECT_THRESH&#39;</span> <span class="ow">in</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sex_params</span><span class="p">[</span><span class="s1">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;[WARNING] DETECT_THRESH is less than 1. It is set to 1.&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_sexconfig</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># If DETECT_MINAREA is not set, use the default value from the config</span>
        <span class="c1"># if &#39;DETECT_MINAREA&#39; not in sex_params.keys():</span>
        <span class="c1">#     sex_params[&#39;DETECT_MINAREA&#39;] = all_sexconfig[&#39;DETECT_MINAREA&#39;]</span>
        <span class="c1"># If DETECT_THRESH is not set, use the detection_sigma</span>
        <span class="c1">#if &#39;DETECT_THRESH&#39; not in sex_params.keys():</span>
        <span class="c1">#    sex_params[&#39;DETECT_THRESH&#39;] = detection_sigma / np.sqrt(sex_params[&#39;DETECT_MINAREA&#39;])</span>
        <span class="c1">#if &#39;ANALYSIS_THRESH&#39; not in sex_params.keys():</span>
        <span class="c1">#    sex_params[&#39;ANALYSIS_THRESH&#39;] = sex_params[&#39;DETECT_THRESH&#39;]</span>

        
        <span class="c1"># Second Sextractor run with the estimated parameters</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">global_bkgval</span><span class="p">,</span> <span class="n">global_bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">run_sextractor</span><span class="p">(</span>
            <span class="n">target_path</span> <span class="o">=</span> <span class="n">img_path</span><span class="p">,</span>
            <span class="n">sex_configfile</span> <span class="o">=</span> <span class="n">sexconfig_path</span><span class="p">,</span>
            <span class="n">sex_params</span> <span class="o">=</span> <span class="n">sex_params</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">target_mask</span> <span class="o">=</span> <span class="n">mask_path</span><span class="p">,</span>
            <span class="n">target_weight</span> <span class="o">=</span> <span class="n">bkgrms_path</span><span class="p">,</span>
            <span class="n">weight_type</span> <span class="o">=</span> <span class="s1">&#39;MAP_RMS&#39;</span><span class="p">,</span>
            <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span>
            <span class="n">return_result</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="p">)</span> 
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Source extractor is failed.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Modification of the catalog</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># 0-based index</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># 0-based index</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_bkgrms</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;SKYVAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_bkgval</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detection_sigma</span>

        <span class="c1"># Kron aperture area</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;KRON_RADIUS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;A_IMAGE&#39;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;KRON_RADIUS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;B_IMAGE&#39;</span><span class="p">]</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;NPIX_AUTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

        <span class="c1"># Circular aperture areas</span>

        <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ap_size_arcsec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_apertures</span><span class="p">):</span>
            <span class="n">radius_pixel</span> <span class="o">=</span> <span class="n">ap_size_arcsec</span> <span class="o">/</span> <span class="n">pixelscale</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">area_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">radius_pixel</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">npix_colname</span> <span class="o">=</span> <span class="s1">&#39;NPIX_APER&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;NPIX_APER_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">catalog</span><span class="p">[</span><span class="n">npix_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">),</span> <span class="n">area_pixel</span><span class="p">)</span>
            <span class="n">pixsize_colname</span> <span class="o">=</span> <span class="s1">&#39;PIXSIZE_APER&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;PIXSIZE_APER_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">catalog</span><span class="p">[</span><span class="n">pixsize_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">),</span> <span class="n">ap_size_arcsec</span> <span class="o">/</span> <span class="n">pixelscale</span><span class="p">)</span>

        <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">catalog</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_objects</span><span class="p">(</span><span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span> 
                                    <span class="n">objects</span><span class="o">=</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                    <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="p">,</span>
                                    <span class="n">show</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">remove_trigger</span><span class="p">,</span> <span class="n">remove_object</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="n">remove_subbkg</span><span class="p">,</span> <span class="n">remove_bkgrms</span><span class="p">,</span> <span class="n">remove_mask</span><span class="p">],</span>
            <span class="p">[</span><span class="n">target_img_sub</span><span class="p">,</span> <span class="n">target_bkgrms</span><span class="p">,</span> <span class="n">target_mask</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">remove_trigger</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing&#39;</span><span class="p">,</span> <span class="n">remove_object</span><span class="p">)</span>
                <span class="n">remove_object</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">target_catalog</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">photutils_photometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="c1"># Input parameters</span>
                             <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">],</span> 
                             <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Background</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">target_bkgrms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">target_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">detection_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">aperture_diameter_arcsec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
                             <span class="n">kron_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
                             <span class="n">minarea_pixels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                             <span class="n">calc_accurate_fwhm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            
                             <span class="c1"># Other options</span>
                             <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform circular and Kron photometry using photutils.SourceCatalog.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : Union[ScienceImage, ReferenceImage, CalibrationImage]</span>
<span class="sd">            The target image to perform aperture photometry on.</span>
<span class="sd">        target_bkg : Optional[Background], optional</span>
<span class="sd">            The background to subtract from the target image. Defaults to None.</span>
<span class="sd">        target_bkgrms : Optional[Errormap], optional</span>
<span class="sd">            The background RMS to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        target_mask : Optional[Mask], optional</span>
<span class="sd">            The mask to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        detection_sigma : float, optional</span>
<span class="sd">            The detection sigma for the aperture photometry. Defaults to 1.5.</span>
<span class="sd">        aperture_diameter_arcsec : Union[float, list], optional</span>
<span class="sd">            The aperture diameter in arcseconds. Defaults to [5,7,10].</span>
<span class="sd">        kron_factor : float, optional</span>
<span class="sd">            The Kron factor for the aperture photometry. Defaults to 2.5.</span>
<span class="sd">        minarea_pixels : int, optional</span>
<span class="sd">            The minimum area in pixels for the aperture photometry. Defaults to 5.</span>
<span class="sd">        calc_accurate_fwhm : bool, optional</span>
<span class="sd">            Whether to calculate the accurate FWHM. Defaults to True.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry catalog. Defaults to True.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output. Defaults to True.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the aperture photometry. Defaults to True.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry figure. Defaults to False.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The aperture photometry catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_img</span><span class="p">,</span> <span class="p">(</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_img must be a ScienceImage, ReferenceImage, or CalibrationImage.&quot;</span><span class="p">)</span>
        
        <span class="n">bkgrms_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bkgrms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mask_map</span> <span class="o">=</span> <span class="n">target_mask</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">target_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">mask_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">mask_map</span><span class="p">)</span>
        <span class="n">target_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Step 1: Background subtraction</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
                <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">target_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_img_sub</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">target_bkg_data</span> <span class="o">=</span> <span class="n">target_bkg</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_bkg_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Step 2: Set error map</span>
        <span class="k">if</span> <span class="n">target_bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bkgrms_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">bkgrms_map</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use sigma-clipped std if no error map available</span>
            <span class="n">bkgrms_map</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errormap</span><span class="o">.</span><span class="n">calculate_errormap_from_image</span><span class="p">(</span>
                <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                <span class="n">target_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;photutils&#39;</span><span class="p">,</span>
                <span class="n">errormap_type</span><span class="o">=</span><span class="s1">&#39;bkgrms&#39;</span><span class="p">,</span>
                <span class="n">n_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span><span class="o">=</span><span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">bkgrms_map</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">error</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">target_data</span><span class="p">,</span> <span class="n">bkg_error</span><span class="o">=</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">effective_gain</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">egain</span><span class="p">)</span>

        <span class="c1"># 3. Segmentation and deblending</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">detection_sigma</span> <span class="o">*</span> <span class="n">bkgrms</span>
        <span class="n">segm</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">minarea_pixels</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">segm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">segm</span> <span class="o">=</span> <span class="n">deblend_sources</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span> <span class="n">segm</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">minarea_pixels</span><span class="p">,</span> <span class="n">nlevels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
        
        <span class="c1"># 4. SourceCatalog (deblended)</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">SourceCatalog</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">target_data</span><span class="p">,</span> <span class="n">segment_img</span><span class="o">=</span><span class="n">segm</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_map</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">target_bkg_data</span><span class="p">,</span> <span class="n">wcs</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="n">kron_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_factor</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">cat_tbl</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;kron_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">kron_radius</span> <span class="o">*</span> <span class="n">kron_factor</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;flux_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">fluxfrac_radius</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;ellipticity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">ellipticity</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;fwhm_pixel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.3548</span> <span class="o">/</span> <span class="mf">1.1774</span> <span class="o">*</span> <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;flux_radius&#39;</span><span class="p">]</span> <span class="c1"># From flux radius, gaussian approximation</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;sky_centroid&#39;</span><span class="p">]</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span>
        <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># FWHM calculation</span>
        <span class="k">if</span> <span class="n">calc_accurate_fwhm</span><span class="p">:</span>
            <span class="n">all_fwhm</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">cat_tbl</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Calculating FWHM...&#39;</span><span class="p">):</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
                <span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">img_extract_stamp</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>  <span class="c1"># make your own stamp function</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                
                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stamp</span><span class="p">),</span> <span class="n">x_mean</span><span class="o">=</span><span class="mf">12.5</span><span class="p">,</span> <span class="n">y_mean</span><span class="o">=</span><span class="mf">12.5</span><span class="p">,</span> <span class="n">x_stddev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">y_stddev</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
                <span class="n">fit_model</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">stamp</span><span class="p">)</span>
                
                <span class="n">fwhm_x</span> <span class="o">=</span> <span class="mf">2.3548</span> <span class="o">*</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">x_stddev</span><span class="o">.</span><span class="n">value</span>
                <span class="n">fwhm_y</span> <span class="o">=</span> <span class="mf">2.3548</span> <span class="o">*</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">y_stddev</span><span class="o">.</span><span class="n">value</span>
                <span class="n">fwhm_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fwhm_x</span> <span class="o">*</span> <span class="n">fwhm_y</span><span class="p">)</span>
                <span class="n">all_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm_avg</span><span class="p">)</span>
            <span class="n">cat_tbl</span><span class="p">[</span><span class="s1">&#39;fwhm_pixel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_fwhm</span>
        
        <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;NUMBER&#39;</span><span class="p">,</span>
            <span class="s1">&#39;xcentroid&#39;</span><span class="p">:</span> <span class="s1">&#39;X_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ycentroid&#39;</span><span class="p">:</span> <span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="s1">&#39;X_WORLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dec&#39;</span><span class="p">:</span> <span class="s1">&#39;Y_WORLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bbox_xmin&#39;</span><span class="p">:</span> <span class="s1">&#39;XMIN_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bbox_xmax&#39;</span><span class="p">:</span> <span class="s1">&#39;XMAX_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bbox_ymin&#39;</span><span class="p">:</span> <span class="s1">&#39;YMIN_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bbox_ymax&#39;</span><span class="p">:</span> <span class="s1">&#39;YMAX_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="s1">&#39;ISOAREA_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;semimajor_sigma&#39;</span><span class="p">:</span> <span class="s1">&#39;A_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;semiminor_sigma&#39;</span><span class="p">:</span> <span class="s1">&#39;B_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;THETA_IMAGE&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="s1">&#39;ECCENTRICITY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ellipticity&#39;</span><span class="p">:</span> <span class="s1">&#39;ELLIPTRICITY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_MIN&#39;</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_MAX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;segment_flux&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_ISO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;segment_fluxerr&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUXERR_ISO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kron_flux&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_AUTO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kron_fluxerr&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUXERR_AUTO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kron_radius&#39;</span><span class="p">:</span> <span class="s1">&#39;KRON_RADIUS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux_radius&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_RADIUS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_pixel&#39;</span><span class="p">:</span> <span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="s1">&#39;FLUX_MAX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_pixel&#39;</span><span class="p">:</span> <span class="s1">&#39;FWHM_IMAGE&#39;</span>
        <span class="p">}</span>
        
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span><span class="c1">#objects.copy()</span>

        <span class="c1"># Modification of the catalog</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">cat_tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">catalog</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_tbl</span><span class="p">[</span><span class="n">old</span><span class="p">]</span>
                
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;FLUX_AUTO&#39;</span><span class="p">])</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;MAGERR_AUTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;FLUXERR_AUTO&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;FLUX_AUTO&#39;</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;KRON_RADIUS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;A_IMAGE&#39;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;KRON_RADIUS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;B_IMAGE&#39;</span><span class="p">]</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;NPIX_AUTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;ELONGATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;A_IMAGE&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;B_IMAGE&#39;</span><span class="p">]</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndi_mean</span><span class="p">(</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">segm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">segm</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;THRESHOLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">detection_sigma</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;DETECT_THRESH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detection_sigma</span>

        <span class="c1"># Circular photometry </span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>
        <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">aperture_diameter_arcsec</span><span class="p">)</span>
        <span class="n">aperture_diameter_pixel</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span> <span class="o">/</span> <span class="n">pixelscale</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">diameter_pixel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aperture_diameter_pixel</span><span class="p">):</span>
            <span class="n">radius_pixel</span> <span class="o">=</span> <span class="n">diameter_pixel</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">circular_phot</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">circular_photometry</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius_pixel</span><span class="p">)</span>
            <span class="n">suffix_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">catalog</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FLUX_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circular_phot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">catalog</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FLUXERR_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circular_phot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">catalog</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAG_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">circular_phot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">catalog</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAGERR_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">circular_phot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">circular_phot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">area_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">radius_pixel</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">catalog</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;NPIX_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">),</span> <span class="n">area_pixel</span><span class="p">)</span>

        <span class="n">cat_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span>  
        <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">catalog</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_objects</span><span class="p">(</span><span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span> 
                                    <span class="n">objects</span><span class="o">=</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                    <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="p">,</span>
                                    <span class="n">show</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">target_catalog</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">circular_photometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                            <span class="n">x_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                            <span class="n">y_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                            <span class="n">aperture_diameter_arcsec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
                            <span class="n">annulus_diameter_arcsec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># When local background is used</span>
                            <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;pixel&#39;</span><span class="p">,</span>
                            <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Background</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">target_mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">target_bkgrms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            
                            <span class="c1"># Other paramters</span>
                            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform circular aperture photometry.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : Union[ScienceImage, ReferenceImage, CalibrationImage]</span>
<span class="sd">            The target image to perform aperture photometry on.</span>
<span class="sd">        x_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The x-coordinates of the sources.</span>
<span class="sd">        y_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The y-coordinates of the sources.</span>
<span class="sd">        aperture_diameter_arcsec : Union[float, list], optional</span>
<span class="sd">            The aperture diameter in arcseconds. Defaults to [5,7,10].</span>
<span class="sd">        annulus_diameter_arcsec : Union[float, list], optional</span>
<span class="sd">            The annulus diameter in arcseconds. Defaults to None.</span>
<span class="sd">        unit : str, optional</span>
<span class="sd">            The unit of the coordinates. Defaults to &#39;pixel&#39;.</span>
<span class="sd">        target_bkg : Optional[Background], optional</span>
<span class="sd">            The background to subtract from the target image. Defaults to None.</span>
<span class="sd">        target_mask : Optional[Mask], optional</span>
<span class="sd">            The mask to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        target_bkgrms : Optional[Errormap], optional</span>
<span class="sd">            The background RMS to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry catalog. Defaults to True.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the aperture photometry. Defaults to True.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry figure. Defaults to False.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The aperture photometry catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Step 1: Background subtraction</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
                <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_img_sub</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            
        <span class="c1"># If target_bkgrms is not given, calculate it from the target image</span>
        <span class="k">if</span> <span class="n">target_bkgrms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_bkgrms</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errormap</span><span class="o">.</span><span class="n">calculate_from_sourcemask</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span>
                <span class="n">errormap_type</span> <span class="o">=</span> <span class="s1">&#39;bkgrms&#39;</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span>
            
        <span class="c1"># Step 2: Prepare data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_mask</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">bkg_error</span><span class="o">=</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">effective_gain</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">egain</span><span class="p">)</span>

        <span class="c1"># Step 3: Pixel scale (arcsec/pix)</span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>

        <span class="c1"># Step 4: Normalize radius inputs</span>
        <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">aperture_diameter_arcsec</span><span class="p">)</span>
        <span class="n">annulus_diameter_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">annulus_diameter_arcsec</span><span class="p">)</span> <span class="k">if</span> <span class="n">annulus_diameter_arcsec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">aperture_diameter_pixel</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span> <span class="o">/</span> <span class="n">pixelscale</span>
        <span class="n">annulus_diameter_pixel</span> <span class="o">=</span> <span class="n">annulus_diameter_arcsec</span> <span class="o">/</span> <span class="n">pixelscale</span> <span class="k">if</span> <span class="n">annulus_diameter_arcsec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Step 5: Source positions</span>
        <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
        <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y_arr</span><span class="p">)</span>

        <span class="n">skycoord</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">))</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span>
            <span class="k">if</span> <span class="n">wcs</span><span class="p">:</span>
                <span class="n">skycoord</span> <span class="o">=</span> <span class="n">pixel_to_skycoord</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">,</span> <span class="n">wcs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">skycoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">y_arr</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
            <span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">skycoord</span><span class="p">,</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unit must be either &#39;pixel&#39; or &#39;coord&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Step 6: Photometry</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">skycoord</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skycoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skycoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">diameter_pixel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aperture_diameter_pixel</span><span class="p">):</span>
            <span class="n">radius_pixel</span> <span class="o">=</span> <span class="n">diameter_pixel</span> <span class="o">/</span><span class="mi">2</span>
            <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius_pixel</span><span class="p">)</span>

            <span class="c1"># Photometry on background-subtracted image</span>
            <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            
            <span class="c1"># Calculation for threshold (when error is defined)</span>
            <span class="k">if</span> <span class="n">bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rms_tbl</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms_tbl</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
                
            <span class="n">suffix_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
            <span class="n">flux_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FLUX_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">fluxerr_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FLUXERR_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">mag_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;MAG_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">magerr_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;MAGERR_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">annul_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FLUX_ANNULUS</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">magannul_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;MAG_ANNULUS</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">npix_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NPIX_APER</span><span class="si">{</span><span class="n">suffix_key</span><span class="si">}</span><span class="s1">&#39;</span>
            
            <span class="c1"># Aperture area</span>
            <span class="n">results</span><span class="p">[</span><span class="n">npix_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>

            <span class="c1"># When annulus is defined</span>
            <span class="k">if</span> <span class="n">annulus_diameter_pixel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">annulus_pixel</span> <span class="o">=</span> <span class="n">annulus_diameter_pixel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span><span class="mi">2</span>
                <span class="n">annulus</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">radius_pixel</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="n">annulus_pixel</span><span class="p">)</span>
                <span class="n">bkg_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annulus</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">bkg_area_ratio</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">annulus</span><span class="o">.</span><span class="n">area</span>
                <span class="n">annulus_bkg_flux</span> <span class="o">=</span> <span class="n">bkg_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bkg_area_ratio</span>

                <span class="n">flux_net</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">annulus_bkg_flux</span>
                <span class="n">results</span><span class="p">[</span><span class="n">flux_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_net</span>
                <span class="n">results</span><span class="p">[</span><span class="n">annul_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">annulus_bkg_flux</span>
                <span class="n">results</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux_net</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">magannul_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">annulus_bkg_flux</span><span class="p">)</span>
            <span class="c1"># When only aperutre is defined</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">flux_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])</span>

            <span class="c1"># When error is defined</span>
            <span class="k">if</span> <span class="s1">&#39;aperture_sum_err&#39;</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">fluxerr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="n">magerr_key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span>

        <span class="n">cat_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.circ.cat&#39;</span><span class="p">)</span>
        <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">results</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_objects</span><span class="p">(</span><span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span> 
                                    <span class="n">objects</span><span class="o">=</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                    <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="p">,</span>
                                    <span class="n">show</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                  
        <span class="k">return</span> <span class="n">target_catalog</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">elliptical_photometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                              <span class="n">x_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>  <span class="c1"># pixel or RA</span>
                              <span class="n">y_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>  <span class="c1"># pixel or Dec</span>
                              <span class="n">sma_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>  <span class="c1"># semi-major (arcsec or pixel)</span>
                              <span class="n">smi_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>  <span class="c1"># semi-minor (arcsec or pixel)</span>
                              <span class="n">theta_arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>  <span class="c1"># degrees</span>
                              <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;pixel&#39;</span><span class="p">,</span>             <span class="c1"># &#39;pixel&#39; or &#39;coord&#39;</span>
                              <span class="n">annulus_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                              <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Background</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">target_mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">target_bkgrms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="c1"># Other parameters</span>
                              <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span>
                              <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform elliptical aperture photometry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : Union[ScienceImage, ReferenceImage, CalibrationImage]</span>
<span class="sd">            The target image to perform aperture photometry on.</span>
<span class="sd">        x_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The x-coordinates of the sources.</span>
<span class="sd">        y_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The y-coordinates of the sources.</span>
<span class="sd">        sma_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The semi-major axis of the sources.</span>
<span class="sd">        smi_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The semi-minor axis of the sources.</span>
<span class="sd">        theta_arr : Union[float, list, np.ndarray]</span>
<span class="sd">            The position angle of the sources.</span>
<span class="sd">        unit : str, optional</span>
<span class="sd">            The unit of the coordinates. Defaults to &#39;pixel&#39;.</span>
<span class="sd">        annulus_ratio : float, optional</span>
<span class="sd">            The ratio of the annulus diameter to the semi-major axis. Defaults to None.</span>
<span class="sd">        target_bkg : Optional[Background], optional</span>
<span class="sd">            The background to subtract from the target image. Defaults to None.</span>
<span class="sd">        target_mask : Optional[Mask], optional</span>
<span class="sd">            The mask to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        target_bkgrms : Optional[Errormap], optional</span>
<span class="sd">            The background RMS to use for the aperture photometry. Defaults to None.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry catalog. Defaults to True.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the aperture photometry. Defaults to True.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the aperture photometry figure. Defaults to False.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The aperture photometry catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Step 1: Background subtraction</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_backgrkound</span><span class="p">(</span>
                <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Step 2: Prepare image data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_mask</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">bkg_error</span><span class="o">=</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">effective_gain</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">egain</span><span class="p">)</span>

        <span class="c1"># Step 3: Convert inputs</span>
        <span class="n">x_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
        <span class="n">y_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y_arr</span><span class="p">)</span>
        <span class="n">sma_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">sma_arr</span><span class="p">)</span>
        <span class="n">smi_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">smi_arr</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta_arr</span><span class="p">))</span>  <span class="c1"># convert to radians</span>

        <span class="c1"># Step 4: Convert (RA, Dec) to (x, y) if needed</span>
        <span class="n">skycoord</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">skycoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">x_raw</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">y_raw</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">skycoord</span><span class="p">,</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span>
            <span class="k">if</span> <span class="n">wcs</span><span class="p">:</span>
                <span class="n">skycoord</span> <span class="o">=</span> <span class="n">pixel_to_skycoord</span><span class="p">(</span><span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">wcs</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord_type must be either &#39;pixel&#39; or &#39;sky&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Step 5: Convert a/b from arcsec to pixels if needed</span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>  <span class="c1"># arcsec/pixel</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">sma_image</span> <span class="o">=</span> <span class="n">sma_raw</span> <span class="o">/</span> <span class="n">pixelscale</span>
            <span class="n">smi_image</span> <span class="o">=</span> <span class="n">smi_raw</span> <span class="o">/</span> <span class="n">pixelscale</span>
        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="n">sma_image</span> <span class="o">=</span> <span class="n">sma_raw</span>
            <span class="n">smi_image</span> <span class="o">=</span> <span class="n">smi_raw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unit must be either &#39;pixel&#39; or &#39;coord&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Step 6: Initialize results table</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SMA_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sma_image</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SMI_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smi_image</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;THETA_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skycoord</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skycoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skycoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SMA_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sma_image</span> <span class="o">*</span> <span class="n">pixelscale</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SMI_WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smi_image</span> <span class="o">*</span> <span class="n">pixelscale</span>

        <span class="c1"># Step 8: Aperture photometry</span>
        <span class="n">fluxes</span><span class="p">,</span> <span class="n">fluxerrs</span><span class="p">,</span> <span class="n">areas</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">apertures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">smai</span><span class="p">,</span> <span class="n">smii</span><span class="p">,</span> <span class="n">thetai</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sma_image</span><span class="p">,</span> <span class="n">smi_image</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
            <span class="n">aperture</span> <span class="o">=</span> <span class="n">EllipticalAperture</span><span class="p">((</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">),</span> <span class="n">a</span><span class="o">=</span><span class="n">smai</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">smii</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">thetai</span><span class="p">)</span>
            <span class="n">apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aperture</span><span class="p">)</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;aperture_sum_err&#39;</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">fluxerrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">bkgrms_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aperture</span> <span class="ow">in</span> <span class="n">apertures</span><span class="p">:</span>
                <span class="n">rms_tbl</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">bkgrms</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">bkgrms_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rms_tbl</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkgrms_all</span>
            
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUX_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MAG_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;NPIX_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">areas</span> 

        <span class="k">if</span> <span class="n">fluxerrs</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUXERR_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxerrs</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MAGERR_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fluxerrs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span>

        <span class="c1"># Step 9: Annulus subtraction</span>
        <span class="k">if</span> <span class="n">annulus_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ann_fluxes</span><span class="p">,</span> <span class="n">ann_areas</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">smai</span><span class="p">,</span> <span class="n">smii</span><span class="p">,</span> <span class="n">thetai</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sma_image</span><span class="p">,</span> <span class="n">smi_image</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
                <span class="n">annulus</span> <span class="o">=</span> <span class="n">EllipticalAnnulus</span><span class="p">((</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">),</span> <span class="n">a_in</span><span class="o">=</span><span class="n">smai</span><span class="p">,</span> <span class="n">a_out</span><span class="o">=</span><span class="n">smai</span> <span class="o">*</span> <span class="n">annulus_ratio</span><span class="p">,</span>
                                            <span class="n">b_in</span><span class="o">=</span><span class="n">smii</span><span class="p">,</span> <span class="n">b_out</span><span class="o">=</span><span class="n">smii</span> <span class="o">*</span> <span class="n">annulus_ratio</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">thetai</span><span class="p">)</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annulus</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">ann_fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ann_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annulus</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>

            <span class="n">bkg_area_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann_areas</span><span class="p">)</span>
            <span class="n">annulus_bkg_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann_fluxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">bkg_area_ratio</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUX_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span> <span class="o">-</span> <span class="n">annulus_bkg_flux</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUX_EANNULUS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annulus_bkg_flux</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MAG_ELIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUX_ELIP&#39;</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MAG_EANNULUS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;FLUX_EANNULUS&#39;</span><span class="p">])</span>
        
        <span class="n">cat_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.ellip.cat&#39;</span><span class="p">)</span>
        <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">cat_path</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">results</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_objects</span><span class="p">(</span><span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span> 
                                    <span class="n">objects</span><span class="o">=</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                    <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="p">,</span>
                                    <span class="n">show</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">target_catalog</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_visualize_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                           <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                           <span class="n">objects</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                           <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                           <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">data</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Step 1: Compute mean position of all sources</span>
        <span class="n">mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">])</span>
        <span class="n">mean_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">])</span>

        <span class="c1"># Step 2: Find the object closest to that mean position</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">mean_x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">mean_y</span>
        <span class="n">dist2</span> <span class="o">=</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">closest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span>

        <span class="c1"># Use this object to center the zoom-in box</span>
        <span class="n">center_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">closest_idx</span><span class="p">][</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">])</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">closest_idx</span><span class="p">][</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">])</span>

        <span class="c1"># Step 3: Define cropped region centered on that object</span>
        <span class="n">half_box</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">center_x</span> <span class="o">-</span> <span class="n">half_box</span><span class="p">))</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">half_box</span><span class="p">))</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">-</span> <span class="n">half_box</span><span class="p">))</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">half_box</span><span class="p">))</span>

        <span class="n">cropped_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>

        <span class="c1"># Step 4: Plot setup</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="c1"># --- Full image view ---</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">im0</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">m</span> <span class="o">-</span> <span class="n">s</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Full Background-Subtracted Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

        <span class="c1"># Draw red rectangle showing zoomed region</span>
        <span class="n">zoom_box</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">zoom_box</span><span class="p">)</span>

        <span class="c1"># --- Zoomed-in region ---</span>
        <span class="n">m_crop</span><span class="p">,</span> <span class="n">s_crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cropped_data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cropped_data</span><span class="p">)</span>
        <span class="n">im1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_data</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">m_crop</span> <span class="o">-</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">m_crop</span> <span class="o">+</span> <span class="n">s_crop</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zoomed Region Centered on Closest to Mean Position&quot;</span><span class="p">)</span>

        <span class="c1"># Step 5: Draw apertures for all sources in zoomed region</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span> <span class="ow">and</span> <span class="n">y_min</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">:</span>
                <span class="n">dx_local</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_min</span>
                <span class="n">dy_local</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_min</span>

                <span class="k">if</span> <span class="s1">&#39;A_IMAGE&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">colnames</span> <span class="ow">and</span> <span class="s1">&#39;B_IMAGE&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;A_IMAGE&#39;</span><span class="p">])</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;B_IMAGE&#39;</span><span class="p">])</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;THETA_IMAGE&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;THETA_IMAGE&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">colnames</span> <span class="k">else</span> <span class="mf">0.0</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">((</span><span class="n">dx_local</span><span class="p">,</span> <span class="n">dy_local</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
                                    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">dx_local</span><span class="p">,</span> <span class="n">dy_local</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    

<span class="c1"># %%</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataBrowser</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DataBrowser</span><span class="p">(</span><span class="s1">&#39;scidata&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">observatory</span> <span class="o">=</span> <span class="s1">&#39;RASA36&#39;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">objname</span> <span class="o">=</span> <span class="s1">&#39;NGC1566&#39;</span>
    <span class="n">target_imgset</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;*com.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;science&#39;</span><span class="p">)</span>
    <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imgset</span><span class="o">.</span><span class="n">target_images</span>
    <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">bkgrms</span>
    <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">bkgmap</span>
    <span class="n">target_mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sex_params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">detection_sigma</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">]</span>  <span class="c1">#</span>
    <span class="n">kron_factor</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span>
    <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">visualize</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hyeonho Choi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>