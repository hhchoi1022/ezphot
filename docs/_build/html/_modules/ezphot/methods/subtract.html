

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ezphot.methods.subtract &mdash; ezphot 0.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=bbaf98b3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ezphot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imageobjects.html">Imageobjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dataobjects.html">DataObjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ezphot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ezphot.methods.subtract</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ezphot.methods.subtract</h1><div class="highlight"><pre>
<span></span>
<span class="c1">#%%</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">MinMaxInterval</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.imageobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.imageobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background</span><span class="p">,</span> <span class="n">Errormap</span><span class="p">,</span> <span class="n">Mask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">PhotometricCalibration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">AperturePhotometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaskGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.dataobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Catalog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageQuerier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reproject</span>
<span class="c1">#%%</span>
<div class="viewcode-block" id="Subtract">
<a class="viewcode-back" href="../../../api/subtract.html#ezphot.methods.subtract.Subtract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Subtract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subtract a reference image from a target image.</span>
<span class="sd">    </span>
<span class="sd">    This class will prepare the subtracted region by trimming both images to the overlapping region.</span>
<span class="sd">    Then, run HOTPANTS subtraction to find transients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Subtract class.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">BackgroundGenerator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span> <span class="o">=</span> <span class="n">Stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperphot</span> <span class="o">=</span> <span class="n">AperturePhotometry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span> <span class="o">=</span> <span class="n">PhotometricCalibration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masking</span> <span class="o">=</span> <span class="n">MaskGenerator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">Reproject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagequerier</span> <span class="o">=</span> <span class="n">ImageQuerier</span><span class="p">()</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">target_img</span><span class="p">:</span> <span class="n">ScienceImage</span><span class="p">,</span>
                 <span class="n">reference_img</span><span class="p">:</span> <span class="n">ReferenceImage</span><span class="p">,</span>
                 <span class="n">target_ivpmask</span><span class="p">:</span> <span class="n">Mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">reference_ivpmask</span><span class="p">:</span> <span class="n">Mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">target_stamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">id_</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">convim</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">normim</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span>
                 <span class="n">nrx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">nry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">iu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                 <span class="n">il</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">tu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                 <span class="n">tl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">hotpants_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subtract the target_img from reference-img. </span>
<span class="sd">        It will prepare the subtracted region by trimming both images to the overlapping region.</span>
<span class="sd">        Then, run HOTPANTS subtraction.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage</span>
<span class="sd">            The target image to subtract from.</span>
<span class="sd">        reference_img : ReferenceImage</span>
<span class="sd">            The reference image to subtract.</span>
<span class="sd">        target_ivpmask : Mask, optional</span>
<span class="sd">            The mask for the target image.</span>
<span class="sd">        reference_ivpmask : Mask, optional</span>
<span class="sd">            The mask for the reference image.</span>
<span class="sd">        target_stamp : str, optional</span>
<span class="sd">            The stamp for the target image.</span>
<span class="sd">        id_ : int, optional</span>
<span class="sd">            The id for the target image.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the subtracted image.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the subtracted image.</span>
<span class="sd">        convim : str, optional</span>
<span class="sd">            The convolution image type. [&#39;t&#39;, &#39;i&#39;]</span>
<span class="sd">        normim : str, optional</span>
<span class="sd">            The normalization image type. [&#39;t&#39;, &#39;i&#39;]</span>
<span class="sd">        nrx : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        nry : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        iu : float, optional</span>
<span class="sd">            The upper limit for the input image.</span>
<span class="sd">        il : float, optional</span>
<span class="sd">            The lower limit for the input image.</span>
<span class="sd">        tu : float, optional</span>
<span class="sd">            The upper limit for the template image.</span>
<span class="sd">        tl : float, optional</span>
<span class="sd">            The lower limit for the template image.</span>
<span class="sd">        **hotpants_params : dict, optional</span>
<span class="sd">            Additional keyword arguments for the HOTPANTS subtraction.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (subframe_target_img, subframe_reference_img, subframe_subtract_img, fullframe_subtract_mask, subframe_subtract_mask) : Tuple[ScienceImage, ReferenceImage, ScienceImage, Mask, Mask]</span>
<span class="sd">            The subtracted image, the reference image, the subtracted image, the full frame mask, and the subframe mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the target_stamp </span>
        <span class="k">if</span> <span class="n">target_stamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using target stamp from </span><span class="si">{</span><span class="n">target_stamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                        
        <span class="n">target_seeing</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span>
        <span class="n">reference_seeing</span> <span class="o">=</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">seeing</span>
        <span class="k">if</span> <span class="n">convim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_seeing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reference_seeing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Warning: One of the images does not have a valid seeing value. Using &#39;t&#39; for convolution.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">convim</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
            <span class="k">elif</span> <span class="n">target_seeing</span> <span class="o">&gt;</span> <span class="n">reference_seeing</span><span class="p">:</span>
                <span class="n">convim</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">convim</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
        
        <span class="c1"># Trim images</span>
        <span class="n">subframe_target_img</span><span class="p">,</span> <span class="n">subframe_reference_img</span><span class="p">,</span> <span class="n">subframe_target_ivpmask</span><span class="p">,</span> <span class="n">subframe_reference_ivpmask</span><span class="p">,</span> <span class="n">fullframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_target_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_subtract_region</span><span class="p">(</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span>
            <span class="n">reference_img</span> <span class="o">=</span> <span class="n">reference_img</span><span class="p">,</span>
            <span class="n">target_ivpmask</span> <span class="o">=</span> <span class="n">target_ivpmask</span><span class="p">,</span>
            <span class="n">reference_ivpmask</span> <span class="o">=</span> <span class="n">reference_ivpmask</span><span class="p">,</span>
            <span class="n">target_stamp</span> <span class="o">=</span> <span class="n">target_stamp</span><span class="p">,</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">id_</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span>
        <span class="p">)</span>
            
        <span class="c1"># Run HOTPANTS subtraction</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">run_hotpants</span><span class="p">(</span>
            <span class="n">target_path</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">,</span>
            <span class="n">reference_path</span> <span class="o">=</span> <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">,</span>
            <span class="n">convolve_path</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">convolvepath</span><span class="p">,</span>
            <span class="n">target_mask</span> <span class="o">=</span> <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">,</span>
            <span class="n">reference_mask</span> <span class="o">=</span> <span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">,</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="n">subframe_target_stamp</span><span class="p">,</span>
            <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">subtractpath</span><span class="p">,</span>
            <span class="n">convim</span> <span class="o">=</span> <span class="n">convim</span><span class="p">,</span>
            <span class="n">normim</span> <span class="o">=</span> <span class="n">normim</span><span class="p">,</span>
            <span class="n">nrx</span> <span class="o">=</span> <span class="n">nrx</span><span class="p">,</span>
            <span class="n">nry</span> <span class="o">=</span> <span class="n">nry</span><span class="p">,</span>
            <span class="n">iu</span> <span class="o">=</span> <span class="n">iu</span><span class="p">,</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span>
            <span class="n">tu</span> <span class="o">=</span> <span class="n">tu</span><span class="p">,</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="n">tl</span><span class="p">,</span>
            <span class="o">**</span><span class="n">hotpants_params</span>
        <span class="p">)</span>            
        
        <span class="n">subframe_convolve_img</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">subframe_target_img</span><span class="p">)(</span><span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">convolvepath</span><span class="p">,</span> <span class="n">telinfo</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1">#subframe_convolve_img.remove()</span>
        <span class="n">subframe_subtract_img</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_img</span><span class="p">)(</span><span class="n">result</span><span class="p">,</span> <span class="n">telinfo</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">subframe_subtract_mask</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">invalidmaskpath</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">subframe_subtract_mask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">data</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">subframe_target_img</span><span class="p">,</span> <span class="n">subframe_reference_img</span><span class="p">,</span> <span class="n">subframe_subtract_img</span><span class="p">,</span> <span class="n">fullframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_subtract_mask</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">find_transients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">target_img</span><span class="p">:</span> <span class="n">ScienceImage</span><span class="p">,</span>
                        <span class="n">reference_imglist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReferenceImage</span><span class="p">],</span>
                        <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        
                        <span class="c1"># Photometry configuration</span>
                        <span class="n">detection_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">aperture_diameter_arcsec</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                        <span class="n">aperture_diameter_seeing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">],</span>
                        <span class="n">kron_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">catalog_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GAIAXP&#39;</span><span class="p">,</span>
                        
                        <span class="n">target_transient_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">reject_variable_sources</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">negative_detection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">reverse_subtraction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        
                        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_transient_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">save_candidate_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">show_transient_numbers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">show_candidate_numbers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">tu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">tl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">iu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">il</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">nrx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">nry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">nsx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="n">nsy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="n">ko</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">bgo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">hotpants_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find transients in the subtracted image.</span>
<span class="sd">        </span>
<span class="sd">        This function will prepare the subtracted image by trimming the target image to the overlapping region.</span>
<span class="sd">        Then, run HOTPANTS subtraction to find transients.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage</span>
<span class="sd">            The target image to find transients in.</span>
<span class="sd">        reference_imglist : List[ReferenceImage]</span>
<span class="sd">            The list of reference images to find transients in.</span>
<span class="sd">        target_bkg : Background, optional</span>
<span class="sd">            The background for the target image.</span>
<span class="sd">        detection_sigma : float, optional</span>
<span class="sd">            The detection sigma for the target image.</span>
<span class="sd">        aperture_diameter_arcsec : List[float], optional</span>
<span class="sd">            The aperture diameter in arcseconds for the target image.</span>
<span class="sd">        aperture_diameter_seeing : List[float], optional</span>
<span class="sd">            The aperture diameter in seeing for the target image.</span>
<span class="sd">        kron_factor : float, optional</span>
<span class="sd">            The Kron factor for the target image.</span>
<span class="sd">        target_transient_number : int, optional</span>
<span class="sd">            The number of transients to find in the target image.</span>
<span class="sd">        reject_variable_sources : bool, optional</span>
<span class="sd">            Whether to reject variable sources.</span>
<span class="sd">        negative_detection : bool, optional</span>
<span class="sd">            Whether to detect negative sources.</span>
<span class="sd">        reverse_subtraction : bool, optional</span>
<span class="sd">            Whether to reverse the subtraction.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the subtracted image.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the subtracted image.</span>
<span class="sd">        save_transient_figure : bool, optional</span>
<span class="sd">            Whether to save the transient figure.</span>
<span class="sd">        save_candidate_figure : bool, optional</span>
<span class="sd">            Whether to save the candidate figure.</span>
<span class="sd">        show_transient_numbers : int, optional</span>
<span class="sd">            The number of transients to show in the transient figure.</span>
<span class="sd">        show_candidate_numbers : int, optional</span>
<span class="sd">            The number of candidates to show in the candidate figure.</span>
<span class="sd">        tu : float, optional</span>
<span class="sd">            The upper limit for the template image.</span>
<span class="sd">        tl : float, optional</span>
<span class="sd">            The lower limit for the input image.</span>
<span class="sd">        iu : float, optional</span>
<span class="sd">            The upper limit for the input image.</span>
<span class="sd">        il : float, optional</span>
<span class="sd">            The lower limit for the input image.</span>
<span class="sd">        nrx : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        nry : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        nsx : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        nsy : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        ko : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        bgo : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        r : int, optional</span>
<span class="sd">            The number of regions for subtraction.</span>
<span class="sd">        **hotpants_params : dict, optional</span>
<span class="sd">            Additional keyword arguments for the HOTPANTS subtraction.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (transient_catalogs, candidate_catalogs) : Tuple[List[Table], List[Table]]</span>
<span class="sd">            The list of transient catalogs and the list of candidate catalogs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare reprojected target_img</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span>
                <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_bkg</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_img_sub</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Free memory</span>
        <span class="n">target_img</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">target_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_bkg</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;================== Target Image Preparation ==================&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">center_target</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">center</span>
        <span class="n">reprojected_target_img</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reprojected_target_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img_sub</span><span class="p">,</span>
            <span class="n">swarp_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">resample_type</span> <span class="o">=</span> <span class="s1">&#39;LANCZOS3&#39;</span><span class="p">,</span>
            <span class="n">center_ra</span> <span class="o">=</span> <span class="n">center_target</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span>
            <span class="n">center_dec</span> <span class="o">=</span> <span class="n">center_target</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span>
            <span class="n">x_size</span> <span class="o">=</span> <span class="n">target_img_sub</span><span class="o">.</span><span class="n">naxis1</span><span class="p">,</span>
            <span class="n">y_size</span> <span class="o">=</span> <span class="n">target_img_sub</span><span class="o">.</span><span class="n">naxis2</span><span class="p">,</span>
            <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">target_img_sub</span><span class="o">.</span><span class="n">pixelscale</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
            <span class="n">return_ivpmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># Free memory</span>
        <span class="n">target_img_sub</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Calculate typical detection criteria for transients</span>
        <span class="n">reprojected_target_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperphot</span><span class="o">.</span><span class="n">sex_photometry</span><span class="p">(</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="p">,</span>
            <span class="n">target_bkg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background for subtraction</span>
            <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background RMS for subtraction</span>
            <span class="n">target_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">detection_sigma</span> <span class="o">=</span> <span class="n">detection_sigma</span><span class="p">,</span>
            <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span><span class="p">,</span>
            <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="n">aperture_diameter_seeing</span><span class="p">,</span>
            <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
            <span class="n">kron_factor</span> <span class="o">=</span> <span class="n">kron_factor</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
            <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="n">reprojected_target_img</span><span class="p">,</span> <span class="n">reprojected_target_catalog</span><span class="p">,</span> <span class="n">reprojected_target_ref_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span><span class="o">.</span><span class="n">photometric_calibration</span><span class="p">(</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="p">,</span>
            <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">reprojected_target_catalog</span><span class="p">,</span>
            <span class="n">catalog_type</span> <span class="o">=</span> <span class="n">catalog_type</span><span class="p">,</span>
            <span class="n">max_distance_second</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="n">calculate_color_terms</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
            <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save_starcat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save_refcat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="p">)</span>
        
        <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">skip_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.refcat&#39;</span><span class="p">,</span> <span class="s1">&#39;.invalidmask&#39;</span><span class="p">])</span>
        
        <span class="n">transient_criteria</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;SATURATE&#39;</span> <span class="ow">in</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">saturation_level_target</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SATURATE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saturation_level_target</span> <span class="o">=</span> <span class="mi">60000</span>
        <span class="n">reprojected_target_ref_catalog_data</span> <span class="o">=</span> <span class="n">reprojected_target_ref_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;classstar_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">reprojected_target_ref_catalog_data</span><span class="p">[</span><span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">]))</span>
        <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;elongation_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">reprojected_target_ref_catalog_data</span><span class="p">[</span><span class="s1">&#39;ELONGATION&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">iu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation_level_target</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iu</span>
        <span class="k">if</span> <span class="n">il</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYVAL</span> <span class="o">-</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span> <span class="k">if</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYVAL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">10000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">il</span>
        <span class="n">is_criteria_determined</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">reprojected_target_stamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reprojected_target_ref_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">reprojected_target_stamp</span> <span class="o">=</span> <span class="n">reprojected_target_ref_catalog</span><span class="o">.</span><span class="n">to_stamp</span><span class="p">(</span><span class="n">reprojected_target_img</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;=============== Target Image Preparation END ===============&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=============== Subtraction with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reference_imglist</span><span class="p">)</span><span class="si">}</span><span class="s2"> images ===============&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">final_subtraction_mask</span> <span class="o">=</span> <span class="n">Mask</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">submaskpath</span><span class="p">,</span> <span class="n">masktype</span> <span class="o">=</span> <span class="s1">&#39;subtraction&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">final_subtraction_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        <span class="n">all_catalogs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">transient_catalogs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">candidate_catalogs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reference_img</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">reference_imglist</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">reference_imglist</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Subtraction Progress&quot;</span><span class="p">):</span>
            <span class="n">reference_img_temp</span> <span class="o">=</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">reference_img_temp</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            <span class="n">reference_img_temp</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            
            <span class="c1"># Step 2: Reproject reference images to reprojected_target_img</span>
            <span class="n">reprojected_reference_img</span><span class="p">,</span> <span class="n">reprojected_reference_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reproject_to_target</span><span class="p">(</span>
                <span class="n">reference_img</span> <span class="o">=</span> <span class="n">reference_img_temp</span><span class="p">,</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="p">)</span>
            
            <span class="n">reference_img_temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">reference_img_temp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">skip_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
            <span class="c1">#reference_img.clear()</span>
            <span class="c1">#reprojected_reference_img.remove(remove_main = False, remove_connected_files = True, skip_exts = [&#39;.invalidmask&#39;])</span>
            
            <span class="c1"># Step 1: If reference_img.seeing is None, update seeing</span>
            <span class="n">reference_catalog</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">reference_ref_catalog</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">reprojected_reference_stamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">seeing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reject_variable_sources</span><span class="p">:</span>
                <span class="c1"># If reference catalog is not available, run SExtractor</span>
                <span class="n">reference_catalog</span> <span class="o">=</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">catalog</span>
                <span class="k">if</span> <span class="n">reference_catalog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">reference_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperphot</span><span class="o">.</span><span class="n">sex_photometry</span><span class="p">(</span>
                        <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_reference_img</span><span class="p">,</span>
                        <span class="n">target_bkg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background for subtraction</span>
                        <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background RMS for subtraction</span>
                        <span class="n">target_mask</span> <span class="o">=</span> <span class="n">reprojected_reference_ivpmask</span><span class="p">,</span>
                        <span class="n">detection_sigma</span> <span class="o">=</span> <span class="n">detection_sigma</span><span class="p">,</span>
                        <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span><span class="p">,</span>
                        <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="n">aperture_diameter_seeing</span><span class="p">,</span>
                        <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                        <span class="n">kron_factor</span> <span class="o">=</span> <span class="n">kron_factor</span><span class="p">,</span>
                        <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                        <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                        <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reprojected_reference_img</span><span class="p">,</span> <span class="n">reprojected_reference_catalog</span><span class="p">,</span> <span class="n">reprojected_reference_ref_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span><span class="o">.</span><span class="n">photometric_calibration</span><span class="p">(</span>
                        <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_reference_img</span><span class="p">,</span>
                        <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">reference_catalog</span><span class="p">,</span>
                        <span class="n">catalog_type</span> <span class="o">=</span> <span class="n">catalog_type</span><span class="p">,</span>
                        <span class="n">max_distance_second</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                        <span class="n">calculate_color_terms</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">calculate_mag_terms</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                        <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                        <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_starcat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_refcat</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="p">)</span>         
                    <span class="c1">#reprojected_reference_stamp = reprojected_reference_ref_catalog.to_stamp(reprojected_reference_img)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">peeing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">reference_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">])</span>
                    <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SEEING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peeing</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reprojected_reference_ivpmask</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Reference image and target image are not overlapping enough for subtraction.&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">failed_reference_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Step 3. Update transient criteria based on the seeing of reprojected images</span>
            <span class="n">target_seeing</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">seeing</span>
            <span class="n">reference_seeing</span> <span class="o">=</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">seeing</span>
            <span class="c1"># If target_seeing larger, convolve to target_img, thus the subtracted image&#39;s seeing should be target_seeing </span>
            <span class="k">if</span> <span class="n">target_seeing</span> <span class="o">&gt;=</span> <span class="n">reference_seeing</span><span class="p">:</span>
                <span class="n">subtract_seeing</span> <span class="o">=</span> <span class="n">target_seeing</span>
                <span class="n">sigma_match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_seeing</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">reference_seeing</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subtract_seeing</span> <span class="o">=</span> <span class="n">reference_seeing</span>
                <span class="n">sigma_match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">reference_seeing</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">target_seeing</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">convolved_source_minarea</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">subtract_seeing</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_match</span> <span class="o">/</span> <span class="mf">2.355</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reprojected_target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
                
            <span class="n">saturation_level_reference</span> <span class="o">=</span> <span class="mi">60000</span>
            <span class="k">if</span> <span class="s1">&#39;SATURATE&#39;</span> <span class="ow">in</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">saturation_level_reference</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SATURATE&#39;</span><span class="p">],</span><span class="mi">60000</span><span class="p">)</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;seeing_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="n">subtract_seeing</span>
            <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;seeing_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">subtract_seeing</span><span class="p">)</span>    
            <span class="c1"># Set saturation level</span>
            <span class="k">if</span> <span class="n">tu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation_level_reference</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tu</span>
            <span class="k">if</span> <span class="n">tl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYVAL</span> <span class="o">-</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span> <span class="k">if</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYVAL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">10000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>
            
            <span class="c1">#ng = f&quot;3 6 %.2f 4 %.2f 2 %.2f&quot; %(0.5 * sigma_match, sigma_match, 2.0 * sigma_match)</span>
            
            <span class="c1"># Step 4: Subtration</span>
            <span class="n">subframe_target_imglist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">subframe_reference_imglist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">subframe_subtract_imglist</span> <span class="o">=</span> <span class="p">[]</span>
    
            <span class="n">subframe_target_img</span><span class="p">,</span> <span class="n">subframe_reference_img</span><span class="p">,</span> <span class="n">subframe_subtract_img</span><span class="p">,</span> <span class="n">fullframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_subtract_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">reprojected_target_img</span><span class="p">,</span>
                <span class="n">reference_img</span> <span class="o">=</span> <span class="n">reprojected_reference_img</span><span class="p">,</span>
                <span class="n">target_ivpmask</span> <span class="o">=</span> <span class="n">reprojected_target_ivpmask</span><span class="p">,</span>
                <span class="n">reference_ivpmask</span> <span class="o">=</span> <span class="n">reprojected_reference_ivpmask</span><span class="p">,</span>
                <span class="n">target_stamp</span> <span class="o">=</span> <span class="n">reprojected_target_stamp</span><span class="p">,</span>
                <span class="n">id_</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="c1"># HOTPANTS Parameters</span>
                <span class="n">convim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">normim</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span>
                <span class="n">nrx</span> <span class="o">=</span> <span class="n">nrx</span><span class="p">,</span>
                <span class="n">nry</span> <span class="o">=</span> <span class="n">nry</span><span class="p">,</span>
                <span class="n">iu</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_target&#39;</span><span class="p">],</span>
                <span class="n">il</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_target&#39;</span><span class="p">],</span>
                <span class="n">tu</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_upper_reference&#39;</span><span class="p">],</span>
                <span class="n">tl</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;flux_lower_reference&#39;</span><span class="p">],</span>
                <span class="c1"># Other hotpants parameters</span>
                <span class="n">ko</span> <span class="o">=</span> <span class="n">ko</span><span class="p">,</span>
                <span class="n">bgo</span> <span class="o">=</span> <span class="n">bgo</span><span class="p">,</span>
                <span class="n">nsx</span> <span class="o">=</span> <span class="n">nsx</span><span class="p">,</span>
                <span class="n">nsy</span> <span class="o">=</span> <span class="n">nsy</span><span class="p">,</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span>
                <span class="o">**</span><span class="n">hotpants_params</span><span class="p">)</span>
            
            <span class="n">reprojected_reference_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">skip_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.invalidmask&#39;</span><span class="p">])</span>
            <span class="n">final_subtraction_mask</span><span class="o">.</span><span class="n">combine_mask</span><span class="p">(</span><span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
            
            <span class="n">output_name</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span>
            <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;sci_&#39;</span> <span class="o">+</span> <span class="n">output_name</span><span class="p">)</span>
            <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;ref_&#39;</span><span class="o">+</span> <span class="n">output_name</span><span class="p">)</span>

            <span class="c1"># Step 5: Extract sources</span>
            <span class="n">tbl_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperphot</span><span class="o">.</span><span class="n">sex_photometry</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                <span class="n">target_bkg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background for subtraction</span>
                <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background RMS for subtraction</span>
                <span class="n">target_mask</span> <span class="o">=</span> <span class="n">subframe_subtract_ivpmask</span><span class="p">,</span>
                <span class="n">sex_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SEEING_FWHM</span> <span class="o">=</span> <span class="n">subtract_seeing</span><span class="p">,</span> <span class="n">DETECT_MINAREA</span> <span class="o">=</span> <span class="n">convolved_source_minarea</span><span class="p">),</span>
                <span class="n">detection_sigma</span> <span class="o">=</span> <span class="n">detection_sigma</span><span class="p">,</span>
                <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span><span class="p">,</span>
                <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="n">aperture_diameter_seeing</span><span class="p">,</span>  
                <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span><span class="o">.</span><span class="n">apply_zp</span><span class="p">(</span>
                <span class="n">target_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">tbl_first</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="p">)</span>
        
            <span class="c1"># Step 6: Filter the table for significant sources</span>
            <span class="n">all_catalog</span><span class="p">,</span> <span class="n">selected_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_transients</span><span class="p">(</span>
                <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">tbl_first</span><span class="p">,</span>
                <span class="n">snr_lower</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="n">fwhm_lower</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;seeing_lower&#39;</span><span class="p">],</span>
                <span class="n">fwhm_upper</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;seeing_upper&#39;</span><span class="p">],</span>
                <span class="n">flag_upper</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">maskflag_upper</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">class_star_lower</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;classstar_lower&#39;</span><span class="p">],</span>
                <span class="n">elongation_upper</span> <span class="o">=</span> <span class="n">transient_criteria</span><span class="p">[</span><span class="s1">&#39;elongation_upper&#39;</span><span class="p">],</span>
                <span class="n">flux_key</span> <span class="o">=</span> <span class="s1">&#39;FLUX_AUTO&#39;</span><span class="p">,</span>
                <span class="n">fluxerr_key</span> <span class="o">=</span> <span class="s1">&#39;FLUXERR_AUTO&#39;</span><span class="p">,</span>
                <span class="n">fwhm_key</span> <span class="o">=</span> <span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">,</span>
                <span class="n">flag_key</span> <span class="o">=</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">,</span>
                <span class="n">maskflag_key</span> <span class="o">=</span> <span class="s1">&#39;IMAFLAGS_ISO&#39;</span><span class="p">,</span>
                <span class="n">classstar_key</span> <span class="o">=</span> <span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">,</span>
                <span class="n">elongation_key</span> <span class="o">=</span> <span class="s1">&#39;ELONGATION&#39;</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                <span class="n">return_only_transient</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="n">all_tbl</span> <span class="o">=</span> <span class="n">all_catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
            <span class="n">candidate_tbl</span> <span class="o">=</span> <span class="n">selected_catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_main</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remove_connected_files</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">skip_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.invalidmask&#39;</span><span class="p">,</span> <span class="s1">&#39;.transient&#39;</span><span class="p">,</span> <span class="s1">&#39;.candidate&#39;</span><span class="p">,</span> <span class="s1">&#39;.cat&#39;</span><span class="p">])</span>

            <span class="c1"># Step 7: negative image &amp; Photometry</span>
            <span class="k">if</span> <span class="n">negative_detection</span><span class="p">:</span>
                <span class="n">negative_subframe_subtract_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">negative_subframe_subtract_img</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;inv_&#39;</span> <span class="o">+</span> <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">negative_subframe_subtract_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">-</span><span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">data</span>        

                <span class="n">tbl_second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperphot</span><span class="o">.</span><span class="n">sex_photometry</span><span class="p">(</span>
                    <span class="n">target_img</span> <span class="o">=</span> <span class="n">negative_subframe_subtract_img</span><span class="p">,</span>
                    <span class="n">target_bkg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background for subtraction</span>
                    <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># No background RMS for subtraction</span>
                    <span class="n">target_mask</span> <span class="o">=</span> <span class="n">subframe_subtract_ivpmask</span><span class="p">,</span>
                    <span class="n">sex_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SEEING_FWHM</span> <span class="o">=</span> <span class="n">subtract_seeing</span><span class="p">,</span> <span class="n">DETECT_MINAREA</span> <span class="o">=</span> <span class="n">convolved_source_minarea</span><span class="p">),</span>
                    <span class="n">detection_sigma</span> <span class="o">=</span> <span class="n">detection_sigma</span><span class="p">,</span>
                    <span class="n">aperture_diameter_arcsec</span> <span class="o">=</span> <span class="n">aperture_diameter_arcsec</span><span class="p">,</span>
                    <span class="n">aperture_diameter_seeing</span> <span class="o">=</span> <span class="n">aperture_diameter_seeing</span><span class="p">,</span>    
                    <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
                    <span class="n">kron_factor</span> <span class="o">=</span> <span class="n">kron_factor</span><span class="p">,</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Remove</span>
                <span class="n">negative_subframe_subtract_img</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
                <span class="c1"># Only keep the unmatched sources from the first photometry step</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_second</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coord_first</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span>
                                        <span class="n">dec</span><span class="o">=</span><span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span>
                                        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">coord_second</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">tbl_second</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span>
                                            <span class="n">dec</span><span class="o">=</span><span class="n">tbl_second</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span>
                                            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">matched_first</span><span class="p">,</span> <span class="n">matched_second</span><span class="p">,</span> <span class="n">unmatched_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">cross_match</span><span class="p">(</span><span class="n">coord_first</span><span class="p">,</span> <span class="n">coord_second</span><span class="p">,</span> <span class="n">subtract_seeing</span><span class="p">)</span>
                    <span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">unmatched_first</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> transients after negative detection.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;No significant sources found in the second photometry step.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                    <span class="k">pass</span>
                
            <span class="c1"># Match the first photometry results with the reference catalog to reject variable sources</span>
            <span class="n">transient_tbl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">reject_variable_sources</span><span class="p">:</span>
                <span class="n">transient_tbl</span> <span class="o">=</span> <span class="n">candidate_tbl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">transient_tbl</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">all_tbl</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">transientcatalogpath</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coord_first</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span>
                                        <span class="n">dec</span><span class="o">=</span><span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span>
                                        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">coord_second</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">reference_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span>
                                            <span class="n">dec</span><span class="o">=</span><span class="n">reference_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span>
                                            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">matched_first</span><span class="p">,</span> <span class="n">matched_second</span><span class="p">,</span> <span class="n">unmatched_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">cross_match</span><span class="p">(</span><span class="n">coord_first</span><span class="p">,</span> <span class="n">coord_second</span><span class="p">,</span> <span class="n">subtract_seeing</span><span class="p">)</span>
                    <span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">unmatched_first</span><span class="p">]</span>
                
            <span class="c1"># # Step 8: reverse subtraction (reference_img - target_img)</span>
            <span class="c1"># if reverse_subtraction:</span>
            <span class="c1">#     _, _, reverse_subframe_subtract_img, _, reverse_subframe_subtract_ivpmask = self.subtract(</span>
            <span class="c1">#         target_img = reprojected_reference_img,</span>
            <span class="c1">#         reference_img = reprojected_target_img,</span>
            <span class="c1">#         target_ivpmask = reprojected_reference_ivpmask,</span>
            <span class="c1">#         reference_ivpmask = reprojected_target_ivpmask,</span>
            <span class="c1">#         target_stamp = reprojected_target_stamp,</span>
            <span class="c1">#         id_ = i,</span>
            <span class="c1">#         save = save,</span>
            <span class="c1">#         verbose = verbose,</span>
            <span class="c1">#         visualize = visualize,</span>
            <span class="c1">#         nrx = 2,</span>
            <span class="c1">#         nry = 2,</span>
            <span class="c1">#         ko = 3,</span>
            <span class="c1">#         bgo = 3,</span>
            <span class="c1">#         nsx = 10,</span>
            <span class="c1">#         nsy = 10,</span>
            <span class="c1">#         r = 10,</span>
            <span class="c1">#         #ng = ng,</span>
            <span class="c1">#     )</span>
            <span class="c1">#     subtract_seeing = max(target_seeing, reference_seeing)</span>
            <span class="c1">#     tbl_third = self.aperphot.sex_photometry(</span>
            <span class="c1">#         target_img = reverse_subframe_subtract_img,</span>
            <span class="c1">#         target_bkg = None,  # No background for subtraction</span>
            <span class="c1">#         target_bkgrms = None,  # No background RMS for subtraction</span>
            <span class="c1">#         target_mask = reverse_subframe_subtract_ivpmask,</span>
            <span class="c1">#         sex_params = dict(SEEING_FWHM = subtract_seeing, BACK_TYPE = &#39;MANUAL&#39;),</span>
            <span class="c1">#         detection_sigma = detection_sigma,</span>
            <span class="c1">#         aperture_diameter_arcsec = [6,9,12],</span>
            <span class="c1">#         saturation_level = 60000,</span>
            <span class="c1">#         save = save,</span>
            <span class="c1">#         verbose = verbose,</span>
            <span class="c1">#         visualize = visualize,</span>
            <span class="c1">#         save_fig = False</span>
            <span class="c1">#     )</span>
            
            <span class="c1">#     # Step 6: Filter the table for significant sources</span>
            <span class="c1">#     selected_tbl_third = self.select_transients(</span>
            <span class="c1">#         target_catalog = tbl_third,</span>
            <span class="c1">#         snr_lower = 3.0,</span>
            <span class="c1">#         fwhm_lower = transient_criteria[&#39;seeing_lower&#39;],</span>
            <span class="c1">#         fwhm_upper = transient_criteria[&#39;seeing_upper&#39;],</span>
            <span class="c1">#         flag_upper = 1,</span>
            <span class="c1">#         maskflag_upper = 1,</span>
            <span class="c1">#         class_star_lower = transient_criteria[&#39;classstar_lower&#39;],</span>
            <span class="c1">#         elongation_upper = transient_criteria[&#39;elongation_upper&#39;],</span>
            <span class="c1">#         flux_key = &#39;FLUX_AUTO&#39;,</span>
            <span class="c1">#         fluxerr_key = &#39;FLUXERR_AUTO&#39;,</span>
            <span class="c1">#         fwhm_key = &#39;FWHM_WORLD&#39;,</span>
            <span class="c1">#         flag_key = &#39;FLAGS&#39;,</span>
            <span class="c1">#         maskflag_key = &#39;IMAFLAGS_ISO&#39;,</span>
            <span class="c1">#         classstar_key = &#39;CLASS_STAR&#39;,</span>
            <span class="c1">#         elongation_key = &#39;ELONGATION&#39;,</span>
            <span class="c1">#         verbose = verbose,</span>
            <span class="c1">#         save = save,</span>
            <span class="c1">#         return_only_transient = True</span>
            <span class="c1">#     )</span>

            <span class="c1">#     # Remove </span>
            <span class="c1">#     reverse_subframe_subtract_img.remove()</span>
            <span class="c1">#     reverse_subframe_subtract_ivpmask.remove()</span>
                
            <span class="c1">#     # Match the first and third photometry results</span>
            <span class="c1">#     if len(selected_tbl_third.data) &gt; 0:</span>
            <span class="c1">#         coord_first = SkyCoord(ra=selected_tbl_first.data[&#39;X_WORLD&#39;],</span>
            <span class="c1">#                             dec=selected_tbl_first.data[&#39;Y_WORLD&#39;],</span>
            <span class="c1">#                             unit = &#39;deg&#39;)</span>
            <span class="c1">#         coord_third = SkyCoord(ra=selected_tbl_third.data[&#39;X_WORLD&#39;],</span>
            <span class="c1">#                                 dec=selected_tbl_third.data[&#39;Y_WORLD&#39;],</span>
            <span class="c1">#                                 unit = &#39;deg&#39;)</span>
            <span class="c1">#         matched_first, matched_third, unmatched_first = self.helper.cross_match(coord_first, coord_third, seeing_upper_criteria * 2)</span>
            <span class="c1">#         transient_tbl.data = transient_tbl.data[unmatched_first]</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         self.print(&quot;No significant sources found in the third photometry step.&quot;, verbose)</span>
            <span class="c1">#         pass</span>
            
            <span class="c1">#     if len(transient_tbl.data) &lt;= target_transient_number:</span>
            <span class="c1">#         transient_tbl = self.photcal.apply_zp(</span>
            <span class="c1">#             target_img = subframe_subtract_img,</span>
            <span class="c1">#             target_catalog = transient_tbl,</span>
            <span class="c1">#             save = True</span>
            <span class="c1">#         )</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">candidate_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span><span class="o">.</span><span class="n">apply_zp</span><span class="p">(</span>
                    <span class="n">target_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                    <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">candidate_tbl</span><span class="p">,</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="p">)</span>   
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">transient_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photcal</span><span class="o">.</span><span class="n">apply_zp</span><span class="p">(</span>
                    <span class="n">target_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                    <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">transient_tbl</span><span class="p">,</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">save_transient_figure</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">transient_tbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">all_transients</span> <span class="o">=</span> <span class="n">transient_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">show_transient_numbers</span><span class="p">]</span>
                        <span class="n">ra</span> <span class="o">=</span> <span class="n">all_transients</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">]</span>
                        <span class="n">dec</span> <span class="o">=</span> <span class="n">all_transients</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">all_transients</span><span class="p">[</span><span class="s1">&#39;NUMBER&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">show_transient_positions</span><span class="p">(</span>
                            <span class="n">science_img</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="p">,</span>
                            <span class="n">reference_img</span> <span class="o">=</span> <span class="n">subframe_reference_img</span><span class="p">,</span>
                            <span class="n">subtracted_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                            <span class="n">x_list</span> <span class="o">=</span> <span class="n">ra</span><span class="p">,</span>
                            <span class="n">y_list</span> <span class="o">=</span> <span class="n">dec</span><span class="p">,</span>
                            <span class="n">idx_list</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span>
                            <span class="n">coord_type</span> <span class="o">=</span> <span class="s1">&#39;coord&#39;</span><span class="p">,</span>
                            <span class="n">zoom_radius_pixel</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                            <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                            <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;zscale&#39;</span><span class="p">,</span>
                            <span class="n">subtitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Science&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Subtracted&#39;</span><span class="p">],</span>
                            <span class="n">transient_type</span> <span class="o">=</span> <span class="s1">&#39;transient&#39;</span><span class="p">,</span>
                            <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                            <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">save_candidate_figure</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">all_candidates</span> <span class="o">=</span> <span class="n">candidate_tbl</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">show_candidate_numbers</span><span class="p">]</span>
                    <span class="n">ra</span> <span class="o">=</span> <span class="n">all_candidates</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">]</span>
                    <span class="n">dec</span> <span class="o">=</span> <span class="n">all_candidates</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">all_candidates</span><span class="p">[</span><span class="s1">&#39;NUMBER&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">show_transient_positions</span><span class="p">(</span>
                        <span class="n">science_img</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="p">,</span>
                        <span class="n">reference_img</span> <span class="o">=</span> <span class="n">subframe_reference_img</span><span class="p">,</span>
                        <span class="n">subtracted_img</span> <span class="o">=</span> <span class="n">subframe_subtract_img</span><span class="p">,</span>
                        <span class="n">x_list</span> <span class="o">=</span> <span class="n">ra</span><span class="p">,</span>
                        <span class="n">y_list</span> <span class="o">=</span> <span class="n">dec</span><span class="p">,</span>
                        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span>
                        <span class="n">coord_type</span> <span class="o">=</span> <span class="s1">&#39;coord&#39;</span><span class="p">,</span>
                        <span class="n">zoom_radius_pixel</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                        <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;zscale&#39;</span><span class="p">,</span>
                        <span class="n">subtitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Science&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Subtracted&#39;</span><span class="p">],</span>
                        <span class="n">transient_type</span> <span class="o">=</span> <span class="s1">&#39;candidate&#39;</span><span class="p">,</span>
                        <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                        <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span>
                        <span class="p">)</span>
                            
            <span class="n">final_subtraction_mask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">all_catalogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_tbl</span><span class="p">)</span>
            <span class="n">candidate_catalogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate_tbl</span><span class="p">)</span>
            <span class="n">transient_catalogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transient_tbl</span><span class="p">)</span>
            <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">subframe_subtract_img</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">subframe_target_imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subframe_target_img</span><span class="p">)</span>
            <span class="n">subframe_reference_imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subframe_reference_img</span><span class="p">)</span>
            <span class="n">subframe_subtract_imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subframe_subtract_img</span><span class="p">)</span>     
        <span class="k">return</span> <span class="n">all_catalogs</span><span class="p">,</span> <span class="n">candidate_catalogs</span><span class="p">,</span> <span class="n">transient_catalogs</span><span class="p">,</span> <span class="n">subframe_target_imglist</span><span class="p">,</span> <span class="n">subframe_reference_imglist</span><span class="p">,</span> <span class="n">subframe_subtract_imglist</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select_transients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                            <span class="n">snr_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                            <span class="n">fwhm_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                            <span class="n">fwhm_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                            <span class="n">flag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">maskflag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">class_star_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                            <span class="n">elongation_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.3</span><span class="p">,</span>
                            <span class="n">flux_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FLUX_AUTO&#39;</span><span class="p">,</span>
                            <span class="n">fluxerr_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FLUXERR_AUTO&#39;</span><span class="p">,</span>
                            <span class="n">fwhm_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">,</span>
                            <span class="n">flag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">,</span>
                            <span class="n">maskflag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NIMAFLAGS_ISO&#39;</span><span class="p">,</span>
                            <span class="n">classstar_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">,</span>
                            <span class="n">elongation_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ELONGATION&#39;</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">return_only_transient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select valid sources from the catalog based on SNR, flags, class star, and elongation.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to select sources from.</span>
<span class="sd">        snr_lower : float, optional</span>
<span class="sd">            The lower limit for the SNR.    </span>
<span class="sd">        fwhm_lower : float, optional</span>
<span class="sd">            The lower limit for the FWHM.</span>
<span class="sd">        fwhm_upper : float, optional</span>
<span class="sd">            The upper limit for the FWHM.</span>
<span class="sd">        flag_upper : int, optional</span>
<span class="sd">            The upper limit for the flags.</span>
<span class="sd">        maskflag_upper : int, optional</span>
<span class="sd">            The upper limit for the mask flags.</span>
<span class="sd">        class_star_lower : float, optional</span>
<span class="sd">            The lower limit for the class star.</span>
<span class="sd">        elongation_upper : float, optional</span>
<span class="sd">            The upper limit for the elongation.</span>
<span class="sd">        flux_key : str, optional</span>
<span class="sd">            The key for the flux.</span>
<span class="sd">        fluxerr_key : str, optional</span>
<span class="sd">            The key for the flux error.</span>
<span class="sd">        fwhm_key : str, optional</span>
<span class="sd">            The key for the FWHM.</span>
<span class="sd">        flag_key : str, optional</span>
<span class="sd">            The key for the flags.</span>
<span class="sd">        maskflag_key : str, optional    </span>
<span class="sd">            The key for the mask flags.</span>
<span class="sd">        classstar_key : str, optional</span>
<span class="sd">            The key for the class star.</span>
<span class="sd">        elongation_key : str, optional</span>
<span class="sd">            The key for the elongation.</span>
<span class="sd">        verbose : bool, optional    </span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">        return_only_transient : bool, optional</span>
<span class="sd">            Whether to return only the transient catalog.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (target_catalog, candidate_catalog) : Tuple[Catalog, Catalog]</span>
<span class="sd">            The target catalog and the candidate catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">flux_key</span><span class="p">]</span> <span class="o">/</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">fluxerr_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fwhm_key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">:</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;SEEING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FWHM_WORLD&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="n">fwhm_key</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span>
        
        <span class="n">snr_lower_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">snr_lower</span><span class="p">)</span>
        <span class="n">fwhm_lower_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fwhm_lower</span><span class="p">)</span>
        <span class="n">fwhm_upper_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fwhm_upper</span><span class="p">)</span>
        <span class="n">flag_upper_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">flag_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">flag_upper</span><span class="p">)</span>
        <span class="n">maskflag_upper_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">maskflag_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">maskflag_upper</span><span class="p">)</span>
        <span class="n">classstar_lower_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">classstar_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">class_star_lower</span><span class="p">)</span>
        <span class="n">elongation_upper_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">elongation_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">elongation_upper</span><span class="p">)</span>
        <span class="n">all_idx</span> <span class="o">=</span> <span class="n">snr_lower_idx</span> <span class="o">&amp;</span> <span class="n">fwhm_lower_idx</span> <span class="o">&amp;</span> <span class="n">fwhm_upper_idx</span> <span class="o">&amp;</span> <span class="n">flag_upper_idx</span> <span class="o">&amp;</span> <span class="n">maskflag_upper_idx</span> <span class="o">&amp;</span> <span class="n">classstar_lower_idx</span> <span class="o">&amp;</span> <span class="n">elongation_upper_idx</span>
        
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snr_lower_idx</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm_lower_idx</span> <span class="o">&amp;</span> <span class="n">fwhm_upper_idx</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_MASK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskflag_upper_idx</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_CLASS_STAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classstar_lower_idx</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_ELONGATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elongation_upper_idx</span>
        <span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;FLAG_Transient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_idx</span>
        <span class="c1"># Update the flags</span>
        
        <span class="n">candidate_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">candidatecatalogpath</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;transient&#39;</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">candidate_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">all_idx</span><span class="p">]</span>
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">target_catalog_data</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering sources based on criteria:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SNR &gt; </span><span class="si">{</span><span class="n">snr_lower</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">snr_lower_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fwhm_key</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">fwhm_lower</span><span class="si">}</span><span class="s2"> and FWHM &lt; </span><span class="si">{</span><span class="n">fwhm_upper</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fwhm_lower_idx</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">fwhm_upper_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag_key</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">flag_upper</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flag_upper_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">maskflag_key</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">maskflag_upper</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">maskflag_upper_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">classstar_key</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">class_star_lower</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">classstar_lower_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elongation_key</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">elongation_upper</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">elongation_upper_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sources with all criteria met: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_idx</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">candidate_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">target_catalog</span><span class="p">,</span> <span class="n">candidate_catalog</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">show_transient_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">science_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
        <span class="n">reference_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
        <span class="n">subtracted_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
        <span class="n">x_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">y_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">idx_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coord_type</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span>
        <span class="n">zoom_radius_pixel</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">downsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;zscale&#39;</span><span class="p">,</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">subtitles</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transient_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;transient&#39;</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the transient positions on the science, reference, and subtracted images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        science_img : ScienceImage</span>
<span class="sd">            The science image.</span>
<span class="sd">        reference_img : ReferenceImage</span>
<span class="sd">            The reference image.</span>
<span class="sd">        subtracted_img : ScienceImage</span>
<span class="sd">            The subtracted image.</span>
<span class="sd">        x_list : list</span>
<span class="sd">            The list of x coordinates.</span>
<span class="sd">        y_list : list</span>
<span class="sd">            The list of y coordinates.</span>
<span class="sd">        idx_list : list, optional</span>
<span class="sd">            The list of indices.</span>
<span class="sd">        coord_type : str, optional</span>
<span class="sd">            The coordinate type. [&#39;coord&#39;, &#39;pixel&#39;]</span>
<span class="sd">        zoom_radius_pixel : int, optional</span>
<span class="sd">            The zoom radius in pixels.</span>
<span class="sd">        downsample : int, optional</span>
<span class="sd">            The downsample factor.</span>
<span class="sd">        cmap : str, optional</span>
<span class="sd">            The colormap.</span>
<span class="sd">        scale : str, optional</span>
<span class="sd">            The scale. [&#39;linear&#39;, &#39;log&#39;, &#39;sqrt&#39;, &#39;arcsinh&#39;]</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            The number of columns.</span>
<span class="sd">        subtitles : list, optional</span>
<span class="sd">            The subtitles for the images.</span>
<span class="sd">        transient_type : str, optional</span>
<span class="sd">            The transient type. [&#39;transient&#39;, &#39;candidate&#39;]</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the figure.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the figure.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : matplotlib.figure.Figure</span>
<span class="sd">            The figure.</span>
<span class="sd">        axes : list</span>
<span class="sd">            The axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x_list and y_list must have the same length.&quot;</span><span class="p">)</span>

        <span class="n">n_transients</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_list</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_transients</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">science_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>  <span class="c1"># image aspect ratio</span>

        <span class="c1"># === Outer GridSpec: Controls spacing between triplets ===</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ncols</span> <span class="o">*</span> <span class="n">aspect</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>
        <span class="n">outer_grid</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>  

        <span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">science_img</span><span class="p">,</span> <span class="n">reference_img</span><span class="p">,</span> <span class="n">subtracted_img</span><span class="p">]</span>
        <span class="n">subtitles</span> <span class="o">=</span> <span class="n">subtitles</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;Science&#39;</span><span class="p">,</span> <span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="s1">&#39;Residual&#39;</span><span class="p">]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="n">ncols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">ncols</span>
            <span class="n">idx_label</span> <span class="o">=</span> <span class="n">idx_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Inner grid: 3 columns per triplet (science, ref, residual)</span>
            <span class="n">inner_grid</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">outer_grid</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span>  <span class="c1"># spacing within triplet</span>
            <span class="p">)</span>

            <span class="n">triplet_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">inner_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">triplet_axes</span><span class="p">)</span>

            <span class="c1"># Plot images</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">subtitle</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">subtitles</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">triplet_axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">img</span><span class="o">.</span><span class="n">show_position</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                    <span class="n">coord_type</span><span class="o">=</span><span class="n">coord_type</span><span class="p">,</span>
                    <span class="n">zoom_radius_pixel</span><span class="o">=</span><span class="n">zoom_radius_pixel</span><span class="p">,</span>
                    <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
                <span class="p">)</span>

                <span class="c1"># Formatting titles</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                <span class="n">ra_str</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># HHMMSS.ss</span>
                <span class="n">dec_str</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alwayssign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ±DDMMSS.s</span>
                <span class="n">objname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">transient_type</span><span class="si">}</span><span class="s1">_J</span><span class="si">{</span><span class="n">ra_str</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">dec_str</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">idx_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">objname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">idx_label</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s1">&#39;</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Science &amp; Residual only</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">subtitle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">subtitle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        
        <span class="c1"># Check scale</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_images</span><span class="p">():</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span> <span class="ow">or</span> <span class="n">vmin</span> <span class="o">&gt;=</span> <span class="n">vmax</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FIX] Invalid clim in axis </span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">, resetting.&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
                    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">vmax</span><span class="p">:</span>  <span class="c1"># flat image</span>
                        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">science_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">science_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">transient_type</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span>
            <span class="p">)</span>
            
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_referenceframe_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                      <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span>
                                      <span class="n">telname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">max_obsdate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Time</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">sort_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">],</span>
                                      <span class="n">overlap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                                      <span class="n">return_groups</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="n">group_overlap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
                                      <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference frame from the target image.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage</span>
<span class="sd">            The target image to get the reference frame from.</span>
<span class="sd">        telname : str, optional</span>
<span class="sd">            The telescope name.</span>
<span class="sd">        max_obsdate : Union[str, float, Time], optional</span>
<span class="sd">            The maximum observation date.</span>
<span class="sd">        sort_key : Union[str, List[str]], optional</span>
<span class="sd">            The sort key.</span>
<span class="sd">        overlap_threshold : float, optional</span>
<span class="sd">            The overlap threshold.</span>
<span class="sd">        return_groups : bool, optional</span>
<span class="sd">            Whether to return the groups.</span>
<span class="sd">        group_overlap_threshold : float, optional</span>
<span class="sd">            The group overlap threshold.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        reference_img : ReferenceImage</span>
<span class="sd">            The reference image.</span>
<span class="sd">        reference_frames : Table</span>
<span class="sd">            The metadata of the reference frames matched the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_obsdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_obsdate</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">obsdate</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No max_obsdate provided, using target image&#39;s obsdate instead (</span><span class="si">{</span><span class="n">max_obsdate</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="c1"># Define fallback attempts</span>
        <span class="n">attempt_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;seeing&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">depth</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;seeing&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">depth</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;seeing&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">seeing</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">target_img</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">reference_frames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">attempt_configs</span><span class="p">:</span>
            <span class="n">reference_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_referenceframe</span><span class="p">(</span>
                <span class="n">observatory</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">observatory</span><span class="p">,</span>
                <span class="n">telkey</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">telkey</span><span class="p">,</span>
                <span class="n">filter_</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                <span class="n">dec</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                <span class="n">ra_fov</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">fovx</span><span class="p">,</span>
                <span class="n">dec_fov</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">fovy</span><span class="p">,</span>
                <span class="n">telname</span> <span class="o">=</span> <span class="n">telname</span><span class="p">,</span>
                <span class="n">max_obsdate</span> <span class="o">=</span> <span class="n">max_obsdate</span><span class="p">,</span>
                <span class="n">seeing_limit</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;seeing&#39;</span><span class="p">],</span>
                <span class="n">depth_limit</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span>
                <span class="n">return_groups</span> <span class="o">=</span> <span class="n">return_groups</span><span class="p">,</span>
                <span class="n">overlap_threshold</span> <span class="o">=</span> <span class="n">overlap_threshold</span><span class="p">,</span>
                <span class="n">group_overlap_threshold</span> <span class="o">=</span> <span class="n">group_overlap_threshold</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_frames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># success</span>
                    
        <span class="k">if</span> <span class="n">reference_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No reference frames found for the target image.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Normalize to list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sort_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">sort_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort_key</span><span class="p">]</span>

        <span class="c1"># Determine sort direction for each key</span>
        <span class="c1"># Use descending (reverse=True) for &#39;depth&#39; and &#39;fraction&#39; by default</span>
        <span class="n">reverse_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;fraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;seeing&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;obsdate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">reverse_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">reverse_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sort_key</span><span class="p">]</span>

        <span class="c1"># Apply sort</span>
        <span class="n">reference_frames</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse_flags</span><span class="p">)</span>

        <span class="n">reference_img</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">reference_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">],</span> <span class="n">telinfo</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reference_img</span><span class="p">,</span> <span class="n">reference_frames</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_referenceframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">observatory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">telkey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">filter_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">ra</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                           <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                           <span class="n">ra_fov</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.35</span><span class="p">,</span>
                           <span class="n">dec_fov</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                           <span class="n">telname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">max_obsdate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">seeing_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">return_groups</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">overlap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">group_overlap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
                           <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference frame from the target image.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        observatory : str</span>
<span class="sd">            The observatory name.</span>
<span class="sd">        telkey : str</span>
<span class="sd">            The telescope key.</span>
<span class="sd">        filter_ : str</span>
<span class="sd">            The filter name.</span>
<span class="sd">        ra : float</span>
<span class="sd">            The right ascension of the target image.</span>
<span class="sd">        dec : float</span>
<span class="sd">            The declination of the target image.</span>
<span class="sd">        ra_fov : float, optional</span>
<span class="sd">            The field of view in right ascension.</span>
<span class="sd">        dec_fov : float, optional</span>
<span class="sd">            The field of view in declination.</span>
<span class="sd">        telname : str, optional</span>
<span class="sd">            The telescope name.</span>
<span class="sd">        max_obsdate : str, optional</span>
<span class="sd">            The maximum observation date.</span>
<span class="sd">        seeing_limit : float, optional</span>
<span class="sd">            The seeing limit.</span>
<span class="sd">        depth_limit : float, optional</span>
<span class="sd">            The depth limit.</span>
<span class="sd">        return_groups : bool, optional</span>
<span class="sd">            Whether to return the groups.</span>
<span class="sd">        overlap_threshold : float, optional</span>
<span class="sd">            The overlap threshold.</span>
<span class="sd">        group_overlap_threshold : float, optional</span>
<span class="sd">            The group overlap threshold.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ref_table : Table</span>
<span class="sd">            The metadata of the reference frames matched the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Load summary tables</span>
        <span class="n">all_referenceframe_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">referenceframe_summary_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;REFDATA_DIR&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="s1">&#39;summary.ascii_fixed_width&#39;</span>

        <span class="k">if</span> <span class="n">referenceframe_summary_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">referenceframe_summary_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fixed_width&#39;</span><span class="p">)</span>
            <span class="n">all_referenceframe_tbl</span> <span class="o">=</span> <span class="n">tbl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_referenceframe_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
                
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_referenceframe_tbl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No calibration frame metadata found.&quot;</span><span class="p">)</span>

        <span class="c1"># Basic filtering</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_referenceframe_tbl</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Apply filters only if not None</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;observatory&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">observatory</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;telkey&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">telkey</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;filtername&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filter_</span>
        <span class="k">if</span> <span class="n">telname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">telname</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;telname&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">max_obsdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obsdate_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">flexible_time_parser</span><span class="p">(</span><span class="n">max_obsdate</span><span class="p">)</span>
            <span class="n">obs_times</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;obsdate&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;isot&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">obs_times</span> <span class="o">&lt;</span> <span class="n">obsdate_target</span>
        <span class="k">if</span> <span class="n">seeing_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;seeing&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seeing_limit</span>
        <span class="k">if</span> <span class="n">depth_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span>
        
        <span class="n">filtered_tbl</span> <span class="o">=</span> <span class="n">all_referenceframe_tbl</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_tbl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No reference frames matched the filtering criteria. [Depth &gt; %.1f, Seeing &lt; %.1f, Obsdate &lt;= %s]&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">depth_limit</span><span class="p">,</span> <span class="n">seeing_limit</span><span class="p">,</span> <span class="n">obsdate_target</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No reference frames matched the filtering criteria.Obsdate &lt;= %s&quot;</span> <span class="o">%</span> <span class="n">max_obsdate</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># Geometry filtering using RA, Dec, FOV</span>
        <span class="n">target_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([</span>
            <span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">ra_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dec</span> <span class="o">-</span> <span class="n">dec_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="n">ra_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dec</span> <span class="o">-</span> <span class="n">dec_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="n">ra_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dec</span> <span class="o">+</span> <span class="n">dec_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">ra_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dec</span> <span class="o">+</span> <span class="n">dec_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">target_area</span> <span class="o">=</span> <span class="n">target_poly</span><span class="o">.</span><span class="n">area</span>

        <span class="c1"># Geometry filtering: keep only intersecting reference frames</span>
        <span class="n">matched_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_tbl</span><span class="p">:</span>
            <span class="n">ref_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">])</span>

            <span class="k">if</span> <span class="n">ref_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">target_poly</span><span class="p">):</span>
                <span class="n">matched_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">inter_area</span> <span class="o">=</span> <span class="n">target_poly</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ref_poly</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">target_area</span> <span class="k">if</span> <span class="n">target_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No reference frames found overlapping RA=</span><span class="si">{</span><span class="n">ra</span><span class="si">}</span><span class="s2">, Dec=</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s2"> with FOV=(</span><span class="si">{</span><span class="n">ra_fov</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dec_fov</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Build final table with overlap fractions</span>
        <span class="n">ref_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">matched_rows</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">filtered_tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">ref_table</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractions</span>
        <span class="n">ref_table</span> <span class="o">=</span> <span class="n">ref_table</span><span class="p">[</span><span class="n">ref_table</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">overlap_threshold</span><span class="p">]</span>

        <span class="c1"># Optional: assign overlap-based group IDs</span>
        <span class="k">if</span> <span class="n">return_groups</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">assign_groups</span><span class="p">(</span><span class="n">ref_table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">overlap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_table</span><span class="p">)</span>
                <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ref_table</span><span class="p">:</span>
                    <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([</span>
                        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_ra&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fov_dec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">])</span>
                    <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

                <span class="n">adjacency</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                        <span class="n">inter_area</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">area</span>
                        <span class="n">min_area</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">min_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inter_area</span> <span class="o">/</span> <span class="n">min_area</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">overlap_threshold</span><span class="p">:</span>
                            <span class="n">adjacency</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">adjacency</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="n">visited</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
                <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
                <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">visited</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">visited</span><span class="p">[</span><span class="n">current</span><span class="p">]:</span>
                                <span class="n">visited</span><span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">group_ids</span><span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
                                <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">adjacency</span><span class="p">[</span><span class="n">current</span><span class="p">])</span>
                        <span class="n">group</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">ref_table</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_ids</span>
                <span class="k">return</span> <span class="n">ref_table</span>

            <span class="n">ref_table</span> <span class="o">=</span> <span class="n">assign_groups</span><span class="p">(</span><span class="n">ref_table</span><span class="p">,</span> <span class="n">overlap_threshold</span><span class="o">=</span><span class="n">group_overlap_threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ref_table</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">query_referenceframe_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                        <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span>
                                        <span class="n">catalog_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SkyMapper/SMSS4/g&#39;</span><span class="p">,</span>
                                        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the reference frame from the target image using HIPS2FITS.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage</span>
<span class="sd">            The target image to query the reference frame from.</span>
<span class="sd">        catalog_key : str, optional </span>
<span class="sd">            The catalog key to query the reference frame from.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        reference_img : ReferenceImage</span>
<span class="sd">            The reference image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imagequerier</span> <span class="o">=</span> <span class="n">ImageQuerier</span><span class="p">(</span><span class="n">catalog_key</span> <span class="o">=</span> <span class="n">catalog_key</span><span class="p">)</span>
        <span class="n">reference_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">objname</span><span class="si">}</span><span class="s1">_ref.fits&#39;</span>
        <span class="n">reference_img</span> <span class="o">=</span> <span class="n">imagequerier</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">naxis1</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">),</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">naxis2</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">),</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
            <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">),</span>
            <span class="n">telinfo</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">reference_path</span><span class="p">,</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">objname</span><span class="p">,</span>
        <span class="p">)</span>      
        <span class="k">return</span> <span class="n">reference_img</span>
         
    <span class="k">def</span><span class="w"> </span><span class="nf">select_reference_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                               <span class="n">target_imglist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ReferenceImage</span><span class="p">]],</span>
                               <span class="n">max_obsdate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Time</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">seeing_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span>
                               <span class="n">depth_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;UL5_5&#39;</span><span class="p">,</span>
                               <span class="n">ellipticity_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ELLIP&#39;</span><span class="p">,</span>
                               <span class="n">obsdate_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span>
                               <span class="n">weight_ellipticity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                               <span class="n">weight_seeing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                               <span class="n">weight_depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                               <span class="n">max_numbers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the reference image from the target image list.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[ScienceImage]</span>
<span class="sd">            The list of target images.</span>
<span class="sd">        max_obsdate : Union[Time, str, float], optional</span>
<span class="sd">            The maximum observation date.</span>
<span class="sd">        seeing_key : str, optional</span>
<span class="sd">            The seeing key.</span>
<span class="sd">        depth_key : str, optional</span>
<span class="sd">            The depth key.</span>
<span class="sd">        ellipticity_key : str, optional</span>
<span class="sd">            The ellipticity key.</span>
<span class="sd">        obsdate_key : str, optional</span>
<span class="sd">            The observation date key.</span>
<span class="sd">        weight_ellipticity : float, optional</span>
<span class="sd">            The weight for the ellipticity.</span>
<span class="sd">        weight_seeing : float, optional</span>
<span class="sd">            The weight for the seeing.</span>
<span class="sd">        weight_depth : float, optional</span>
<span class="sd">            The weight for the depth.</span>
<span class="sd">        max_numbers : int, optional</span>
<span class="sd">            The maximum number of images to select.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        best_image : ScienceImage</span>
<span class="sd">            The best image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">seeinglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">depthlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ellipticitylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obsdatelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Querying reference images...&#39;</span><span class="p">):</span>
            <span class="n">seeinglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">seeing_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">depthlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">depth_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">ellipticitylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ellipticity_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">obsdatelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obsdate_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obsdate_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obsdatelist</span><span class="p">)</span>
            <span class="n">max_obs_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">flexible_time_parser</span><span class="p">(</span><span class="n">max_obsdate</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_obsdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid date format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>          
        <span class="c1"># Mask for images before max_obsdate</span>
        <span class="n">valid_obs_mask</span> <span class="o">=</span> <span class="n">obsdate_time</span> <span class="o">&lt;</span> <span class="n">max_obs_time</span>
        
        <span class="c1"># Also apply validity mask for seeing, depth, ellipticity</span>
        <span class="n">seeinglist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">depthlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depthlist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">ellipticitylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">valid_value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">depthlist</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">))</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">valid_obs_mask</span> <span class="o">&amp;</span> <span class="n">valid_value_mask</span>
          
        <span class="c1"># Apply final mask</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">see</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depthlist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">filtered_imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">filtered_obsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsdate_time</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>

        <span class="c1"># Normalize</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">ell_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">ell</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">see_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">see</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dep_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Compute combined score</span>
        <span class="c1"># You can adjust weights if needed</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ell_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_ellipticity</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">see_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_seeing</span> <span class="o">+</span> <span class="n">dep_norm</span> <span class="o">*</span> <span class="n">weight_depth</span>

        <span class="c1"># Rank and select best</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">score</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># descending</span>
        <span class="n">best_images</span> <span class="o">=</span> <span class="n">filtered_imgs</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>

        <span class="c1"># Top N or just best</span>
        <span class="n">best_image</span> <span class="o">=</span> <span class="n">best_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Data for plotting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depthlist</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">)</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">c_valid</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">best_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_x</span> <span class="o">=</span> <span class="n">see</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">best_y</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">best_c</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">selected_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[:</span><span class="n">max_numbers</span><span class="p">]</span>
        <span class="n">selected_x</span> <span class="o">=</span> <span class="n">see</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">selected_y</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">selected_c</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">marker_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obsdate_time</span> <span class="o">&lt;</span> <span class="n">max_obs_time</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">marker_alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obsdate_time</span> <span class="o">&lt;</span> <span class="n">max_obs_time</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># Calculate percentiles (90%, 75%, and 50%)</span>
        <span class="n">p90_x</span><span class="p">,</span> <span class="n">p75_x</span><span class="p">,</span> <span class="n">p50_x</span><span class="p">,</span> <span class="n">p25_x</span><span class="p">,</span> <span class="n">p10_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
        <span class="n">p90_y</span><span class="p">,</span> <span class="n">p75_y</span><span class="p">,</span> <span class="n">p50_y</span><span class="p">,</span> <span class="n">p25_y</span><span class="p">,</span> <span class="n">p10_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

        <span class="c1"># Calculate the number of images for each percentile</span>
        <span class="n">num_images_p90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_valid</span> <span class="o">&lt;=</span> <span class="n">p90_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_valid</span> <span class="o">&gt;=</span> <span class="n">p90_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 10th percentile</span>
        <span class="n">num_images_p75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_valid</span> <span class="o">&lt;=</span> <span class="n">p75_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_valid</span> <span class="o">&gt;=</span> <span class="n">p75_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 25th percentile</span>
        <span class="n">num_images_p50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_valid</span> <span class="o">&lt;=</span> <span class="n">p50_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_valid</span> <span class="o">&gt;=</span> <span class="n">p50_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 50th percentile</span>
        <span class="n">num_images_p25</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_valid</span> <span class="o">&lt;=</span> <span class="n">p25_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_valid</span> <span class="o">&gt;=</span> <span class="n">p25_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 75th percentile</span>

        <span class="c1"># Create figure with GridSpec layout</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Create scatter plot</span>
        <span class="n">ax_main</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">],</span>
                            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">],</span>
                            <span class="n">s</span><span class="o">=</span><span class="n">marker_sizes</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">],</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">marker_alphas</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">],</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;All images&#39;</span><span class="p">)</span>        
        <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Out of date range&#39;</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_main</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Ellipticity&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p90_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p75_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p50_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p25_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p90_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p75_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p50_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p25_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">p90_x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">p10_x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">p10_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p90_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Seeing [arcsec]&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Depth [AB]&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected_x</span><span class="p">,</span> <span class="n">selected_y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Selected&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">best_x</span><span class="p">,</span> <span class="n">best_y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">best_x</span><span class="p">,</span> <span class="n">best_y</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Best</span><span class="se">\n</span><span class="s2">Seeing = </span><span class="si">{</span><span class="n">best_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec</span><span class="se">\n</span><span class="s2">Depth = </span><span class="si">{</span><span class="n">best_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> AB</span><span class="se">\n</span><span class="s2">Ellipticity = </span><span class="si">{</span><span class="n">best_c</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1"># Create top histogram</span>
        <span class="n">ax_histx</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_main</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide top spine</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide right spine</span>

        <span class="c1"># Create right histogram</span>
        <span class="n">ax_histy</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_main</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide top spine</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide right spine</span>

        <span class="c1"># Set limits for histograms to fit within the black box</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax_main</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax_main</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>

        <span class="c1"># Plot vertical regions for percentiles in histograms</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p90_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p75_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p50_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p25_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>

        <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p90_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p75_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p50_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p25_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>

        <span class="c1"># Add text annotation in the upper right region of the scatter plot</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Percentile (# of images, Seeing, Depth):</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;90% (</span><span class="si">{</span><span class="n">num_images_p90</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p90_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p90_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;75% (</span><span class="si">{</span><span class="n">num_images_p75</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p75_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p75_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;50% (</span><span class="si">{</span><span class="n">num_images_p50</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p50_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p50_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;25% (</span><span class="si">{</span><span class="n">num_images_p25</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p25_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p25_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">ax_main</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax_main</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.5&#39;</span><span class="p">))</span>
        
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

        <span class="n">dashed_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">),</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">),</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">),</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">dashed_lines</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span>
                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="n">selected_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">best_images</span><span class="p">[:</span><span class="n">max_numbers</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Loading selected images...&#39;</span><span class="p">):</span>
            <span class="n">ref_img</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ref_img</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">ref_img</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">ref_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
            <span class="n">selected_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected_images</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reproject_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">reference_img</span><span class="p">:</span> <span class="n">ReferenceImage</span><span class="p">,</span>
                             <span class="n">target_img</span><span class="p">:</span> <span class="n">ScienceImage</span><span class="p">,</span>
                             <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reproject the reference image to the target image&#39;s central WCS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reference_img</span><span class="o">.</span><span class="n">savedir</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span>
        <span class="n">center_target</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">center</span>
        <span class="n">reprojected_reference</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reprojected_reference_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span>
            <span class="n">target_img</span> <span class="o">=</span> <span class="n">reference_img</span><span class="p">,</span>
            <span class="n">swarp_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">resample_type</span> <span class="o">=</span> <span class="s1">&#39;LANCZOS3&#39;</span><span class="p">,</span>
            <span class="n">center_ra</span> <span class="o">=</span> <span class="n">center_target</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span>
            <span class="n">center_dec</span> <span class="o">=</span> <span class="n">center_target</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span>
            <span class="n">x_size</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">naxis1</span><span class="p">,</span>
            <span class="n">y_size</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">naxis2</span><span class="p">,</span>
            <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
            <span class="n">return_ivpmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">is_wcs_equal</span><span class="p">(</span><span class="n">reprojected_reference</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: target_img is not reprojected (not aligned to the North). Run Projection().reproject&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reprojected_reference</span><span class="p">,</span> <span class="n">reprojected_reference_ivpmask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_subtract_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">target_img</span><span class="p">:</span> <span class="n">ScienceImage</span><span class="p">,</span>
                                 <span class="n">reference_img</span><span class="p">:</span> <span class="n">ReferenceImage</span><span class="p">,</span>
                                 <span class="n">target_ivpmask</span><span class="p">:</span> <span class="n">Mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">reference_ivpmask</span><span class="p">:</span> <span class="n">Mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">target_stamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">id_</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        target_img: should be reprojected</span>
<span class="sd">        reference_img: should be reprojected</span>
<span class="sd">        So, both images should have the same WCS.</span>
<span class="sd">        target_ivpmask: Mask for the target image, if None, will be created</span>
<span class="sd">        reference_ivpmask: Mask for the reference image, if None, will be created</span>
<span class="sd">        This will create the subtracted region by trimming both images to the overlapping region.</span>
<span class="sd">        fullframe (of target_img) subtraction region also will be returned </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># If wcs is not equal, reproject target to reference</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">is_wcs_equal</span><span class="p">(</span><span class="n">reference_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Target and reference images have different WCS. Please reproject the target image to match the reference image WCS.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_ivpmask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">target_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masking</span><span class="o">.</span><span class="n">mask_invalidpixel</span><span class="p">(</span>
                    <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span>
                    <span class="n">target_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                    <span class="n">visualize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_ivpmask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reference_ivpmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masking</span><span class="o">.</span><span class="n">mask_invalidpixel</span><span class="p">(</span>
                    <span class="n">target_img</span> <span class="o">=</span> <span class="n">reference_img</span><span class="p">,</span>
                    <span class="n">target_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                    <span class="n">visualize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="p">)</span>
            
        <span class="c1"># All data and mask are ready</span>
        <span class="c1"># Create a new mask that combines the invalid pixel masks</span>
        <span class="n">fullframe_subtract_mask</span> <span class="o">=</span> <span class="n">target_ivpmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">masktype</span> <span class="o">=</span> <span class="s1">&#39;subtraction&#39;</span>
        <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">submaskpath</span>
        <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">combine_mask</span><span class="p">(</span><span class="n">reference_ivpmask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">fullframe_subtract_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">y_valid</span><span class="p">,</span> <span class="n">x_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_valid</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_valid</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_valid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (x_center, y_center)</span>
        
        <span class="n">cutout_target</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        <span class="n">cutout_reference</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">reference_img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">reference_img</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>

        <span class="c1"># Update image and WCS</span>
        <span class="n">subframe_target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_subframe_</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
        <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cutout_target</span><span class="o">.</span><span class="n">data</span>
        <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cutout_target</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>

        <span class="n">subframe_reference_img</span> <span class="o">=</span> <span class="n">reference_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="p">(</span><span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_subframe_</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savedir</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savedir</span> <span class="c1"># Change the savedir to the same as target_img</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cutout_reference</span><span class="o">.</span><span class="n">data</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cutout_reference</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
        
        <span class="n">subframe_target_ivpmask</span> <span class="o">=</span> <span class="n">target_ivpmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">invalidmaskpath</span><span class="c1">#target_ivpmask.savepath.savedir / (target_ivpmask.savepath.savepath.stem + f&#39;_subframe_{id_}&#39; + target_ivpmask.savepath.savepath.suffix)</span>
        <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">target_ivpmask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
        <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cutout_target</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
        
        <span class="n">subframe_reference_ivpmask</span> <span class="o">=</span> <span class="n">reference_ivpmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">invalidmaskpath</span><span class="c1">#reference_ivpmask.savepath.savedir / (reference_ivpmask.savepath.savepath.stem + f&#39;_subframe_{id_}&#39; + reference_ivpmask.savepath.savepath.suffix)</span>
        <span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">reference_ivpmask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
        <span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cutout_reference</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
        
        <span class="n">subframe_subtract_mask</span> <span class="o">=</span> <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subframe_subtract_mask</span><span class="o">.</span><span class="n">masktype</span> <span class="o">=</span> <span class="s1">&#39;subtraction&#39;</span>
        <span class="n">subframe_subtract_mask</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">subframe_subtract_mask</span><span class="o">.</span><span class="n">combine_mask</span><span class="p">(</span><span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        
        <span class="c1"># If target_stamp is provided, trim the subframe_target_img to the target_stamp</span>
        <span class="n">subframe_target_stamp_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">target_stamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_stamp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_stamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_stamp</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target stamp file </span><span class="si">{</span><span class="n">target_stamp</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stamp_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">target_stamp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">x_key</span> <span class="o">=</span> <span class="n">stamp_tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y_key</span> <span class="o">=</span> <span class="n">stamp_tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stamp_tbl</span><span class="p">[</span><span class="n">x_key</span><span class="p">])</span>
                <span class="n">y_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stamp_tbl</span><span class="p">[</span><span class="n">y_key</span><span class="p">])</span>

                <span class="c1"># Filter for sources within the cutout region</span>
                <span class="n">in_cutout</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">x_full</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_full</span> <span class="o">&lt;</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">y_full</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_full</span> <span class="o">&lt;</span> <span class="n">y_max</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Shift coordinates to subframe system</span>
                <span class="n">x_sub</span> <span class="o">=</span> <span class="n">x_full</span><span class="p">[</span><span class="n">in_cutout</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_min</span>
                <span class="n">y_sub</span> <span class="o">=</span> <span class="n">y_full</span><span class="p">[</span><span class="n">in_cutout</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_min</span>
                
                <span class="n">subframe_target_stamp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
                <span class="n">subframe_target_stamp</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sub</span>
                <span class="n">subframe_target_stamp</span><span class="p">[</span><span class="n">y_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_sub</span>
                <span class="n">subframe_target_stamp_path</span> <span class="o">=</span> <span class="n">target_stamp</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">target_stamp</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_subframe_</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">target_stamp</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="n">subframe_target_stamp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">subframe_target_stamp_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Fill nan value to 0</span>
        <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">10</span><span class="o">*</span> <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">10</span><span class="o">*</span> <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span>
        <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subframe_target_img</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  

        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">subframe_target_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">subframe_reference_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">subframe_target_ivpmask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> 
            <span class="n">subframe_reference_ivpmask</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">subframe_target_img</span><span class="p">,</span> <span class="n">subframe_reference_img</span><span class="p">,</span> <span class="n">subframe_target_ivpmask</span><span class="p">,</span> <span class="n">subframe_reference_ivpmask</span><span class="p">,</span> <span class="n">fullframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_subtract_mask</span><span class="p">,</span> <span class="n">subframe_target_stamp_path</span></div>





<span class="c1"># %%</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataBrowser</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">TIPSubtraction</span><span class="p">()</span>
<span class="c1">#%%</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">databrowser</span> <span class="o">=</span> <span class="n">DataBrowser</span><span class="p">(</span><span class="s1">&#39;scidata&#39;</span><span class="p">)</span>
    <span class="n">tile_id</span> <span class="o">=</span> <span class="s1">&#39;T08262&#39;</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">objname</span> <span class="o">=</span> <span class="n">tile_id</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
    <span class="n">stacked_imgset</span> <span class="o">=</span> <span class="n">databrowser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;calib*202507*com.fits&#39;</span><span class="p">,</span>
        <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;science&#39;</span>
    <span class="p">)</span>        
    <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">stacked_imgset</span><span class="o">.</span><span class="n">target_images</span>
    <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">bkgmap</span>
    <span class="n">reference_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_referenceframe_from_image</span><span class="p">(</span><span class="n">target_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reference_imglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">reference_img</span><span class="p">]</span>
    <span class="n">target_bkg</span><span class="p">:</span> <span class="n">Background</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">detection_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">aperture_diameter_arcsec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">aperture_diameter_seeing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">4.5</span><span class="p">]</span>
    <span class="n">kron_factor</span> <span class="o">=</span> <span class="mf">1.5</span> 
    
    <span class="n">target_transient_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">reject_variable_sources</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">negative_detection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">reverse_subtraction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">show_transient_numbers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">nrx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nsx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">nsy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">ko</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">bgo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">hotpants_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># result = self.find_transients(</span>
    <span class="c1">#     target_img = target_img,</span>
    <span class="c1">#     reference_imglist = reference_imglist,</span>
    <span class="c1">#     target_bkg = None,</span>
    <span class="c1">#     detection_sigma = 5,</span>
    <span class="c1">#     aperture_diameter_arcsec = [5,7,10],</span>
    <span class="c1">#     aperture_diameter_seeing = [3.5,4.5],</span>
    <span class="c1">#     target_transient_number = 5,</span>
    <span class="c1">#     reject_variable_sources = True,</span>
    <span class="c1">#     negative_detection = True,</span>
    <span class="c1">#     reverse_subtraction = False,</span>
    <span class="c1">#     visualize = False,</span>
    <span class="c1"># )</span>


<span class="c1"># %%</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hyeonho Choi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>