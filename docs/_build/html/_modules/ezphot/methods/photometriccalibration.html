

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ezphot.methods.photometriccalibration &mdash; ezphot 0.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=bbaf98b3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ezphot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imageobjects.html">Imageobjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dataobjects.html">DataObjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ezphot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ezphot.methods.photometriccalibration</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ezphot.methods.photometriccalibration</h1><div class="highlight"><pre>
<span></span><span class="c1">#%%</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">cKDTree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.imageobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.dataobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Catalog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.skycatalog</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCatalogUtility</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1">#%%</span>

<div class="viewcode-block" id="PhotometricCalibration">
<a class="viewcode-back" href="../../../api/photometriccalibration.html#ezphot.methods.photometriccalibration.PhotometricCalibration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PhotometricCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method class to perform photometric calibration of astronomical images.</span>
<span class="sd">    </span>
<span class="sd">    This class provides methods </span>
<span class="sd">    </span>
<span class="sd">    1. Photometric calibration using reference catalogs.</span>
<span class="sd">    </span>
<span class="sd">    2. Photometric calibration using reference images.</span>
<span class="sd">    </span>
<span class="sd">    3. Photometric calibration using reference images and catalogs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalogutils</span> <span class="o">=</span> <span class="n">SkyCatalogUtility</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">photometric_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">],</span>
                                <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                                <span class="n">catalog_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GAIAXP&#39;</span><span class="p">,</span>
                                <span class="n">max_distance_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">calculate_color_terms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">calculate_mag_terms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                
                                <span class="c1"># Selection parameters</span>
                                <span class="n">mag_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
                                <span class="n">mag_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                                <span class="n">dynamic_mag_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">classstar_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
                                <span class="n">elongation_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.7</span><span class="p">,</span>
                                <span class="n">elongation_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                <span class="n">fwhm_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">fwhm_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                                <span class="n">fwhm_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                <span class="n">flag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">maskflag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">inner_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Fraction of the images</span>
                                <span class="n">isolation_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                                <span class="n">magnitude_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">,</span>
                                <span class="n">fwhm_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">,</span>
                                <span class="n">x_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;X_IMAGE&#39;</span><span class="p">,</span>
                                <span class="n">y_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">,</span>
                                <span class="n">classstar_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">,</span>
                                <span class="n">elongation_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ELONGATION&#39;</span><span class="p">,</span>
                                <span class="n">flag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">,</span>
                                <span class="n">maskflag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;IMAFLAGS_ISO&#39;</span><span class="p">,</span>

                                <span class="c1"># Other parameters</span>
                                <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">save_refcat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform photometric calibration of astronomical images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage or ReferenceImage or CalibrationImage</span>
<span class="sd">            The target image to perform photometric calibration on.</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to use for photometric calibration.</span>
<span class="sd">        catalog_type : str, optional</span>
<span class="sd">            The type of catalog to use for photometric calibration.</span>
<span class="sd">        max_distance_second : float, optional</span>
<span class="sd">            The maximum distance in arcseconds to search for secondaries.</span>
<span class="sd">        calculate_color_terms : bool, optional</span>
<span class="sd">            Whether to calculate color terms.</span>
<span class="sd">        calculate_mag_terms : bool, optional</span>
<span class="sd">            Whether to calculate magnitude terms.</span>
<span class="sd">        mag_lower : float, optional</span>
<span class="sd">            The lower magnitude limit for the reference star selection.</span>
<span class="sd">        mag_upper : float, optional</span>
<span class="sd">            The upper magnitude limit for the reference star selection.</span>
<span class="sd">        classstar_lower : float, optional</span>
<span class="sd">            The lower class star limit for the reference star selection.</span>
<span class="sd">        elongation_upper : float, optional</span>
<span class="sd">            The upper elongation limit for the reference star selection.</span>
<span class="sd">        elongation_sigma : float, optional</span>
<span class="sd">            The sigma of the elongation for the reference star selection.</span>
<span class="sd">        fwhm_lower : float, optional</span>
<span class="sd">            The lower FWHM limit for the reference star selection.</span>
<span class="sd">        fwhm_upper : float, optional</span>
<span class="sd">            The upper FWHM limit for the reference star selection.</span>
<span class="sd">        fwhm_sigma : float, optional</span>
<span class="sd">            The sigma of the FWHM for the reference star selection.</span>
<span class="sd">        flag_upper : int, optional</span>
<span class="sd">            The upper flag limit for the reference star selection.</span>
<span class="sd">        maskflag_upper : int, optional</span>
<span class="sd">            The upper mask flag limit for the reference star selection.</span>
<span class="sd">        inner_fraction : float, optional</span>
<span class="sd">            The inner fraction of the image to use for the reference star selection.</span>
<span class="sd">        isolation_radius : float, optional</span>
<span class="sd">            The isolation radius for the reference star selection.</span>
<span class="sd">        magnitude_key : str, optional</span>
<span class="sd">            The key of the magnitude column in the catalog.</span>
<span class="sd">        fwhm_key : str, optional</span>
<span class="sd">            The key of the FWHM column in the catalog.</span>
<span class="sd">        x_key : str, optional</span>
<span class="sd">            The key of the X column in the catalog.</span>
<span class="sd">        y_key : str, optional</span>
<span class="sd">            The key of the Y column in the catalog.</span>
<span class="sd">        classstar_key : str, optional</span>
<span class="sd">            The key of the class star column in the catalog.</span>
<span class="sd">        elongation_key : str, optional</span>
<span class="sd">            The key of the elongation column in the catalog.</span>
<span class="sd">        flag_key : str, optional</span>
<span class="sd">            The key of the flag column in the catalog.</span>
<span class="sd">        maskflag_key : str, optional</span>
<span class="sd">            The key of the mask flag column in the catalog.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the photometric calibration.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the figure.</span>
<span class="sd">        save_refcat : bool, optional</span>
<span class="sd">            Whether to save the reference catalog.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_img: ScienceImage or ReferenceImage or CalibrationImage</span>
<span class="sd">            The target image with photometric calibration.</span>
<span class="sd">        target_catalog: Catalog</span>
<span class="sd">            The updated catalog with photometric calibration.</span>
<span class="sd">        filtered_catalog: Catalog</span>
<span class="sd">            The reference catalog for photometric calibration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">catalogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalogutils</span><span class="o">.</span><span class="n">get_catalogs_coord</span><span class="p">(</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
            <span class="n">fov_ra</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">fovx</span><span class="p">,</span>
            <span class="n">fov_dec</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">fovy</span><span class="p">,</span>
            <span class="n">catalog_type</span> <span class="o">=</span> <span class="n">catalog_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalogs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No catalogs found in the given coordinates.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_references</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">catalog</span> <span class="ow">in</span> <span class="n">catalogs</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalogutils</span><span class="o">.</span><span class="n">select_reference_sources</span><span class="p">(</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">mag_lower</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mag_upper</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#data = catalog.data</span>
                <span class="n">all_references</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">all_references</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span>
                
        <span class="c1"># Calculate Zero Point</span>
        <span class="n">mag_key_ref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_mag&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>        
        <span class="n">zp_key_ref</span> <span class="o">=</span> <span class="n">magnitude_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;ZP_&#39;</span><span class="p">)</span>
        <span class="n">all_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">catalog_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">all_catalog_data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span> <span class="n">all_catalog_data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">all_references</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">all_references</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">obj_indices</span><span class="p">,</span> <span class="n">ref_indices</span><span class="p">,</span> <span class="n">unmatched_obj_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">cross_match</span><span class="p">(</span><span class="n">catalog_coord</span><span class="p">,</span> <span class="n">reference_coord</span><span class="p">,</span> <span class="n">max_distance_second</span> <span class="o">=</span> <span class="n">max_distance_second</span><span class="p">)</span>
        <span class="n">matched_obj_all</span> <span class="o">=</span> <span class="n">all_catalog_data</span><span class="p">[</span><span class="n">obj_indices</span><span class="p">]</span>
        <span class="n">matched_ref_all</span> <span class="o">=</span> <span class="n">all_references</span><span class="p">[</span><span class="n">ref_indices</span><span class="p">]</span>
        <span class="n">matched_obj_all</span><span class="p">[</span><span class="s1">&#39;MAG_REF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_ref_all</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">]</span>
        <span class="n">zp_all</span> <span class="o">=</span> <span class="n">matched_ref_all</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">]</span> <span class="o">-</span> <span class="n">matched_obj_all</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">]</span>
        <span class="n">matched_obj_all</span><span class="p">[</span><span class="s1">&#39;ZP_REF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_all</span>
        <span class="n">matched_catalog</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matched_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">matched_obj_all</span>
        <span class="n">zp_median_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>
        <span class="n">zp_err_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dynamic_mag_range</span><span class="p">:</span>
            <span class="c1"># Configuration sets for retries</span>
            <span class="n">bin_width_options</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
            <span class="n">sigma_clip_options</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
            <span class="n">closest_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Track the difference closest to 1.7</span>

            <span class="n">closest_result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Loop through combinations of bin_width and sigma_clip</span>
            <span class="k">for</span> <span class="n">bw</span> <span class="ow">in</span> <span class="n">bin_width_options</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sigma_clip_options</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] bin_width=</span><span class="si">{</span><span class="n">bw</span><span class="si">}</span><span class="s2">, sigma_clip=</span><span class="si">{</span><span class="n">sc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                        <span class="n">mag_min</span><span class="p">,</span> <span class="n">mag_max</span><span class="p">,</span> <span class="n">zp_rough</span><span class="p">,</span> <span class="n">zp_err_rough</span><span class="p">,</span> <span class="n">saturation_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_reference_mag_range</span><span class="p">(</span>
                            <span class="n">target_catalog</span><span class="o">=</span><span class="n">matched_catalog</span><span class="p">,</span>
                            <span class="n">bin_width</span><span class="o">=</span><span class="n">bw</span><span class="p">,</span>
                            <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                            <span class="n">magnitude_key</span><span class="o">=</span><span class="s1">&#39;MAG_REF&#39;</span><span class="p">,</span>
                            <span class="n">zp_key</span><span class="o">=</span><span class="s1">&#39;ZP_REF&#39;</span><span class="p">,</span>
                            <span class="n">fwhm_key</span><span class="o">=</span><span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                            <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">save_fig</span><span class="o">=</span><span class="n">save_fig</span>
                        <span class="p">)</span>

                        <span class="c1"># Save current try</span>
                        <span class="n">try_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">bin_width</span><span class="o">=</span><span class="n">bw</span><span class="p">,</span>
                            <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                            <span class="n">mag_min</span><span class="o">=</span><span class="n">mag_min</span><span class="p">,</span>
                            <span class="n">mag_max</span><span class="o">=</span><span class="n">mag_max</span><span class="p">,</span>
                            <span class="n">zp_rough</span><span class="o">=</span><span class="n">zp_rough</span><span class="p">,</span>
                            <span class="n">zp_err_rough</span><span class="o">=</span><span class="n">zp_err_rough</span><span class="p">,</span>
                            <span class="n">saturation_level</span><span class="o">=</span><span class="n">saturation_level</span>
                        <span class="p">)</span>
                        <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mag_max</span> <span class="o">-</span> <span class="n">mag_min</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">mag_min</span> <span class="o">&gt;</span> <span class="n">mag_upper</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mag_max</span> <span class="o">&lt;</span> <span class="n">mag_lower</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="k">continue</span>
                        
                        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">closest_diff</span><span class="p">:</span>
                            <span class="n">closest_diff</span> <span class="o">=</span> <span class="n">diff</span>
                            <span class="n">closest_result</span> <span class="o">=</span> <span class="n">try_set</span>
                        
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="c1"># Finalize result</span>
            <span class="k">if</span> <span class="n">closest_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Dynamic mag range found: </span><span class="si">{</span><span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;mag_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &lt; mag &lt; </span><span class="si">{</span><span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;mag_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">mag_min</span> <span class="o">=</span> <span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;mag_min&#39;</span><span class="p">]</span>
                <span class="n">mag_max</span> <span class="o">=</span> <span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;mag_max&#39;</span><span class="p">]</span>
                <span class="n">zp_median_all</span> <span class="o">=</span> <span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;zp_rough&#39;</span><span class="p">]</span>
                <span class="n">zp_err_all</span> <span class="o">=</span> <span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;zp_err_rough&#39;</span><span class="p">]</span>
                <span class="n">saturation_level</span> <span class="o">=</span> <span class="n">closest_result</span><span class="p">[</span><span class="s1">&#39;saturation_level&#39;</span><span class="p">]</span>
                <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;SATURATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">saturation_level</span><span class="p">,</span> <span class="s2">&quot;Saturation level in ADU&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] No valid result found from dynamic mag range. Using default mag range.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">mag_min</span> <span class="o">=</span> <span class="n">mag_lower</span>
                <span class="n">mag_max</span> <span class="o">=</span> <span class="n">mag_upper</span>
                <span class="n">zp_median_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>
                <span class="n">zp_err_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zp_median_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>
            <span class="n">zp_err_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zp_all</span><span class="p">)</span>
            <span class="n">mag_min</span> <span class="o">=</span> <span class="n">mag_lower</span>
            <span class="n">mag_max</span> <span class="o">=</span> <span class="n">mag_upper</span>
        <span class="n">magnitude_sky_key</span> <span class="o">=</span> <span class="n">magnitude_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGSKY_&#39;</span><span class="p">)</span>
        <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">magnitude_sky_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_median_all</span>

        <span class="c1"># Filter out reference sources</span>
        <span class="n">filtered_catalog</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">target_seeing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_stars</span><span class="p">(</span>
            <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
            <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span> 
            <span class="n">mag_lower</span> <span class="o">=</span> <span class="n">mag_min</span><span class="p">,</span>
            <span class="n">mag_upper</span> <span class="o">=</span> <span class="n">mag_max</span><span class="p">,</span>
            <span class="n">classstar_lower</span> <span class="o">=</span> <span class="n">classstar_lower</span><span class="p">,</span>
            <span class="n">elongation_upper</span> <span class="o">=</span> <span class="n">elongation_upper</span><span class="p">,</span>
            <span class="n">elongation_sigma</span> <span class="o">=</span> <span class="n">elongation_sigma</span><span class="p">,</span>
            <span class="n">fwhm_lower</span> <span class="o">=</span> <span class="n">fwhm_lower</span><span class="p">,</span>
            <span class="n">fwhm_sigma</span> <span class="o">=</span> <span class="n">fwhm_sigma</span><span class="p">,</span>
            <span class="n">flag_upper</span> <span class="o">=</span> <span class="n">flag_upper</span><span class="p">,</span>
            <span class="n">maskflag_upper</span> <span class="o">=</span> <span class="n">maskflag_upper</span><span class="p">,</span>
            <span class="n">magnitude_key</span> <span class="o">=</span> <span class="n">magnitude_sky_key</span><span class="p">,</span>
            <span class="n">fwhm_key</span> <span class="o">=</span> <span class="n">fwhm_key</span><span class="p">,</span>
            <span class="n">x_key</span> <span class="o">=</span> <span class="n">x_key</span><span class="p">,</span>
            <span class="n">y_key</span> <span class="o">=</span> <span class="n">y_key</span><span class="p">,</span>
            <span class="n">classstar_key</span> <span class="o">=</span> <span class="n">classstar_key</span><span class="p">,</span>
            <span class="n">elongation_key</span> <span class="o">=</span> <span class="n">elongation_key</span><span class="p">,</span>
            <span class="n">flag_key</span> <span class="o">=</span> <span class="n">flag_key</span><span class="p">,</span>
            <span class="n">maskflag_key</span> <span class="o">=</span> <span class="n">maskflag_key</span><span class="p">,</span>
            <span class="n">inner_fraction</span> <span class="o">=</span> <span class="n">inner_fraction</span><span class="p">,</span>
            <span class="n">isolation_radius</span> <span class="o">=</span> <span class="n">isolation_radius</span>
            <span class="p">)</span>
        
        <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">catalog_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;X_WORLD&#39;</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;Y_WORLD&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">all_references</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">all_references</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">obj_indices</span><span class="p">,</span> <span class="n">ref_indices</span><span class="p">,</span> <span class="n">unmatched_obj_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">cross_match</span><span class="p">(</span><span class="n">catalog_coord</span><span class="p">,</span> <span class="n">reference_coord</span><span class="p">,</span> <span class="n">max_distance_second</span> <span class="o">=</span> <span class="n">max_distance_second</span><span class="p">)</span>
        <span class="n">matched_obj</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">obj_indices</span><span class="p">]</span>
        <span class="n">matched_ref</span> <span class="o">=</span> <span class="n">all_references</span><span class="p">[</span><span class="n">ref_indices</span><span class="p">]</span>
        <span class="n">filtered_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">matched_obj</span>
        <span class="k">if</span> <span class="n">save_refcat</span><span class="p">:</span>
            <span class="n">filtered_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

        <span class="c1"># Update the target image header</span>
        <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;PEEING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_seeing</span><span class="p">,</span> <span class="s2">&quot;Seeing FWHM in pixel&quot;</span><span class="p">)</span>
        <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;SEEING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_seeing</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">),</span> <span class="s2">&quot;Seeing FWHM in arcsec&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;SKYVAL&#39;</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">skyval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;SKYVAL&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;BACKGROUND&#39;</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">skyval</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skyval</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYVAL</span>
        <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;SKYVAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">skyval</span><span class="p">,</span> <span class="s2">&quot;Global Background level in ADU&quot;</span><span class="p">)</span>
        
        <span class="n">skysig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;SKYSIG&#39;</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">skysig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skysig</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span>
        <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">skysig</span><span class="p">,</span> <span class="s2">&quot;Global background noise in ADU&quot;</span><span class="p">)</span>
        
        <span class="n">ellip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;ELLIPTICITY&#39;</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">ellip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="s1">&#39;ELLIPTICITY&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ellip</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">ELLIPTICITY</span>
        <span class="n">update_kwargs</span><span class="p">[</span><span class="s1">&#39;ELLIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ellip</span><span class="p">,</span> <span class="s2">&quot;Mean ellipticity of the sources in the catalog&quot;</span><span class="p">)</span>

        <span class="n">mag_key_ref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_mag&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
        <span class="n">magerr_key_ref</span> <span class="o">=</span> <span class="s1">&#39;e_</span><span class="si">%s</span><span class="s1">_mag&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
        <span class="n">mag_key_all</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_obj</span><span class="o">.</span><span class="n">colnames</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">matched_obj</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>

        <span class="n">zp_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">color_term_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">mag_term_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># Update magnitude related keys</span>
        <span class="k">for</span> <span class="n">mag_key</span> <span class="ow">in</span> <span class="n">mag_key_all</span><span class="p">:</span>
            <span class="n">magerr_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGERR_&#39;</span><span class="p">)</span>
            <span class="n">zp_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;ZP_&#39;</span><span class="p">)</span>
            <span class="n">zperr_key</span> <span class="o">=</span> <span class="n">magerr_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGERR_&#39;</span><span class="p">,</span> <span class="s1">&#39;ZPERR_&#39;</span><span class="p">)</span>
            <span class="n">mag_key_sky</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGSKY_&#39;</span><span class="p">)</span>
            <span class="n">npix_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;NPIX_&#39;</span><span class="p">)</span>
            <span class="n">ul3_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;UL3_&#39;</span><span class="p">)</span>
            <span class="n">ul5_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;UL5_&#39;</span><span class="p">)</span>
            
            <span class="c1"># Calculate zero point</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="n">matched_ref</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">]</span> <span class="o">-</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span>
            <span class="c1">#if magerr_key_ref in matched_ref.colnames:</span>
            <span class="c1">#    zperr = np.sqrt(matched_ref[magerr_key_ref]**2 + matched_objf[magerr_key]**2)</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="n">sc</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">zp_cleaned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">masked</span><span class="o">.</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">masked_zp</span> <span class="o">=</span> <span class="n">zp</span><span class="p">[</span><span class="o">~</span><span class="n">masked</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">zp_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">masked_zp</span><span class="p">)</span>
            <span class="n">zp_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">masked_zp</span><span class="p">)</span>     
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">mag_key_sky</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_median</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_median</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">zperr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_err</span>    
            <span class="n">matched_obj</span><span class="p">[</span><span class="n">mag_key_sky</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_median</span>
            <span class="n">matched_obj</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_median</span>
            <span class="n">matched_obj</span><span class="p">[</span><span class="n">zperr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_err</span>  
            <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ZP_all</span> <span class="o">=</span> <span class="n">masked_zp</span><span class="p">,</span> <span class="n">ZP_median</span> <span class="o">=</span> <span class="n">zp_median</span><span class="p">,</span> <span class="n">ZP_err</span> <span class="o">=</span> <span class="n">zp_err</span><span class="p">,</span> <span class="n">ZP_target</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">zp_cleaned_indices</span><span class="p">],</span> <span class="n">ZP_reference</span> <span class="o">=</span> <span class="n">matched_ref</span><span class="p">[</span><span class="n">zp_cleaned_indices</span><span class="p">])</span>
            <span class="n">update_kwargs</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp_median</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Zeropoint for </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">update_kwargs</span><span class="p">[</span><span class="n">zperr_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp_err</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Zeropoint error for </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Calculate Depth</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">npix_key</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">skysig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">npix_aperture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">npix_key</span><span class="p">])</span>
                    <span class="n">bkg_noise</span> <span class="o">=</span> <span class="n">skysig</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">npix_aperture</span><span class="p">)</span>
                    <span class="n">ul3</span> <span class="o">=</span> <span class="n">zp_median</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">bkg_noise</span><span class="p">)</span>
                    <span class="n">ul5</span> <span class="o">=</span> <span class="n">zp_median</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">bkg_noise</span><span class="p">)</span>
                    <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">ul3_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul3</span>
                    <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">ul5_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul5</span>
                    <span class="n">matched_obj</span><span class="p">[</span><span class="n">ul3_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul3</span>
                    <span class="n">matched_obj</span><span class="p">[</span><span class="n">ul5_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul5</span>
                    <span class="n">update_kwargs</span><span class="p">[</span><span class="n">ul3_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ul3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;3-sigma depth for </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">update_kwargs</span><span class="p">[</span><span class="n">ul5_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ul5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;5-sigma depth for </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># When calculate_color_terms</span>
            <span class="k">if</span> <span class="n">calculate_color_terms</span><span class="p">:</span>
                <span class="n">color_terms</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;m475&#39;</span><span class="p">,</span> <span class="s1">&#39;m625&#39;</span><span class="p">),</span> <span class="c1"># g-r</span>
                <span class="p">(</span><span class="s1">&#39;m625&#39;</span><span class="p">,</span> <span class="s1">&#39;m750&#39;</span><span class="p">),</span> <span class="c1"># r-i</span>
                <span class="p">(</span><span class="s1">&#39;m450&#39;</span><span class="p">,</span> <span class="s1">&#39;m550&#39;</span><span class="p">),</span> <span class="c1"># B-V</span>
                <span class="p">(</span><span class="s1">&#39;m550&#39;</span><span class="p">,</span> <span class="s1">&#39;m650&#39;</span><span class="p">),</span> <span class="c1"># V-R</span>
                <span class="p">(</span><span class="s1">&#39;m650&#39;</span><span class="p">,</span> <span class="s1">&#39;m800&#39;</span><span class="p">)</span> <span class="c1"># R-I</span>
                <span class="p">]</span>
                <span class="n">reference_tbl</span> <span class="o">=</span> <span class="n">matched_ref</span><span class="p">[</span><span class="n">zp_cleaned_indices</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="ow">in</span> <span class="n">color_terms</span><span class="p">:</span>
                    <span class="n">key1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s1">_mag&#39;</span>
                    <span class="n">key2</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s1">_mag&#39;</span>    
                    <span class="n">slope_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;K_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">intercept_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">reference_tbl</span><span class="o">.</span><span class="n">colnames</span> <span class="ow">and</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">reference_tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">reference_tbl</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_tbl</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Calculate residuals</span>
                            <span class="n">zp_residual</span> <span class="o">=</span> <span class="n">masked_zp</span> <span class="o">-</span> <span class="n">zp_median</span>
                            
                            <span class="c1"># Fit (ZP - ZP_median) = a * color + b</span>
                            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">zp_residual</span><span class="p">)</span>
                            
                            <span class="n">color_term_info</span><span class="p">[</span><span class="n">slope_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">),</span>
                            <span class="p">}</span>

                            <span class="c1"># Save slope and intercept with comments</span>
                            <span class="n">update_kwargs</span><span class="p">[</span><span class="n">slope_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Slope a in color correction: mag offset = a*(</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s2">) + b&quot;</span><span class="p">)</span>
                            <span class="n">update_kwargs</span><span class="p">[</span><span class="n">intercept_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Intercept b in color correction: mag offset = a*(</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s2">) + b&quot;</span><span class="p">)</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] [</span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">] Color term </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s2"> fit failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>   
            
            <span class="k">if</span> <span class="n">calculate_mag_terms</span><span class="p">:</span>
                <span class="n">slope_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;K_MAG_&#39;</span><span class="p">)</span> 
                <span class="n">intercept_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_MAG_&#39;</span><span class="p">)</span> 
                <span class="n">zp_residual</span> <span class="o">=</span> <span class="n">masked_zp</span> <span class="o">-</span> <span class="n">zp_median</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="n">zp_cleaned_indices</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_median</span>
                <span class="n">magerr</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">magerr_key</span><span class="p">][</span><span class="n">zp_cleaned_indices</span><span class="p">]</span>
                <span class="c1">#mag = matched_ref[mag_key_ref][zp_cleaned_indices]</span>
                <span class="c1">#magerr = matched_ref[magerr_key_ref][zp_cleaned_indices]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Fit (ZP - ZP_median) = a * mag + b</span>
                    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">zp_residual</span><span class="p">)</span>
                    
                    <span class="n">mag_term_info</span><span class="p">[</span><span class="n">slope_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Save slope and intercept with comments</span>
                    <span class="n">update_kwargs</span><span class="p">[</span><span class="n">slope_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Slope a in magnitude correction: mag offset = a*m_sky + b&quot;</span><span class="p">)</span>
                    <span class="n">update_kwargs</span><span class="p">[</span><span class="n">intercept_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Intercept b in magnitude correction: mag offset = a*m_sky + b&quot;</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] [</span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">] Magnitude term fit failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># Draw spatial variation of the zeropoint (density map)</span>
            <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">zp_residual</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="n">zp_median</span>
                <span class="n">x_key</span> <span class="o">=</span> <span class="s1">&#39;X_IMAGE&#39;</span>
                <span class="n">y_key</span> <span class="o">=</span> <span class="s1">&#39;Y_IMAGE&#39;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">y_key</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">zp_residual</span>

                <span class="c1"># Data</span>
                <span class="n">zp_residual</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="n">zp_median</span>
                <span class="n">x_key</span> <span class="o">=</span> <span class="s1">&#39;X_IMAGE&#39;</span>
                <span class="n">y_key</span> <span class="o">=</span> <span class="s1">&#39;Y_IMAGE&#39;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">matched_obj</span><span class="p">[</span><span class="n">y_key</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">zp_residual</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>

                <span class="c1"># Create meshgrid</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bins</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bins</span><span class="p">))</span>

                <span class="c1"># Fit 2D polynomial</span>
                <span class="n">poly2d</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial2D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LinearLSQFitter</span><span class="p">()</span>
                <span class="n">zp_model</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">poly2d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>  <span class="c1"># fit to residuals</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">zp_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

                <span class="c1"># Plot density map</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modeled ZP Variation&#39;</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                <span class="c1"># Add contour lines at ±zp_err</span>
                <span class="n">contours</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">zp_err</span><span class="p">,</span> <span class="n">zp_err</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Increased font size</span>

                <span class="c1"># Overlay points</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

                <span class="c1"># Labels and title with larger fonts</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] 2D Zeropoint Gradient (± $1σ_</span><span class="si">{ZP}</span><span class="s1">(</span><span class="si">%.3f</span><span class="s1">)$ contour)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">zp_key</span><span class="p">,</span> <span class="n">zp_err</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x_key</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_key</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                    <span class="n">fig_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">zp_key</span><span class="si">}</span><span class="s1">.2D.png&#39;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] ZP calibration plot saved to </span><span class="si">{</span><span class="n">fig_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Final: Update the header</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">update_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Update the target image status</span>
        <span class="n">target_img</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s1">&#39;ZPCALC&#39;</span><span class="p">)</span>
        
        <span class="c1"># Write the target image </span>
        <span class="n">target_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> 
        
        <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>            
            <span class="n">zp_median</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_median&#39;</span><span class="p">]</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zp_key_ref</span><span class="si">}</span><span class="s1"> calculation for </span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="si">}</span><span class="s1"> band&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Photometric reference (</span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">filter</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zp_key_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot scatter with FWHM_IMAGE as color</span>
            <span class="c1"># Set custom color limits for FWHM</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">matched_ref_all</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">],</span> <span class="n">zp_all</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">matched_obj_all</span><span class="p">[</span><span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">],</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">target_seeing</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">target_seeing</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;All targets [</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_ref_all</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_reference&#39;</span><span class="p">][</span><span class="n">mag_key_ref</span><span class="p">],</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_all&#39;</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Selected targets [</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s2">&quot;ZP_target&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_reference&#39;</span><span class="p">][</span><span class="n">mag_key_ref</span><span class="p">],</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_all&#39;</span><span class="p">],</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_target&#39;</span><span class="p">][</span><span class="n">magerr_key</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_err&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">zp_median</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;ZP = </span><span class="si">%.3f</span><span class="s1"> +/- </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">zp_median</span><span class="p">,</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="s1">&#39;ZP_err&#39;</span><span class="p">]))</span>
            <span class="c1"># Explicitly attach colorbar to the first scatter</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FWHM (pixel)&#39;</span><span class="p">)</span>
            
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">matched_ref_all</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">])</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">matched_ref_all</span><span class="p">[</span><span class="n">mag_key_ref</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">zp_median</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">zp_median</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">calculate_mag_terms</span><span class="p">:</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mag_term_info</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;K_</span><span class="si">{</span><span class="n">magnitude_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="o">+</span> <span class="n">zp_median</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Fit: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">x+</span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fit_result</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fit_result</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">fig_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.zp.png&#39;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] ZP calibration plot saved to </span><span class="si">{</span><span class="n">fig_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">calculate_color_terms</span><span class="p">:</span>

                <span class="c1"># Automatically get all keys from zp_info</span>
                <span class="n">photometry_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zp_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># Set up figure</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

                <span class="c1"># Optional: assign different colors and markers</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
                <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>

                <span class="c1"># Setup cycling through colors and markers if many keys</span>
                <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
                <span class="n">marker_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">mag_key</span> <span class="ow">in</span> <span class="n">photometry_keys</span><span class="p">:</span>
                    <span class="n">ref_magkey</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="s1">&#39;ZP_reference&#39;</span><span class="p">]</span>
                    <span class="n">target_magkey</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="s1">&#39;ZP_target&#39;</span><span class="p">]</span>
                    <span class="n">zp_all_magkey</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="s1">&#39;ZP_all&#39;</span><span class="p">]</span>
                    <span class="n">zp_median_magkey</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="s1">&#39;ZP_median&#39;</span><span class="p">]</span>
                    <span class="n">zp_err_magkey</span> <span class="o">=</span> <span class="n">zp_info</span><span class="p">[</span><span class="n">mag_key</span><span class="p">][</span><span class="s1">&#39;ZP_err&#39;</span><span class="p">]</span>

                    <span class="c1"># g - r color</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">ref_magkey</span><span class="p">[</span><span class="s1">&#39;g_mag&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_magkey</span><span class="p">[</span><span class="s1">&#39;r_mag&#39;</span><span class="p">]</span>

                    <span class="c1"># Fit linear model</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">zp_all_magkey</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] Fitting failed for </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Plot scatter</span>
                    <span class="n">color_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">)</span>
                    <span class="n">marker_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">marker_cycle</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">zp_all_magkey</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">zp_median_magkey</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> +/- </span><span class="si">{</span><span class="n">zp_err_magkey</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

                    <span class="c1"># Plot fit line</span>
                    <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                    
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Fit </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">x+</span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fit_result</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fit_result</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>

                <span class="c1"># --- Final plot settings ---</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;g - r color from reference catalog (mag)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Zero point residual (mag)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ZP Residual vs Color&#39;</span><span class="p">)</span>

                <span class="c1"># Correct ylim setting: based on min and max of all zp_median</span>
                <span class="k">if</span> <span class="n">photometry_keys</span><span class="p">:</span>
                    <span class="n">all_zp_medians</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;ZP_median&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">photometry_keys</span><span class="p">]</span>
                    <span class="n">zp_median_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_zp_medians</span><span class="p">)</span>
                    <span class="n">zp_median_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_zp_medians</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">zp_median_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zp_median_max</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span>

                <span class="c1"># Make legend smaller</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                    <span class="n">fig_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">catalogpath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.zp_color.png&#39;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] ZP calibration plot saved to </span><span class="si">{</span><span class="n">fig_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">target_img</span><span class="p">,</span> <span class="n">target_catalog</span><span class="p">,</span> <span class="n">filtered_catalog</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply photometric zeropoint corrections using values saved in the FITS header.</span>
<span class="sd">        Adds MAGSKY_*, ZP_*, ZPERR_*, UL3_*, UL5_* columns to target_catalog.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage or ReferenceImage</span>
<span class="sd">            The target image to apply photometric zeropoint corrections to.</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to apply photometric zeropoint corrections to.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog: Catalog</span>
<span class="sd">            The updated catalog with photometric zeropoint corrections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">header</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span>
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">skysig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;SKYSIG&#39;</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">skysig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="s1">&#39;SKYSIG&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skysig</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SKYSIG</span>
        
        <span class="n">magsky_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">colnames</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">mag_key</span> <span class="ow">in</span> <span class="n">magsky_keys</span><span class="p">:</span>
            <span class="n">mag_key_sky</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGSKY_&#39;</span><span class="p">)</span>
            <span class="n">zp_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;ZP_&#39;</span><span class="p">)</span>
            <span class="n">zperr_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;ZPERR_&#39;</span><span class="p">)</span>
            <span class="n">ul3_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;UL3_&#39;</span><span class="p">)</span>
            <span class="n">ul5_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;UL5_&#39;</span><span class="p">)</span>
            <span class="n">npix_key</span> <span class="o">=</span> <span class="n">mag_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAG_&#39;</span><span class="p">,</span> <span class="s1">&#39;NPIX_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">zp_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] </span><span class="si">{</span><span class="n">zp_key</span><span class="si">}</span><span class="s2"> not in header. Skipping </span><span class="si">{</span><span class="n">mag_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">zp</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">mag_key_sky</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">mag_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span>
            <span class="k">if</span> <span class="n">zperr_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">zperr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">zperr_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">skysig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">npix_aperture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">npix_key</span><span class="p">])</span>
                <span class="n">bkg_noise</span> <span class="o">=</span> <span class="n">skysig</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">npix_aperture</span><span class="p">)</span>
                <span class="n">ul3</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">bkg_noise</span><span class="p">)</span>
                <span class="n">ul5</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">bkg_noise</span><span class="p">)</span>
                <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">ul3_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul3</span>
                <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">ul5_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul5</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">target_catalog</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_color_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                          <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                          <span class="n">comparison_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>                          
                          <span class="n">max_distance_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                          <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                          <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply color term correction to target_catalog using compare_catalog_for_color.</span>
<span class="sd">        Color term equation: MAG_corrected = MAG + a*(color) + b</span>
<span class="sd">        where color = compare_catalog[filter_1] - compare_catalog[filter_2]</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage or ReferenceImage</span>
<span class="sd">            The target image to apply color term corrections to.</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to apply color term corrections to.</span>
<span class="sd">        comparison_catalog : Catalog</span>
<span class="sd">            The catalog to use for color term corrections.</span>
<span class="sd">        max_distance_second : float, optional</span>
<span class="sd">            The maximum distance in arcseconds to consider for color term corrections.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog: Catalog</span>
<span class="sd">            The updated catalog with color term corrections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
        
        <span class="c1"># 0. Cross-match catalogs</span>
        <span class="n">catalog_dataset</span> <span class="o">=</span> <span class="n">CatalogDataset</span><span class="p">([</span><span class="n">target_catalog</span><span class="p">,</span> <span class="n">comparison_catalog</span><span class="p">])</span>
        <span class="n">magsky_key_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">)]</span>
        <span class="n">mag_key_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span><span class="s1">&#39;MAG_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">magsky_key_all</span><span class="p">]</span>
        <span class="n">merged_catalog</span><span class="p">,</span> <span class="n">merged_metadata</span> <span class="o">=</span> <span class="n">catalog_dataset</span><span class="o">.</span><span class="n">merge_catalogs</span><span class="p">(</span><span class="n">max_distance_second</span> <span class="o">=</span> <span class="n">max_distance_second</span><span class="p">,</span> <span class="n">join_type</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">data_keys</span> <span class="o">=</span> <span class="n">magsky_key_all</span><span class="p">)</span>
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">merged_catalog</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="n">filter_1_key</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">filter</span>
        <span class="n">filter_2_key</span> <span class="o">=</span> <span class="n">comparison_catalog</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">filter</span>
        
        <span class="n">header</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span>
        
        <span class="k">for</span> <span class="n">magsky_key</span> <span class="ow">in</span> <span class="n">magsky_key_all</span><span class="p">:</span>
            <span class="n">slope_key_try1</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;K_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">intercept_key_try1</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">slope_key_try2</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;K_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">intercept_key_try2</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_COLOR_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">magsky_filter_1_key</span> <span class="o">=</span> <span class="n">magsky_key</span> <span class="o">+</span> <span class="s1">&#39;_idx0&#39;</span>
            <span class="n">magsky_filter_2_key</span> <span class="o">=</span> <span class="n">magsky_key</span> <span class="o">+</span> <span class="s1">&#39;_idx1&#39;</span>
            <span class="c1"># Calculate color term</span>
            <span class="k">if</span> <span class="n">slope_key_try1</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">intercept_key_try1</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">slope_key_try1</span><span class="p">]</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">intercept_key_try</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_filter_1_key</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_filter_2_key</span><span class="p">]</span>
                <span class="n">color_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">slope_key_try2</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">intercept_key_try2</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">slope_key_try2</span><span class="p">]</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">intercept_key_try2</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_filter_2_key</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_filter_1_key</span><span class="p">]</span>
                <span class="n">color_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filter_2_key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filter_1_key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] Color term keys &#39;</span><span class="si">{</span><span class="n">slope_key_try1</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">intercept_key_try1</span><span class="si">}</span><span class="s2">&#39; not found in FITS header.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">color_term</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
            <span class="c1"># Update target_catalog with color term</span>
            <span class="n">colorterm_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;CTERM_&#39;</span><span class="p">)</span>
            <span class="n">corrmag_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_CORR_MAGSKY_&#39;</span><span class="p">)</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">corrmag_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">magsky_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">color_term</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">colorterm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_term</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">color_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>    

        <span class="k">return</span> <span class="n">target_catalog</span>
            
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_mag_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">target_img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">],</span>
                        <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply magnitude term correction to target_catalog using values saved in the FITS header.</span>
<span class="sd">        Magnitude term equation: MAG_corrected = MAG + a*(MAG) + b</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_img : ScienceImage or ReferenceImage</span>
<span class="sd">            The target image to apply magnitude term corrections to.</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to apply magnitude term corrections to.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_catalog: Catalog</span>
<span class="sd">            The updated catalog with magnitude term corrections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
        
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">magsky_key_all</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">colnames</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span>

        <span class="k">for</span> <span class="n">magsky_key</span> <span class="ow">in</span> <span class="n">magsky_key_all</span><span class="p">:</span>
            <span class="n">slope_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;K_MAG_&#39;</span><span class="p">)</span>
            <span class="n">intercept_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;C_MAG_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slope_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="n">intercept_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] Color term keys &#39;</span><span class="si">{</span><span class="n">slope_key</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">intercept_key</span><span class="si">}</span><span class="s2">&#39; not found in FITS header.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Calculate mag term</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">slope_key</span><span class="p">]</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">intercept_key</span><span class="p">]</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_key</span><span class="p">]</span>
            <span class="n">mag_term</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
            <span class="c1"># Update target_catalog with mag term</span>
            <span class="n">magterm_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;MTERM_&#39;</span><span class="p">)</span>
            <span class="n">corrmag_key</span> <span class="o">=</span> <span class="n">magsky_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGSKY_&#39;</span><span class="p">,</span> <span class="s1">&#39;M_CORR_MAGSKY_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">magsky_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] &#39;</span><span class="si">{</span><span class="n">magsky_key</span><span class="si">}</span><span class="s2">&#39; not found in target catalog.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">corrmag_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magsky_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">mag_term</span>
            <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magterm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_term</span>
            
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">target_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">target_catalog</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                     <span class="n">mag_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">mag_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="c1">#snr_lower: float = 10,</span>
                     <span class="c1">#snr_upper: float = 300,</span>
                     <span class="n">classstar_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
                     <span class="n">elongation_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                     <span class="n">elongation_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                     <span class="n">fwhm_lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">fwhm_upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                     <span class="n">fwhm_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                     <span class="n">flag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">maskflag_upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">inner_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Fraction of the images</span>
                     <span class="n">isolation_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                     
                     <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     
                     <span class="n">magnitude_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">,</span>
                     <span class="n">fwhm_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">,</span>
                     <span class="n">x_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;X_IMAGE&#39;</span><span class="p">,</span>
                     <span class="n">y_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">,</span>
                     <span class="n">classstar_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CLASS_STAR&#39;</span><span class="p">,</span>
                     <span class="n">elongation_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ELONGATION&#39;</span><span class="p">,</span>
                     <span class="n">flag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">,</span>
                     <span class="n">maskflag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;IMAFLAGS_ISO&#39;</span><span class="p">,</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter stars by selecting the top N non-saturated, isolated, round, appropriately bright</span>
<span class="sd">        sources from each image grid cell (or globally if num_grids is None or 0).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The catalog to filter stars from.</span>
<span class="sd">        mag_lower : float, optional</span>
<span class="sd">            Minimum magnitude to select stars from.</span>
<span class="sd">        mag_upper : float, optional</span>
<span class="sd">            Maximum magnitude to select stars from.</span>
<span class="sd">        classstar_lower : float, optional</span>
<span class="sd">            Minimum CLASS_STAR to select stars from.</span>
<span class="sd">        elongation_upper : float, optional</span>
<span class="sd">            Maximum elongation to select stars from.</span>
<span class="sd">        elongation_sigma : float, optional</span>
<span class="sd">            Sigma of the elongation to select stars from.</span>
<span class="sd">        fwhm_lower : float, optional</span>
<span class="sd">            Minimum FWHM to select stars from.</span>
<span class="sd">        fwhm_upper : float, optional</span>
<span class="sd">            Maximum FWHM to select stars from.</span>
<span class="sd">        fwhm_sigma : float, optional</span>
<span class="sd">            Sigma of the FWHM to select stars from.</span>
<span class="sd">        flag_upper : int, optional</span>
<span class="sd">            Maximum flag to select stars from.</span>
<span class="sd">        maskflag_upper : int, optional</span>
<span class="sd">            Maximum mask flag to select stars from.</span>
<span class="sd">        inner_fraction : float, optional</span>
<span class="sd">            Fraction of the image to select stars from.</span>
<span class="sd">        isolation_radius : float, optional</span>
<span class="sd">            Isolation radius to select stars from.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the catalog.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the catalog.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the figure.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filtered_catalog: Catalog</span>
<span class="sd">            The filtered catalog with stars selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_catalog.data is None. Please provide a valid Catalog object with data.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fwhm_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">visualize</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">fwhm_key</span><span class="si">}</span><span class="s2">&#39; not found in target_catalog. Visualization disabled.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">magnitude_key</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">fwhm_key</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Star selection filtering&quot;</span><span class="p">)</span>
            
        <span class="k">def</span><span class="w"> </span><span class="nf">_plot_if_visualize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>  <span class="c1"># or pass `visualize` as a parameter</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;All sources&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span><span class="c1">#, c = sources[x_key])</span>
        <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initial sources: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filter_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)}</span>

        <span class="c1"># Step 0: FWHM cut: remove too small sources</span>
        <span class="k">if</span> <span class="n">fwhm_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">fwhm_key</span><span class="si">}</span><span class="s2">&#39; not found in target_catalog.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abs_fwhm_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fwhm_lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fwhm_upper</span><span class="p">)</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">abs_fwhm_mask</span><span class="p">]</span>
            
            <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_fwhm_abs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FWHM ABS CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed </span><span class="si">{</span><span class="n">fwhm_lower</span><span class="si">}</span><span class="s2"> &lt; FWHM &lt; </span><span class="si">{</span><span class="n">fwhm_upper</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_fwhm_abs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;FWHM(Asvolute) cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 1: Inner region cut</span>
        <span class="k">if</span> <span class="n">x_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">y_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">x_key</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">y_key</span><span class="si">}</span><span class="s2">&#39; not found in target_catalog.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span>
            <span class="n">y_vals</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">y_key</span><span class="p">]</span>

            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>

            <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">+</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">x_half_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">inner_fraction</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">y_half_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">inner_fraction</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="n">x_inner_min</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">x_half_range</span>
            <span class="n">x_inner_max</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">x_half_range</span>
            <span class="n">y_inner_min</span> <span class="o">=</span> <span class="n">y_center</span> <span class="o">-</span> <span class="n">y_half_range</span>
            <span class="n">y_inner_max</span> <span class="o">=</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">y_half_range</span>

            <span class="n">inner_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">x_vals</span> <span class="o">&gt;=</span> <span class="n">x_inner_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_vals</span> <span class="o">&lt;=</span> <span class="n">x_inner_max</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">y_vals</span> <span class="o">&gt;=</span> <span class="n">y_inner_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_vals</span> <span class="o">&lt;=</span> <span class="n">y_inner_max</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">inner_mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[INNERREGION CUT] </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> sources passed within X = [</span><span class="si">{</span><span class="n">x_inner_min</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">x_inner_max</span><span class="si">}</span><span class="s1">], Y = [</span><span class="si">{</span><span class="n">y_inner_min</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">y_inner_max</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_innerregion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
        
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;InnerRegion cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 2: Isolation</span>
        <span class="k">if</span> <span class="n">x_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">y_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">x_key</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">y_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step 1.1: Build KD-tree</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">y_key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query_ball_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">isolation_radius</span><span class="p">)</span>

            <span class="c1"># Step 1.2: Keep only isolated sources</span>
            <span class="n">isolated_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">nbrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">nbrs</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">])</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">isolated_mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[ISOLATION CUT] </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> sources passed with isolation radius </span><span class="si">{</span><span class="n">isolation_radius</span><span class="si">}</span><span class="s1"> pixels&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_isolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>

        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Isolation cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 3: MAG cut</span>
        <span class="k">if</span> <span class="n">magnitude_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">magnitude_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mag_lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mag_lower</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">mag_upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mag_upper</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">mag_lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mag_upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MAG CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed </span><span class="si">{</span><span class="n">mag_lower</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">magnitude_key</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">mag_upper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_magcut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
            
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;MAG cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 4: CLASS_STAR cut</span>
        <span class="k">if</span> <span class="n">classstar_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">classstar_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_star_mask</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">classstar_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">classstar_lower</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">class_star_mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CLASSSTAR CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed CLASS_STAR &gt; </span><span class="si">{</span><span class="n">classstar_lower</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_classstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
 
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;ClassStar cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 5: FWHM absolute and relative cut</span>
        <span class="k">if</span> <span class="n">fwhm_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">fwhm_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Stel 5.2: Relative cut: sigma-clipped sources</span>
            <span class="n">fwhm_values</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">]</span>
            <span class="n">fwhm_mean</span><span class="p">,</span> <span class="n">fwhm_median</span><span class="p">,</span> <span class="n">fwhm_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">fwhm_values</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fwhm_values</span> <span class="o">-</span> <span class="n">fwhm_median</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">fwhm_sigma</span> <span class="o">*</span> <span class="n">fwhm_std</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">clip_mask</span><span class="p">]</span>
            <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_fwhm_percentile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[FWHM CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed within ±</span><span class="si">{</span><span class="n">fwhm_sigma</span><span class="si">}</span><span class="s2"> sigma&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;around median (</span><span class="si">{</span><span class="n">fwhm_median</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">fwhm_std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">verbose</span>
            <span class="p">)</span> 
            
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;FWHM(Relative) cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Step 6: Elongation cut</span>
        <span class="k">if</span> <span class="n">elongation_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">elongation_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step 6.1: Absolute limit</span>
            <span class="n">elong_vals</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">elongation_key</span><span class="p">]</span>
            <span class="n">abs_elong_mask</span> <span class="o">=</span> <span class="n">elong_vals</span> <span class="o">&lt;</span> <span class="n">elongation_upper</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">abs_elong_mask</span><span class="p">]</span>
            <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_elong_abs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>

            <span class="c1"># Step 6.2: Sigma-clipping</span>
            <span class="n">elong_vals</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">elongation_key</span><span class="p">]</span>
            <span class="n">elong_mean</span><span class="p">,</span> <span class="n">elong_median</span><span class="p">,</span> <span class="n">elong_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">elong_vals</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">sigclip_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">elong_vals</span> <span class="o">-</span> <span class="n">elong_median</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">elongation_sigma</span> <span class="o">*</span> <span class="n">elong_std</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">sigclip_mask</span><span class="p">]</span>
            <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_elong_sigclip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ELONGATION CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> passed elongation &lt; </span><span class="si">{</span><span class="n">elongation_upper</span><span class="si">}</span><span class="s2"> and within ±</span><span class="si">{</span><span class="n">elongation_sigma</span><span class="si">}</span><span class="s2"> sigma of median (</span><span class="si">{</span><span class="n">elong_median</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">elong_std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Elongation cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Step 7: Flag cut</span>
        <span class="k">if</span> <span class="n">flag_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">flag_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag_mask</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">flag_key</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">flag_upper</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">flag_mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FLAG CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed FLAGS &lt;= </span><span class="si">{</span><span class="n">flag_upper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Flag cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Step 8: Mask flag cut</span>
        <span class="k">if</span> <span class="n">maskflag_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_catalog_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;</span><span class="si">{</span><span class="n">maskflag_key</span><span class="si">}</span><span class="s2">&#39; not found in sources.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maskflag_mask</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">maskflag_key</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">maskflag_upper</span>
            <span class="n">filtered_catalog_data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">maskflag_mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MASKFLAG CUT]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources passed IMAFLAGS_ISO &lt;= </span><span class="si">{</span><span class="n">maskflag_upper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;after_maskflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">)</span>
        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;brown&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;MaskFlag cut&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="n">_plot_if_visualize</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">],</span> <span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">],</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Final selected&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="n">seeing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">filtered_catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">])</span>
        <span class="n">filtered_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">refcatalogpath</span><span class="p">,</span> <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">filtered_catalog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">filtered_catalog_data</span>
        
        <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">seeing</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">seeing</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">valid_mag</span> <span class="o">=</span> <span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target_catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">])]</span>
            <span class="n">median_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_mag</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_mag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_mag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mag_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">median_mag</span> <span class="o">-</span> <span class="mi">9</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_mag</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">mag_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">median_mag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_mag</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">mag_min</span><span class="p">,</span> <span class="n">mag_max</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No valid data to set xlim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Warning: No valid magnitudes for setting xlim.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filtered_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Star selection plot saved to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">filtered_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">filtered_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Filtered catalog saved to </span><span class="si">{</span><span class="n">filtered_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">filtered_catalog</span><span class="p">,</span> <span class="n">filter_info</span><span class="p">,</span> <span class="n">seeing</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">determine_reference_mag_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">target_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">,</span>
                                      <span class="n">bin_width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                      <span class="n">sigma_clip</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                      <span class="n">magnitude_key</span><span class="o">=</span><span class="s1">&#39;MAG_AUTO&#39;</span><span class="p">,</span>
                                      <span class="n">zp_key</span><span class="o">=</span><span class="s1">&#39;ZP_AUTO&#39;</span><span class="p">,</span>
                                      <span class="n">fwhm_key</span><span class="o">=</span><span class="s1">&#39;FWHM_IMAGE&#39;</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">save_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the reference magnitude range for the target catalog.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_catalog : Catalog</span>
<span class="sd">            The target catalog to determine the reference magnitude range for.</span>
<span class="sd">        bin_width : float, optional</span>
<span class="sd">            The width of the magnitude bins.</span>
<span class="sd">        sigma_clip : float, optional</span>
<span class="sd">            The sigma to use for the sigma-clipping.</span>
<span class="sd">        magnitude_key : str, optional</span>
<span class="sd">            The key to use for the magnitude.</span>
<span class="sd">        zp_key : str, optional</span>
<span class="sd">            The key to use for the zeropoint.</span>
<span class="sd">        fwhm_key : str, optional</span>
<span class="sd">            The key to use for the FWHM.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        visualize : bool, optional</span>
<span class="sd">            Whether to visualize the reference magnitude range.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the figure.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mag_min : float</span>
<span class="sd">            The minimum magnitude of the reference magnitude range.</span>
<span class="sd">        mag_max : float</span>
<span class="sd">            The maximum magnitude of the reference magnitude range.</span>
<span class="sd">        zp : float</span>
<span class="sd">            The zeropoint of the reference magnitude range.</span>
<span class="sd">        zp_err : float</span>
<span class="sd">            The error of the zeropoint of the reference magnitude range.</span>
<span class="sd">        saturation_level : float</span>
<span class="sd">            The saturation level of the reference magnitude range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
        
        <span class="c1"># === ??? ?? ===</span>
        <span class="n">catalog_data</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">])</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog_data</span><span class="p">[</span><span class="n">zp_key</span><span class="p">])</span>
        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog_data</span><span class="p">[</span><span class="n">fwhm_key</span><span class="p">])</span>

        <span class="c1"># === Bin data ===</span>
        <span class="n">mag_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mags</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mags</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">)</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">med_zp</span><span class="p">,</span> <span class="n">std_zp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mag_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mags</span> <span class="o">&gt;=</span> <span class="n">mag_bins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mags</span> <span class="o">&lt;</span> <span class="n">mag_bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">clip_mean</span><span class="p">,</span> <span class="n">clip_median</span><span class="p">,</span> <span class="n">clip_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">zps</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">bin_centers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mag_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">mag_bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">med_zp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip_median</span><span class="p">)</span>
                <span class="n">std_zp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip_std</span><span class="p">)</span>

        <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span>
        <span class="n">med_zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">med_zp</span><span class="p">)</span>
        <span class="n">std_zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_zp</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough binned data to determine reference magnitude range.&quot;</span><span class="p">)</span>

        <span class="c1"># === LOWESS smoothing ===</span>
        <span class="n">smooth_zp</span> <span class="o">=</span> <span class="n">med_zp</span><span class="c1">#lowess(med_zp, bin_centers, frac=0.1, return_sorted=False)</span>
        <span class="n">smooth_zp_err</span> <span class="o">=</span> <span class="n">std_zp</span><span class="c1">#lowess(std_zp, bin_centers, frac=0.3, return_sorted=False)</span>
        <span class="n">zp_slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">smooth_zp</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">)</span>

        <span class="c1"># ???? ?? ?? ?? ?? (??? ??? ??)</span>
        <span class="n">mid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
        <span class="n">stable_slopes</span> <span class="o">=</span> <span class="n">zp_slope</span><span class="p">[</span><span class="n">mid_mask</span><span class="p">]</span>

        <span class="c1"># sigma-clipped stats? ??? ?? ??</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">slope_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">stable_slopes</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># slope_threshold ?? ?? (?: 3? ??)</span>
        <span class="n">slope_threshold</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">slope_std</span>
        
        <span class="n">_</span><span class="p">,</span> <span class="n">zp_value_first</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">med_zp</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">smooth_zp</span> <span class="o">-</span> <span class="n">zp_value_first</span><span class="p">))</span>
        
        <span class="c1"># === mag_min ??: ZP slope ===</span>
        <span class="n">mag_min</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">consecutive</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># faint ? bright ???? ??</span>
        <span class="n">saturation_level</span> <span class="o">=</span> <span class="mi">60000</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># start_idx?? ?? ??? ??</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zp_slope</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">slope_threshold</span><span class="p">:</span>
                <span class="n">consecutive</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">first_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
                    <span class="n">first_idx</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># ? ??? ??? ?? ?? ??</span>
                <span class="k">if</span> <span class="n">consecutive</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">mag_min</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">first_idx</span><span class="p">]</span>  <span class="c1"># ?? ??? ? ?? idx? mag_min ??</span>
                    <span class="n">saturated_sources</span> <span class="o">=</span> <span class="n">catalog_data</span><span class="p">[</span><span class="n">catalog_data</span><span class="p">[</span><span class="n">magnitude_key</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mag_min</span><span class="p">]</span>
                    <span class="n">saturated_sources_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturated_sources</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">saturated_sources_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">saturation_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">saturated_sources</span><span class="p">[</span><span class="s1">&#39;FLUX_MAX&#39;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saturation level: </span><span class="si">{</span><span class="n">saturation_level</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saturation detected (stable): mag_min = </span><span class="si">{</span><span class="n">mag_min</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consecutive</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">first_idx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ?? ?? ???</span>

        <span class="c1"># === mag_max ??: ZP_err ? ?? ===</span>
        <span class="c1"># ?? ???? baseline? ???? ??</span>
        <span class="n">mid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&gt;</span> <span class="n">mag_min</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>

        <span class="c1"># Sigma clipping to reject outliers</span>
        <span class="n">sigmaclip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">clipped_zp_err</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">(</span><span class="n">smooth_zp_err</span><span class="p">[</span><span class="n">mid_mask</span><span class="p">])</span>  <span class="c1"># Masked array after sigma clipping</span>

        <span class="c1"># Remove masked (outlier) values</span>
        <span class="n">valid_zp_err</span> <span class="o">=</span> <span class="n">clipped_zp_err</span><span class="p">[</span><span class="o">~</span><span class="n">clipped_zp_err</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">zp_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">valid_zp_err</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">err_threshold</span> <span class="o">=</span> <span class="n">zp_err</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">valid_zp_err</span><span class="p">)</span>

        <span class="c1"># ?? ????? faint ???? ??</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mid_mask</span><span class="p">)</span>  <span class="c1"># mid_mask?? ? True ??? (?? ???)</span>
        <span class="n">mag_max</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># ???: ?? faint</span>
        <span class="n">consecutive</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)):</span>  <span class="c1"># mid ? faint</span>
            <span class="k">if</span> <span class="n">smooth_zp_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">err_threshold</span><span class="p">:</span>
                <span class="n">consecutive</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">first_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">first_idx</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">consecutive</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># ?? 2? ?? ? mag_max ??</span>
                    <span class="n">mag_max</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">first_idx</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consecutive</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">first_idx</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># === ZP, ZP_err ?? ===</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&gt;=</span> <span class="n">mag_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">&lt;=</span> <span class="n">mag_max</span><span class="p">)</span>
        <span class="n">zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">med_zp</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>
        <span class="n">zp_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">std_zp</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] mag_min=</span><span class="si">{</span><span class="n">mag_min</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, mag_max=</span><span class="si">{</span><span class="n">mag_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, ZP=</span><span class="si">{</span><span class="n">zp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">zp_err</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># === Visualization ===</span>
        <span class="k">if</span> <span class="n">visualize</span> <span class="ow">or</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># ZP plot</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mags</span><span class="p">,</span> <span class="n">zps</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">fwhms</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">smooth_zp</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Smoothed ZP&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mag_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;mag_min=</span><span class="si">{</span><span class="n">mag_min</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mag_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;mag_max=</span><span class="si">{</span><span class="n">mag_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Zeropoint&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">zp</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

            <span class="c1"># ZP_err plot</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">smooth_zp_err</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZP Std (Err)&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">err_threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZP_err Threshold&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mag_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mag_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ZP Error&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">zp_err</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zp_err</span><span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_catalog</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.reference_mag.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mag_min</span><span class="p">,</span> <span class="n">mag_max</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">zp_err</span><span class="p">,</span> <span class="n">saturation_level</span></div>

        
<span class="c1"># %%</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataBrowser</span>
    <span class="c1"># from ezphot.utils import SDTDataQuerier</span>
    <span class="c1"># sdtdata = SDTDataQuerier()</span>
    <span class="c1"># sdtdata.sync_scidata(targetname = &#39;T08803&#39;)</span>
    <span class="n">databrowser</span> <span class="o">=</span> <span class="n">DataBrowser</span><span class="p">(</span><span class="s1">&#39;scidata&#39;</span><span class="p">)</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">observatory</span> <span class="o">=</span> <span class="s1">&#39;7DT&#39;</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">objname</span> <span class="o">=</span> <span class="s1">&#39;T22956&#39;</span>
    <span class="n">databrowser</span><span class="o">.</span><span class="n">telname</span> <span class="o">=</span> <span class="s1">&#39;7DT16&#39;</span>
    <span class="n">target_imgset</span> <span class="o">=</span> <span class="n">databrowser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;calib*100.fits&#39;</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;science&#39;</span><span class="p">)</span>
    <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imgset</span><span class="o">.</span><span class="n">target_images</span>
    <span class="n">target_img</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">bkgmap</span>
    <span class="n">target_bkgrms</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">bkgrms</span>
    <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">catalog</span>


    <span class="n">catalog_type</span> <span class="o">=</span> <span class="s1">&#39;GAIAXP&#39;</span>  <span class="c1"># str - Reference catalog type (&#39;GAIAXP&#39;, &#39;GAIA&#39;, &#39;PS1&#39;)</span>
    <span class="n">max_distance_second</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># float - Maximum matching distance in arcseconds</span>
    <span class="n">calculate_color_terms</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># bool - Whether to calculate color terms</span>
    <span class="n">calculate_mag_terms</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># bool - Whether to calculate magnitude terms</span>

    <span class="c1"># Star Selection Parameters</span>
    <span class="n">mag_lower</span> <span class="o">=</span> <span class="mi">13</span>  <span class="c1"># float - Lower magnitude limit</span>
    <span class="n">mag_upper</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># float - Upper magnitude limit</span>
    <span class="n">snr_lower</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># float - Lower SNR limit</span>
    <span class="n">snr_upper</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># float - Upper SNR limit</span>
    <span class="n">classstar_lower</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># float - Minimum CLASS_STAR value</span>
    <span class="n">elongation_upper</span> <span class="o">=</span> <span class="mf">1.7</span>  <span class="c1"># float - Maximum elongation</span>
    <span class="n">elongation_sigma</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># float - Sigma clipping for elongation</span>
    <span class="n">fwhm_lower</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># float - Lower FWHM limit in pixels</span>
    <span class="n">fwhm_upper</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># float - Upper FWHM limit in pixels</span>
    <span class="n">fwhm_sigma</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># float - Sigma clipping for FWHM</span>
    <span class="n">flag_upper</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># int - Maximum FLAGS value</span>
    <span class="n">maskflag_upper</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># int - Maximum IMAFLAGS_ISO value</span>
    <span class="n">inner_fraction</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># float - Fraction of image to use (inner region)</span>
    <span class="n">isolation_radius</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># float - Isolation radius in pixels</span>

    <span class="c1"># Column Name Parameters</span>
    <span class="n">magnitude_key</span> <span class="o">=</span> <span class="s1">&#39;MAG_AUTO&#39;</span>  <span class="c1"># str - Magnitude column name</span>
    <span class="n">fwhm_key</span> <span class="o">=</span> <span class="s1">&#39;FWHM_IMAGE&#39;</span>  <span class="c1"># str - FWHM column name</span>
    <span class="n">x_key</span> <span class="o">=</span> <span class="s1">&#39;X_IMAGE&#39;</span>  <span class="c1"># str - X coordinate column name</span>
    <span class="n">y_key</span> <span class="o">=</span> <span class="s1">&#39;Y_IMAGE&#39;</span>  <span class="c1"># str - Y coordinate column name</span>
    <span class="n">classstar_key</span> <span class="o">=</span> <span class="s1">&#39;CLASS_STAR&#39;</span>  <span class="c1"># str - CLASS_STAR column name</span>
    <span class="n">elongation_key</span> <span class="o">=</span> <span class="s1">&#39;ELONGATION&#39;</span>  <span class="c1"># str - Elongation column name</span>
    <span class="n">flag_key</span> <span class="o">=</span> <span class="s1">&#39;FLAGS&#39;</span>  <span class="c1"># str - FLAGS column name</span>
    <span class="n">maskflag_key</span> <span class="o">=</span> <span class="s1">&#39;IMAFLAGS_ISO&#39;</span>  <span class="c1"># str - Mask flags column name</span>

    <span class="c1"># Output Control Parameters</span>
    <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># bool - Whether to save results</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># bool - Whether to print verbose output</span>
    <span class="n">visualize</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># bool - Whether to show plots</span>
    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># bool - Whether to save plots</span>
    <span class="n">save_refcat</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># bool - Whether to save reference catalog</span>
    <span class="n">dynamic_mag_range</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">PhotometricCalibration</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">photometric_calibration</span><span class="p">(</span><span class="n">target_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="p">,</span>
                                 <span class="n">target_catalog</span> <span class="o">=</span> <span class="n">target_catalog</span><span class="p">,</span>
                                 <span class="n">catalog_type</span> <span class="o">=</span> <span class="n">catalog_type</span><span class="p">,</span>
                                 <span class="n">max_distance_second</span> <span class="o">=</span> <span class="n">max_distance_second</span><span class="p">,</span>
                                 <span class="n">calculate_color_terms</span> <span class="o">=</span> <span class="n">calculate_color_terms</span><span class="p">,</span>
                                 <span class="n">calculate_mag_terms</span> <span class="o">=</span> <span class="n">calculate_mag_terms</span><span class="p">,</span>
                                 <span class="n">mag_lower</span> <span class="o">=</span> <span class="n">mag_lower</span><span class="p">,</span>
                                 <span class="n">mag_upper</span> <span class="o">=</span> <span class="n">mag_upper</span><span class="p">,</span>
                                 <span class="n">dynamic_mag_range</span> <span class="o">=</span> <span class="n">dynamic_mag_range</span><span class="p">,</span>
                                 <span class="n">snr_lower</span> <span class="o">=</span> <span class="n">snr_lower</span><span class="p">,</span>
                                 <span class="n">snr_upper</span> <span class="o">=</span> <span class="n">snr_upper</span><span class="p">,</span>
                                 <span class="n">classstar_lower</span> <span class="o">=</span> <span class="n">classstar_lower</span><span class="p">,</span>
                                 <span class="n">elongation_upper</span> <span class="o">=</span> <span class="n">elongation_upper</span><span class="p">,</span>
                                 <span class="n">elongation_sigma</span> <span class="o">=</span> <span class="n">elongation_sigma</span><span class="p">,</span>
                                 <span class="n">fwhm_lower</span> <span class="o">=</span> <span class="n">fwhm_lower</span><span class="p">,</span>
                                 <span class="n">fwhm_upper</span> <span class="o">=</span> <span class="n">fwhm_upper</span><span class="p">,</span>
                                 <span class="n">fwhm_sigma</span> <span class="o">=</span> <span class="n">fwhm_sigma</span><span class="p">,</span>
                                 <span class="n">flag_upper</span> <span class="o">=</span> <span class="n">flag_upper</span><span class="p">,</span>
                                 <span class="n">maskflag_upper</span> <span class="o">=</span> <span class="n">maskflag_upper</span><span class="p">,</span>
                                 <span class="n">inner_fraction</span> <span class="o">=</span> <span class="n">inner_fraction</span><span class="p">,</span>
                                 <span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                 <span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">,</span>
                                 <span class="n">save_fig</span> <span class="o">=</span> <span class="n">save_fig</span><span class="p">,</span>
                                 <span class="n">save_refcat</span> <span class="o">=</span> <span class="n">save_refcat</span><span class="p">,</span>
                                 <span class="n">magnitude_key</span> <span class="o">=</span> <span class="n">magnitude_key</span><span class="p">,</span>
                                 <span class="n">fwhm_key</span> <span class="o">=</span> <span class="n">fwhm_key</span><span class="p">,</span>
                                 <span class="p">)</span>
    

                     <span class="c1"># %%</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hyeonho Choi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>