

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ezphot.methods.stack &mdash; ezphot 0.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=bbaf98b3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ezphot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imageobjects.html">Imageobjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dataobjects.html">DataObjects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ezphot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ezphot.methods.stack</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ezphot.methods.stack</h1><div class="highlight"><pre>
<span></span><span class="c1">#%%</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span><span class="n">Union</span><span class="p">,</span><span class="n">Optional</span><span class="p">,</span><span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bottleneck</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.contrib.concurrent</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_map</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.imageobjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScienceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">,</span> <span class="n">MasterImage</span><span class="p">,</span> <span class="n">ReferenceImage</span><span class="p">,</span> <span class="n">Errormap</span><span class="p">,</span> <span class="n">Background</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reproject</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ezphot.methods</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSFPhotometry</span>


<span class="k">def</span><span class="w"> </span><span class="nf">combine_patch</span><span class="p">(</span><span class="n">patch_tuple</span><span class="p">,</span> <span class="n">combine_method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">clip_method</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">nlow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhigh</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="p">(</span><span class="n">i_start</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">,</span> <span class="n">j_end</span><span class="p">,</span> <span class="n">tile_stack</span><span class="p">,</span> <span class="n">bkgrms_stack</span><span class="p">)</span> <span class="o">=</span> <span class="n">patch_tuple</span>

    <span class="k">if</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">bkgrms_stack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;combine_method=&#39;weight&#39; requires bkgrms_stack to be provided.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Clipping ---</span>
    <span class="k">if</span> <span class="n">clip_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">clip_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">tile_stack</span>
        <span class="n">clipped_rms</span> <span class="o">=</span> <span class="n">bkgrms_stack</span>
    <span class="k">elif</span> <span class="n">clip_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tile_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">tile_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tile_stack</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tile_stack</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">clipped_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">bkgrms_stack</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">clip_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;extrema&#39;</span><span class="p">:</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tile_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[</span><span class="n">nlow</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tile_stack</span><span class="p">)</span> <span class="o">-</span> <span class="n">nhigh</span><span class="p">]</span>

        <span class="c1"># Apply indices to both image and RMS</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">tile_stack</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bkgrms_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clipped_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">bkgrms_stack</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clipped_rms</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown clip_method: </span><span class="si">{</span><span class="n">clip_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># -- Combine image ---</span>
    <span class="k">if</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">clipped_rms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Weighted combination requires background RMS (clipped_rms).&quot;</span><span class="p">)</span>

        <span class="c1"># Compute weights as 1 / (rms^2), safely avoiding divide-by-zero</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clipped_rms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clipped_rms</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="c1"># Weighted average</span>
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">clipped</span> <span class="o">*</span> <span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">weight_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weighted_sum</span><span class="p">,</span> <span class="n">weight_total</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">weight_total</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">weight_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">clipped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">clipped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown combine_method: </span><span class="si">{</span><span class="n">combine_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># --- Combine RMS ---</span>
    <span class="k">if</span> <span class="n">clipped_rms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">clipped_rms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="c1"># Combine assuming uncorrelated noise: ?_combined = sqrt(sum ?_i^2) / N</span>
            <span class="n">combined_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">clipped_rms</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>

        <span class="k">elif</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted&#39;</span><span class="p">]:</span>
            <span class="c1"># Already computed weights in image combination block</span>
            <span class="c1"># combined_rms = sqrt(1 / sum w_i)</span>
            <span class="n">combined_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weight_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">weight_total</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">combine_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="c1"># Approximation for standard error of median: ?_combined ? 1.253 / sqrt(N) * median(?_i)</span>
            <span class="n">combined_rms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">clipped_rms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_rms</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">combined_rms</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">i_start</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">,</span> <span class="n">j_end</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">combined_rms</span>

<span class="c1"># Backgroud subtraction worker function</span>
<span class="n">bkg_handler</span> <span class="o">=</span> <span class="n">BackgroundGenerator</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_subtract_background_worker</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">target_img</span><span class="p">,</span> <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">bkg_handler</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
        <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
        <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scale_worker</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="n">target_img</span><span class="p">,</span> <span class="n">target_errormap</span><span class="p">,</span> <span class="n">ref_zp</span><span class="p">,</span> <span class="n">zp_key</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="n">args</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">zp_key</span><span class="p">])</span>
    <span class="n">delta_zp</span> <span class="o">=</span> <span class="n">ref_zp</span> <span class="o">-</span> <span class="n">zp</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_zp</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">target_img_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;scaled_</span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">target_errormap_path</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;scaled_</span><span class="si">{</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target_errormap</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_img_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
        <span class="n">target_errormap_path</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span> <span class="k">if</span> <span class="n">target_errormap</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Scale image</span>
    <span class="n">scaled_img</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_img</span><span class="p">)(</span><span class="n">path</span><span class="o">=</span><span class="n">target_img_path</span><span class="p">,</span> <span class="n">telinfo</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">scaled_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">scale_factor</span>
    <span class="n">scaled_img</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">scaled_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_zp</span>
    <span class="n">scaled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;SCLEKEY&#39;</span><span class="p">:</span> <span class="n">zp_key</span><span class="p">,</span>
        <span class="s1">&#39;SCLEREF&#39;</span><span class="p">:</span> <span class="n">ref_zp</span><span class="p">,</span>
        <span class="s1">&#39;SCLEZP&#39;</span><span class="p">:</span> <span class="n">delta_zp</span><span class="p">,</span>
        <span class="s1">&#39;SCLEFACT&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ZP_&#39;</span><span class="p">):</span>
            <span class="n">scaled_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_zp</span>
    <span class="n">scaled_img</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s1">&#39;ZPSCALE&#39;</span><span class="p">)</span>

    <span class="c1"># Scale error map</span>
    <span class="n">scaled_errormap</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">target_errormap</span><span class="p">:</span>
        <span class="n">emaptype</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">emaptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">emaptype</span> <span class="o">==</span> <span class="s1">&#39;bkgrms&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">scale_factor</span>
        <span class="k">elif</span> <span class="n">emaptype</span> <span class="o">==</span> <span class="s1">&#39;bkgweight&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported emaptype &#39;</span><span class="si">{</span><span class="n">emaptype</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">scaled_errormap</span> <span class="o">=</span> <span class="n">Errormap</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">target_errormap_path</span><span class="p">,</span> <span class="n">emaptype</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">emaptype</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">scaled_errormap</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="n">scaled_errormap</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;SCLEKEY&#39;</span><span class="p">:</span> <span class="n">zp_key</span><span class="p">,</span>
            <span class="s1">&#39;SCLEREF&#39;</span><span class="p">:</span> <span class="n">ref_zp</span><span class="p">,</span>
            <span class="s1">&#39;SCLEZP&#39;</span><span class="p">:</span> <span class="n">delta_zp</span><span class="p">,</span>
            <span class="s1">&#39;SCLEFACT&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">scaled_errormap</span><span class="o">.</span><span class="n">add_status</span><span class="p">(</span><span class="s1">&#39;zpscale&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">zp_key</span><span class="p">,</span> <span class="n">ref_zp</span><span class="o">=</span><span class="n">ref_zp</span><span class="p">,</span> <span class="n">scale_zp</span><span class="o">=</span><span class="n">delta_zp</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">scaled_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scaled_errormap</span><span class="p">:</span>
            <span class="n">scaled_errormap</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">scaled_img</span><span class="p">,</span> <span class="n">scaled_errormap</span>

<span class="n">projection_handler</span> <span class="o">=</span> <span class="n">Reproject</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_reproject_worker</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">target_img</span><span class="p">,</span> <span class="n">target_bkgrms</span><span class="p">,</span> <span class="n">resample_type</span><span class="p">,</span> <span class="n">center_ra</span><span class="p">,</span> <span class="n">center_dec</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">reprojected_img</span><span class="p">,</span> <span class="n">reprojected_bkgrms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">projection_handler</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span>
        <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
        <span class="n">target_errormap</span><span class="o">=</span><span class="n">target_bkgrms</span><span class="p">,</span>
        <span class="n">swarp_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resample_type</span><span class="o">=</span><span class="n">resample_type</span><span class="p">,</span>
        <span class="n">center_ra</span><span class="o">=</span><span class="n">center_ra</span><span class="p">,</span>
        <span class="n">center_dec</span><span class="o">=</span><span class="n">center_dec</span><span class="p">,</span>
        <span class="n">x_size</span><span class="o">=</span><span class="n">x_size</span><span class="p">,</span>
        <span class="n">y_size</span><span class="o">=</span><span class="n">y_size</span><span class="p">,</span>
        <span class="n">pixelscale</span><span class="o">=</span><span class="n">pixel_scale</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_ivpmask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">reprojected_img</span><span class="p">,</span> <span class="n">reprojected_bkgrms</span>

<span class="c1"># Wrapper to allow map-style multiprocessing with multiple args</span>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_wrapper</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">combine_patch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Combiner</span><span class="p">:</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="k">if</span> <span class="n">n_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n_proc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">close_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_image_stack_by_nproc</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">n_proc</span><span class="p">):</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_proc</span><span class="p">))</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_proc</span> <span class="o">+</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nx</span>
        <span class="n">x_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">y_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_splits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_splits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">i_start</span><span class="p">,</span> <span class="n">i_end</span> <span class="o">=</span> <span class="n">x_splits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_splits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">j_start</span><span class="p">,</span> <span class="n">j_end</span> <span class="o">=</span> <span class="n">y_splits</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">y_splits</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">tile_stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="n">i_start</span><span class="p">:</span><span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">:</span><span class="n">j_end</span><span class="p">]</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_start</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">,</span> <span class="n">j_end</span><span class="p">,</span> <span class="n">tile_stack</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">patches</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_images_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                <span class="n">image_list</span><span class="p">,</span> 
                                <span class="n">bkgrms_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">combine_method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                                <span class="n">clip_method</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
                                <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
                                <span class="n">nlow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">nhigh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Combiner] Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> images with combine=&#39;</span><span class="si">{</span><span class="n">combine_method</span><span class="si">}</span><span class="s2">&#39;, clip=&#39;</span><span class="si">{</span><span class="n">clip_method</span><span class="si">}</span><span class="s2">&#39;, using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span><span class="si">}</span><span class="s2"> processes&quot;</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span>
        <span class="n">bkgrms_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bkgrms_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">bkgrms_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">bkgrms_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">bkgrms_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">image_patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_image_stack_by_nproc</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span><span class="p">)</span>
        <span class="n">bkgrms_patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_image_stack_by_nproc</span><span class="p">(</span><span class="n">bkgrms_stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_proc</span><span class="p">)</span> <span class="k">if</span> <span class="n">bkgrms_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_patches</span><span class="p">)</span>

        <span class="n">patch_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">img_patch</span><span class="p">,</span> <span class="n">bkgrms_patch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_patches</span><span class="p">,</span> <span class="n">bkgrms_patches</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tile</span> <span class="o">=</span> <span class="n">img_patch</span>
            <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">bkgrms_patch</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">bkgrms_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">patch_args</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">bkgrms</span><span class="p">),</span> <span class="n">combine_method</span><span class="p">,</span> <span class="n">clip_method</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">nlow</span><span class="p">,</span> <span class="n">nhigh</span><span class="p">))</span>

        <span class="c1"># Use persistent pool if available</span>
        <span class="c1">#if self.pool is not None:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">worker_wrapper</span><span class="p">,</span> <span class="n">patch_args</span><span class="p">),</span>
                    <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_args</span><span class="p">),</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Combining...&quot;</span><span class="p">,</span>
                    <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">worker_wrapper</span><span class="p">,</span> <span class="n">patch_args</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # Fallback to temporary pool</span>
        <span class="c1">#     with Pool(processes=self.n_proc) as pool:</span>
        <span class="c1">#         results = list(</span>
        <span class="c1">#             tqdm(pool.imap_unordered(worker_wrapper, patch_args),</span>
        <span class="c1">#                  total=len(patch_args),</span>
        <span class="c1">#                  desc=&quot;Combining...&quot;,</span>
        <span class="c1">#                  ncols=80,</span>
        <span class="c1">#                  bar_format=&quot;{l_bar}{bar}| {elapsed}&quot;) if verbose else pool.imap_unordered(worker_wrapper, patch_args)</span>
        <span class="c1">#         )</span>

        <span class="k">for</span> <span class="n">i_start</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">,</span> <span class="n">j_end</span><span class="p">,</span> <span class="n">patch_result</span><span class="p">,</span> <span class="n">patch_bkgrms</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">combined</span><span class="p">[</span><span class="n">i_start</span><span class="p">:</span><span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">:</span><span class="n">j_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_result</span>
            <span class="k">if</span> <span class="n">bkgrms_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patch_bkgrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bkgrms_out</span><span class="p">[</span><span class="n">i_start</span><span class="p">:</span><span class="n">i_end</span><span class="p">,</span> <span class="n">j_start</span><span class="p">:</span><span class="n">j_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_bkgrms</span>

        <span class="k">return</span> <span class="n">combined</span><span class="p">,</span> <span class="n">bkgrms_out</span>


<div class="viewcode-block" id="Stack">
<a class="viewcode-back" href="../../../api/stack.html#ezphot.methods.stack.Stack">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Stack</span><span class="p">:</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">BackgroundGenerator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psfphot</span>    <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">stack_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">target_imglist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">CalibrationImage</span><span class="p">]],</span>
                           <span class="n">target_bkglist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Background</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">target_bkgrmslist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">target_outpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">bkgrms_outpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">combine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
                           <span class="n">n_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                           
                           <span class="c1"># Clip parameters</span>
                           <span class="n">clip_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                           <span class="n">nlow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">nhigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                           
                           <span class="c1"># Resample parameters</span>
                           <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">resample_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;LANCZOS3&#39;</span><span class="p">,</span>
                           <span class="n">center_ra</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">center_dec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">pixel_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">x_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">y_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           
                           <span class="c1"># Scale parameters</span>
                           <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">scale_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span>
                           <span class="n">zp_key</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ZP_APER_1&#39;</span><span class="p">,</span>
                            
                           <span class="c1"># Convolution parameters</span>
                           <span class="n">convolve</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">seeing_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span>
                           <span class="n">kernel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                           
                           <span class="c1"># Other parameters</span>
                           <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stack a list of images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[ScienceImage] or List[CalibrationImage]</span>
<span class="sd">            The list of images to stack.</span>
<span class="sd">        target_bkglist : List[Background], optional</span>
<span class="sd">            The list of backgrounds to subtract from the images.</span>
<span class="sd">        target_bkgrmslist : List[Errormap], optional</span>
<span class="sd">            The list of background RMS maps to use for the stacking.</span>
<span class="sd">        target_outpath : str, optional</span>
<span class="sd">            The path to save the stacked image.</span>
<span class="sd">        bkgrms_outpath : str, optional</span>
<span class="sd">            The path to save the background RMS map.</span>
<span class="sd">        combine_type : str, optional</span>
<span class="sd">            The type of combination to use for the stacking.</span>
<span class="sd">        n_proc : int, optional</span>
<span class="sd">            The number of processes to use for the stacking.</span>
<span class="sd">        clip_type : str, optional</span>
<span class="sd">            The type of clipping to use for the stacking. [sigma, extrema]</span>
<span class="sd">        sigma : float, optional</span>
<span class="sd">            The sigma for the clipping.</span>
<span class="sd">        nlow : int, optional</span>
<span class="sd">            The number of low values to clip.</span>
<span class="sd">        nhigh : int, optional</span>
<span class="sd">            The number of high values to clip.</span>
<span class="sd">        resample : bool, optional</span>
<span class="sd">            Whether to resample the images.</span>
<span class="sd">        resample_type : str, optional</span>
<span class="sd">            The type of resampling to use for the stacking in SWArp configuration. [&#39;NEAREST&#39;, &#39;BILINEAR&#39;, &#39;BICUBIC&#39;, &#39;LANCZOS3&#39;, etc.]</span>
<span class="sd">        center_ra : float, optional</span>
<span class="sd">            The RA of the center of the stacked image.</span>
<span class="sd">        center_dec : float, optional</span>
<span class="sd">            The Dec of the center of the stacked image.</span>
<span class="sd">        pixel_scale : float, optional</span>
<span class="sd">            The pixel scale of the stacked image.</span>
<span class="sd">        x_size : int, optional</span>
<span class="sd">            The size of the stacked image in the x-direction.</span>
<span class="sd">        y_size : int, optional</span>
<span class="sd">            The size of the stacked image in the y-direction.</span>
<span class="sd">        scale : bool, optional</span>
<span class="sd">            Whether to scale the images.</span>
<span class="sd">        scale_type : str, optional</span>
<span class="sd">            The type of scaling to use for the stacking. [&#39;min&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;max&#39;]</span>
<span class="sd">        zp_key : str, optional</span>
<span class="sd">            The key to use for the zero point.</span>
<span class="sd">        convolve : bool, optional</span>
<span class="sd">            Whether to convolve the images.</span>
<span class="sd">        seeing_key : str, optional</span>
<span class="sd">            The key to use for the seeing.</span>
<span class="sd">        kernel : str, optional</span>
<span class="sd">            The kernel to use for the convolution. [&#39;gaussian&#39;, &#39;image&#39;]</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            Whether to save the stacked image.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_img : ScienceImage</span>
<span class="sd">            The stacked image.</span>
<span class="sd">        target_bkgrms : Errormap    </span>
<span class="sd">            The stacked background RMS map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">n_proc</span> <span class="o">!=</span> <span class="n">n_proc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;[Combiner] Re-initializing Combiner with new n_proc&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">close_pool</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
        
        <span class="c1"># Define output paths if not provided</span>
        <span class="k">if</span> <span class="n">target_outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.com.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bkgrms_outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.com.fits&#39;</span> <span class="o">+</span> <span class="n">target_bkgrmslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">suffix</span> 
            <span class="n">bkgrms_outpath</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> 
        
        <span class="n">subbkg_imglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">target_bkglist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_bkglist</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of target_imglist and target_bkglist must be the same.&quot;</span><span class="p">)</span>
        
            <span class="n">input_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">img</span><span class="p">,</span> <span class="n">bkg</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">bkg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkglist</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">process_map</span><span class="p">(</span><span class="n">_subtract_background_worker</span><span class="p">,</span> <span class="n">input_list</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Subtracting background...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_subtract_background_worker</span><span class="p">,</span> <span class="n">input_list</span><span class="p">)</span>

            <span class="c1"># Clean up memory</span>
            <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">for</span> <span class="n">target_bkg</span> <span class="ow">in</span> <span class="n">target_bkglist</span><span class="p">:</span>
                <span class="n">target_bkg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="n">subbkg_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                         
        <span class="c1"># Zero-point scaling</span>
        <span class="n">scaled_imglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scaled_bkgrmslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkgrmslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_zeropoints</span><span class="p">(</span>
                <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">,</span>
                <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span><span class="p">,</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">scale_type</span><span class="p">,</span>
                <span class="n">zp_key</span> <span class="o">=</span> <span class="n">zp_key</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                <span class="n">n_proc</span> <span class="o">=</span> <span class="n">n_proc</span>
            <span class="p">)</span>
            
            <span class="c1"># Clean up memory</span>
            <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target_bkgrms</span> <span class="ow">in</span> <span class="n">target_bkgrmslist</span><span class="p">:</span>
                    <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="n">scaled_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">scaled_bkgrmslist</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            
        <span class="c1"># Convolution</span>
        <span class="n">convolved_imglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">convolved_bkgrmslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">convolve</span><span class="p">:</span>
            <span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkgrmslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_seeing</span><span class="p">(</span>
                <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">,</span>
                <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span><span class="p">,</span>
                <span class="n">seeing_key</span> <span class="o">=</span> <span class="n">seeing_key</span><span class="p">,</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="p">)</span>
            
            <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target_bkgrms</span> <span class="ow">in</span> <span class="n">target_bkgrmslist</span><span class="p">:</span>
                    <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>   
            
            <span class="n">convolved_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">convolved_bkgrmslist</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            
        <span class="n">coadd_imglist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">coadd_bkgrmslist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="n">task_args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bkgrms</span><span class="p">,</span> <span class="n">resample_type</span><span class="p">,</span> <span class="n">center_ra</span><span class="p">,</span> <span class="n">center_dec</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">bkgrms</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkgrmslist</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">))</span>
            <span class="p">]</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">process_map</span><span class="p">(</span><span class="n">_reproject_worker</span><span class="p">,</span> <span class="n">task_args</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Performing image reprojection...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_reproject_worker</span><span class="p">,</span> <span class="n">task_args</span><span class="p">)</span>
            
            <span class="n">coadd_imglist</span><span class="p">,</span> <span class="n">coadd_bkgrmslist</span> <span class="o">=</span>  <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coadd_bkgrmslist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">coadd_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span>
            <span class="n">coadd_bkgrmslist</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span>
              
        <span class="c1"># Load target images and error maps ---</span>
        <span class="n">image_datalist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_hdrlist</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">coadd_imglist</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading target images...&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">coadd_imglist</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">image_datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">image_hdrlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="n">bkgrms_datalist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">coadd_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bkgrms_datalist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">coadd_bkgrmslist</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading target bkgrms maps...&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">coadd_bkgrmslist</span>
            <span class="k">for</span> <span class="n">target_bkgrms</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="n">bkgrms_datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_bkgrms</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Remove original target images and error maps</span>
        <span class="k">for</span> <span class="n">target_imglist</span> <span class="ow">in</span> <span class="p">[</span><span class="n">subbkg_imglist</span><span class="p">,</span> <span class="n">scaled_imglist</span><span class="p">,</span> <span class="n">convolved_imglist</span><span class="p">,</span> <span class="n">coadd_imglist</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">target_imglist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
                    <span class="n">target_img</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                    
        <span class="k">for</span> <span class="n">target_bkgrmslist</span> <span class="ow">in</span> <span class="p">[</span><span class="n">scaled_bkgrmslist</span><span class="p">,</span> <span class="n">convolved_bkgrmslist</span><span class="p">,</span> <span class="n">coadd_bkgrmslist</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">target_bkgrmslist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target_bkgrms</span> <span class="ow">in</span> <span class="n">target_bkgrmslist</span><span class="p">:</span>
                    <span class="n">target_bkgrms</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
        <span class="c1"># Combine the image stack</span>
        <span class="k">if</span> <span class="n">clip_type</span> <span class="ow">is</span> <span class="s1">&#39;extrema&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_datalist</span><span class="p">)</span> <span class="o">-</span> <span class="n">nlow</span> <span class="o">-</span> <span class="n">nhigh</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Combiner] Not enough images to clip: (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_datalist</span><span class="p">)</span><span class="si">}</span><span class="s2">). Clip type is set as None&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">clip_type</span> <span class="o">=</span> <span class="kc">None</span>
                
        <span class="n">combined_data</span><span class="p">,</span> <span class="n">combined_bkgrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">combine_images_parallel</span><span class="p">(</span>
            <span class="n">image_list</span><span class="o">=</span><span class="n">image_datalist</span><span class="p">,</span>
            <span class="n">bkgrms_list</span> <span class="o">=</span> <span class="n">bkgrms_datalist</span><span class="p">,</span>
            <span class="n">combine_method</span><span class="o">=</span><span class="n">combine_type</span><span class="p">,</span>
            <span class="n">clip_method</span><span class="o">=</span><span class="n">clip_type</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
            <span class="n">nlow</span><span class="o">=</span><span class="n">nlow</span><span class="p">,</span>
            <span class="n">nhigh</span><span class="o">=</span><span class="n">nhigh</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="c1"># Initialize combined header </span>
        <span class="n">combined_header</span> <span class="o">=</span> <span class="n">image_hdrlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Update header keywords with mean</span>
        <span class="n">update_header_keywords_mean</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ALTITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;AZIMUTH&#39;</span><span class="p">,</span> <span class="s1">&#39;CENTALT&#39;</span><span class="p">,</span> <span class="s1">&#39;CENTAZ&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;AIRMASS&#39;</span><span class="p">,</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span> <span class="s1">&#39;PEEING&#39;</span><span class="p">,</span> <span class="s1">&#39;ELLIP&#39;</span><span class="p">,</span> <span class="s1">&#39;SKYVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;JD&#39;</span><span class="p">,</span> <span class="s1">&#39;MJD&#39;</span><span class="p">,</span> <span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">update_header_keywords_mean</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">combined_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Handle non-numeric or incompatible values</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">):</span>
            <span class="n">combined_header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;COMBIM</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">jd</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
        <span class="n">combined_header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">jd</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
        <span class="n">combined_header</span><span class="p">[</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iso</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">update_header_keywords_sum</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPOSURE&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">update_header_keywords_sum</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">combined_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            
        <span class="c1"># Remove unwanted header keywords</span>
        <span class="n">update_header_keywords_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IMAGEID&#39;</span><span class="p">,</span> <span class="s1">&#39;NOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAG_*&#39;</span><span class="p">,</span> <span class="s1">&#39;ZP*&#39;</span><span class="p">,</span> <span class="s1">&#39;UL*&#39;</span><span class="p">,</span> <span class="s1">&#39;EZP*&#39;</span><span class="p">,</span> <span class="s1">&#39;APER*&#39;</span><span class="p">,</span> <span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">update_header_keywords_remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>
                <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">combined_header</span> <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">combined_header</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">combined_header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># Save combined image</span>
        <span class="c1"># If CalibrationImage is input, Save it as MasterImage. This will be saved in the master_frame directory.</span>
        <span class="c1"># Else, save it in the target_outpath.</span>
        <span class="n">stack_instance</span> <span class="o">=</span>  <span class="nb">type</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_outpath</span><span class="p">,</span> <span class="n">telinfo</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">stack_instance</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">combined_data</span>
        <span class="n">stack_instance</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">combined_header</span>
        <span class="n">stack_instance</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">process_name</span> <span class="o">=</span> <span class="s1">&#39;STACK&#39;</span><span class="p">)</span>
        
        <span class="n">stack_bkgrms_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">target_bkgrmslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stack_bkgrms_instance</span> <span class="o">=</span> <span class="n">Errormap</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">bkgrms_outpath</span><span class="p">,</span> <span class="n">emaptype</span> <span class="o">=</span> <span class="s1">&#39;bkgrms&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">target_bkgrmslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">stack_bkgrms_instance</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">combined_bkgrms</span>
            <span class="n">stack_bkgrms_instance</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">combined_header</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">stack_bkgrms_instance</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> <span class="k">if</span> <span class="n">stack_bkgrms_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">close_pool</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stack_instance</span><span class="p">,</span> <span class="n">stack_bkgrms_instance</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">stack_swarp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">target_imglist</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">CalibrationImage</span><span class="p">]],</span>
                    <span class="n">target_bkglist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Background</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">target_errormaplist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">target_outpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">errormap_outpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">combine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="c1"># median, weighted, mean, sum, min, max</span>
                    
                    <span class="c1"># Resample parameters</span>
                    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">resample_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;LANCZOS3&#39;</span><span class="p">,</span>
                    <span class="n">center_ra</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">center_dec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">pixel_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">y_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    
                    <span class="c1"># Scale parameters</span>
                    <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">scale_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span>
                    <span class="n">zp_key</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ZP_APER_1&#39;</span><span class="p">,</span>
                    
                    <span class="c1"># Convolution parameters</span>
                    <span class="n">convolve</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">seeing_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                    
                    <span class="c1"># Other parameters</span>
                    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stack multiple images using SWArp.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[Union[ScienceImage, CalibrationImage]]</span>
<span class="sd">            List of images to stack</span>
<span class="sd">        target_bkglist : Optional[List[Background]]</span>
<span class="sd">            Optional list of background maps to stack</span>
<span class="sd">        target_errormaplist : Optional[List[Errormap]]</span>
<span class="sd">            Optional list of error maps to stack</span>
<span class="sd">        target_outpath : str</span>
<span class="sd">            Path to save the stacked image</span>
<span class="sd">        errormap_outpath : str</span>
<span class="sd">            Path to save the stacked error map</span>
<span class="sd">        combine_type : str</span>
<span class="sd">            Method to combine images (&#39;median&#39;, &#39;weighted&#39;, &#39;mean&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;)</span>
<span class="sd">        resample : bool</span>
<span class="sd">            Whether to resample the images</span>
<span class="sd">        resample_type : str</span>
<span class="sd">            Type of resampling to use (&#39;NEAREST&#39;, &#39;BILINEAR&#39;, &#39;BICUBIC&#39;, &#39;LANCZOS3&#39;, etc.)</span>
<span class="sd">        center_ra : float</span>
<span class="sd">            RA of the center of the stacked image</span>
<span class="sd">        center_dec : float</span>
<span class="sd">            Dec of the center of the stacked image</span>
<span class="sd">        pixel_scale : float</span>
<span class="sd">            Pixel scale of the stacked image</span>
<span class="sd">        x_size : int</span>
<span class="sd">            Size of the stacked image in pixels</span>
<span class="sd">        y_size : int</span>
<span class="sd">            Size of the stacked image in pixels</span>
<span class="sd">        scale : bool</span>
<span class="sd">            Whether to scale the images</span>
<span class="sd">        scale_type : str</span>
<span class="sd">            Method to scale images (&#39;min&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;max&#39;)</span>
<span class="sd">        zp_key : str</span>
<span class="sd">            Header keyword for zero point</span>
<span class="sd">        convolve : bool</span>
<span class="sd">            Whether to convolve the images</span>
<span class="sd">        seeing_key : str</span>
<span class="sd">            Header keyword for seeing/FWHM in pixel units</span>
<span class="sd">        kernel : str</span>
<span class="sd">            Convolution kernel type (&#39;gaussian&#39;)</span>
<span class="sd">        save : bool</span>
<span class="sd">            Whether to save the stacked image and error map</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Print progress messages</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (stack_instance, stack_weight_instance) : Tuple[Union[ScienceImage, CalibrationImage], Optional[Errormap]]</span>
<span class="sd">            Stacked image and optionally its weight map</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Set default output paths if not provided</span>
        <span class="k">if</span> <span class="n">target_outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">combinepath</span>
        
        <span class="n">errormap_outpath</span> <span class="o">=</span> <span class="n">target_outpath</span> <span class="o">+</span> <span class="s1">&#39;.weight&#39;</span>
        
        <span class="c1"># Set temporary output paths</span>
        <span class="n">target_outpath_tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_outpath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>

        <span class="c1"># Subtract background </span>
        <span class="k">if</span> <span class="n">target_bkglist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_bkglist</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of target_imglist and target_bkglist must be the same.&quot;</span><span class="p">)</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkglist</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Subtracting background...&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_bkglist</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">target_img</span><span class="p">,</span> <span class="n">target_bkg</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="n">target_imglist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span>
                    <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                    <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
                    <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Image scaling</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_zeropoints</span><span class="p">(</span>
                <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">,</span>
                <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="n">target_errormaplist</span><span class="p">,</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">scale_type</span><span class="p">,</span>
                <span class="n">zp_key</span> <span class="o">=</span> <span class="n">zp_key</span><span class="p">,</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="p">)</span>
            
        <span class="c1"># Image convolution</span>
        <span class="k">if</span> <span class="n">convolve</span><span class="p">:</span>
            <span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_seeing</span><span class="p">(</span>
                <span class="n">target_imglist</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">,</span>
                <span class="n">target_errormaplist</span> <span class="o">=</span> <span class="n">target_errormaplist</span><span class="p">,</span>
                <span class="n">seeing_key</span> <span class="o">=</span> <span class="n">seeing_key</span><span class="p">,</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">,</span>
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="p">)</span>

        <span class="c1"># Loading the images</span>
        <span class="n">image_pathlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_hdrlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remove_image</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading target images...&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">target_imglist</span>
        <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_img</span><span class="o">.</span><span class="n">is_exists</span><span class="p">:</span>
                <span class="n">target_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="n">remove_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remove_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">image_pathlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">image_hdrlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            
        <span class="n">weight_pathlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">remove_errormap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">target_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_pathlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_errormaplist</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading target weight maps...&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">target_errormaplist</span>
            <span class="k">for</span> <span class="n">target_errormap</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">emaptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span>
                    <span class="n">target_errormap</span><span class="o">.</span><span class="n">to_weight</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">is_exists</span><span class="p">:</span>
                        <span class="n">target_errormap</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                        <span class="n">remove_errormap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remove_errormap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">is_exists</span><span class="p">:</span>
                        <span class="n">target_errormap</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                        <span class="n">remove_errormap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remove_errormap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    
                <span class="n">weight_pathlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                
        <span class="c1"># Header modification</span>
        <span class="n">combined_header</span> <span class="o">=</span> <span class="n">image_hdrlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- Update header keywords with mean ---</span>
        <span class="n">update_header_keywords_mean</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ALTITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;AZIMUTH&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;AIRMASS&#39;</span><span class="p">,</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span> <span class="s1">&#39;PEEING&#39;</span><span class="p">,</span> <span class="s1">&#39;ELLIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ELONG&#39;</span><span class="p">,</span> <span class="s1">&#39;SKYVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;JD&#39;</span><span class="p">,</span> <span class="s1">&#39;MJD&#39;</span><span class="p">,</span> <span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">update_header_keywords_mean</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">combined_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Handle non-numeric or incompatible values</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">):</span>
            <span class="n">combined_header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;COMBIM</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span>
            
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">jd</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
        <span class="n">combined_header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">jd</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">image_hdrlist</span> <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
        <span class="n">combined_header</span><span class="p">[</span><span class="s1">&#39;DATE-LOC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iso</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># --- Remove unwanted header keywords ---</span>
        <span class="n">update_header_keywords_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IMAGEID&#39;</span><span class="p">,</span> <span class="s1">&#39;NOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAG_*&#39;</span><span class="p">,</span> <span class="s1">&#39;ZP*&#39;</span><span class="p">,</span> <span class="s1">&#39;UL*&#39;</span><span class="p">,</span> <span class="s1">&#39;EZP*&#39;</span><span class="p">,</span> <span class="s1">&#39;APER*&#39;</span><span class="p">,</span> <span class="s1">&#39;SKYSIG&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">update_header_keywords_remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>
                <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">combined_header</span> <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">combined_header</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">combined_header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># Image combine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start image combining...&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">imagestack_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">weightstack_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Run swarp </span>
        <span class="n">stack_pathlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">run_swarp</span><span class="p">(</span>
            <span class="n">target_path</span> <span class="o">=</span> <span class="n">image_pathlist</span><span class="p">,</span>
            <span class="n">swarp_configfile</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SWARP_CONFIG&#39;</span><span class="p">],</span>
            <span class="n">swarp_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">target_outpath</span><span class="p">,</span>
            <span class="n">weight_inpath</span> <span class="o">=</span> <span class="n">weight_pathlist</span><span class="p">,</span>
            <span class="n">weight_outpath</span> <span class="o">=</span> <span class="n">errormap_outpath</span><span class="p">,</span>
            <span class="n">weight_type</span> <span class="o">=</span> <span class="s1">&#39;MAP_WEIGHT&#39;</span><span class="p">,</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">,</span>
            <span class="n">resample_type</span> <span class="o">=</span> <span class="n">resample_type</span><span class="p">,</span>
            <span class="n">center_ra</span> <span class="o">=</span> <span class="n">center_ra</span><span class="p">,</span>
            <span class="n">center_dec</span> <span class="o">=</span> <span class="n">center_dec</span><span class="p">,</span>
            <span class="n">x_size</span> <span class="o">=</span> <span class="n">x_size</span><span class="p">,</span>
            <span class="n">y_size</span> <span class="o">=</span> <span class="n">y_size</span><span class="p">,</span>
            <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">),</span>
            <span class="n">combine</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">combine_type</span> <span class="o">=</span> <span class="n">combine_type</span><span class="p">,</span>
            <span class="n">subbkg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">imagestack_path</span><span class="p">,</span> <span class="n">weightstack_path</span> <span class="o">=</span> <span class="n">stack_pathlist</span>
            
        <span class="c1"># If errormaplist is provided, run swarp for error maps (NEAREST resampling)</span>
        <span class="k">if</span> <span class="n">target_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start weight combining...&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">stack_pathlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">run_swarp</span><span class="p">(</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">image_pathlist</span><span class="p">,</span>
                <span class="n">swarp_configfile</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SWARP_CONFIG&#39;</span><span class="p">],</span>
                <span class="n">swarp_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">target_outpath</span> <span class="o">=</span> <span class="n">target_outpath_tmp</span><span class="p">,</span>
                <span class="n">weight_inpath</span> <span class="o">=</span> <span class="n">weight_pathlist</span><span class="p">,</span>
                <span class="n">weight_outpath</span> <span class="o">=</span> <span class="n">errormap_outpath</span><span class="p">,</span>
                <span class="n">weight_type</span> <span class="o">=</span> <span class="s1">&#39;MAP_WEIGHT&#39;</span><span class="p">,</span>
                <span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">,</span>
                <span class="n">resample_type</span> <span class="o">=</span> <span class="s1">&#39;NEAREST&#39;</span><span class="p">,</span>
                <span class="n">center_ra</span> <span class="o">=</span> <span class="n">center_ra</span><span class="p">,</span>
                <span class="n">center_dec</span> <span class="o">=</span> <span class="n">center_dec</span><span class="p">,</span>
                <span class="n">x_size</span> <span class="o">=</span> <span class="n">x_size</span><span class="p">,</span>
                <span class="n">y_size</span> <span class="o">=</span> <span class="n">y_size</span><span class="p">,</span>
                <span class="n">pixelscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">),</span>
                <span class="n">combine</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">combine_type</span> <span class="o">=</span> <span class="n">combine_type</span><span class="p">,</span>
                <span class="n">subbkg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">imagestack_tmppath</span><span class="p">,</span> <span class="n">weightstack_path</span> <span class="o">=</span> <span class="n">stack_pathlist</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">imagestack_tmppath</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">CalibrationImage</span><span class="p">:</span>
            <span class="n">stack_instance</span> <span class="o">=</span> <span class="n">MasterImage</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_outpath</span><span class="p">,</span> <span class="n">telinfo</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">merge_header</span><span class="p">(</span><span class="n">stack_instance</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">combined_header</span><span class="p">,</span> <span class="n">exclude_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PV*&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_instance</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">path</span> <span class="o">=</span> <span class="n">imagestack_path</span><span class="p">,</span> <span class="n">telinfo</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">merge_header</span><span class="p">(</span><span class="n">stack_instance</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">combined_header</span><span class="p">,</span> <span class="n">exclude_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PV*&#39;</span><span class="p">])</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">process_name</span> <span class="o">=</span> <span class="s1">&#39;STACK&#39;</span><span class="p">)</span>

        <span class="n">stack_weight_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stack_weight_instance</span> <span class="o">=</span> <span class="n">Errormap</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">weightstack_path</span><span class="p">,</span> <span class="n">emaptype</span> <span class="o">=</span> <span class="s1">&#39;bkgweight&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">merge_header</span><span class="p">(</span><span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">combined_header</span><span class="p">,</span> <span class="n">exclude_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PV*&#39;</span><span class="p">])</span>
        <span class="n">event_details_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">stack_type</span> <span class="o">=</span> <span class="s1">&#39;SWARP&#39;</span><span class="p">,</span>
            <span class="n">combine_type</span> <span class="o">=</span> <span class="n">combine_type</span><span class="p">,</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">,</span>
            <span class="n">resample_type</span> <span class="o">=</span> <span class="n">resample_type</span><span class="p">,</span>
            <span class="n">ncombine</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">add_status</span><span class="p">(</span><span class="s1">&#39;stack_swarp&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">event_details_kwargs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> <span class="k">if</span> <span class="n">stack_weight_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked image saved to </span><span class="si">{</span><span class="n">stack_instance</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked weight map saved to </span><span class="si">{</span><span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">stack_instance</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="n">stack_weight_instance</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> <span class="k">if</span> <span class="n">stack_weight_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">remove_errormap</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">remove_key</span><span class="p">,</span> <span class="n">target_errormap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">remove_errormap</span><span class="p">,</span> <span class="n">target_errormaplist</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">remove_key</span><span class="p">:</span>
                    <span class="n">target_errormap</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">remove_image</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">remove_key</span><span class="p">,</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">remove_image</span><span class="p">,</span> <span class="n">target_imglist</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">remove_key</span><span class="p">:</span>
                    <span class="n">target_img</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
        <span class="k">return</span> <span class="n">stack_instance</span><span class="p">,</span> <span class="n">stack_weight_instance</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">select_quality_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                              <span class="n">target_imglist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ReferenceImage</span><span class="p">]],</span>
                              <span class="n">min_obsdate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Time</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">max_obsdate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Time</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">seeing_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span>
                              <span class="n">depth_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;UL5_APER_1&#39;</span><span class="p">,</span>
                              <span class="n">ellipticity_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ELLIP&#39;</span><span class="p">,</span>
                              <span class="n">obsdate_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span>
                              <span class="n">weight_ellipticity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                              <span class="n">weight_seeing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                              <span class="n">weight_depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                              <span class="n">max_numbers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">seeing_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.0</span><span class="p">,</span>
                              <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">18.0</span><span class="p">,</span>
                              <span class="n">ellipticity_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                              <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the best images based on seeing, depth, and ellipticity.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[Union[ScienceImage, ReferenceImage]]</span>
<span class="sd">            List of images to select from.</span>
<span class="sd">        min_obsdate : Union[Time, str, float]</span>
<span class="sd">            Minimum observation date.</span>
<span class="sd">        max_obsdate : Union[Time, str, float]</span>
<span class="sd">            Maximum observation date.</span>
<span class="sd">        seeing_key : str</span>
<span class="sd">            Header keyword for seeing/FWHM in pixel units</span>
<span class="sd">        depth_key : str</span>
<span class="sd">            Header keyword for depth in AB magnitude</span>
<span class="sd">        ellipticity_key : str</span>
<span class="sd">            Header keyword for ellipticity</span>
<span class="sd">        obsdate_key : str</span>
<span class="sd">            Header keyword for observation date</span>
<span class="sd">        weight_ellipticity : float</span>
<span class="sd">            Weight for ellipticity</span>
<span class="sd">        weight_seeing : float</span>
<span class="sd">            Weight for seeing</span>
<span class="sd">        weight_depth : float</span>
<span class="sd">            Weight for depth</span>
<span class="sd">        max_numbers : int, optional</span>
<span class="sd">            Maximum number of images to select.</span>
<span class="sd">        seeing_limit : float</span>
<span class="sd">            Maximum seeing limit in arcseconds</span>
<span class="sd">        depth_limit : float</span>
<span class="sd">            Minimum depth limit in AB magnitude</span>
<span class="sd">        ellipticity_limit : float</span>
<span class="sd">            Maximum ellipticity limit</span>
<span class="sd">        visualize : bool</span>
<span class="sd">            Whether to visualize the selected images</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Whether to print verbose output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (selected_imglist, selected_errormaplist) : Tuple[List[Union[ScienceImage, ReferenceImage]], Optional[List[Errormap]]]</span>
<span class="sd">            List of selected images and optionally their error maps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">seeinglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">depthlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ellipticitylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obsdatelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Querying images...&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{elapsed}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">target_imglist</span>
        <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">seeinglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">seeing_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">depthlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">depth_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">ellipticitylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ellipticity_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">obsdatelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obsdate_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obsdate_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obsdatelist</span><span class="p">)</span>
            <span class="n">min_obs_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">flexible_time_parser</span><span class="p">(</span><span class="n">min_obsdate</span><span class="p">)</span> <span class="k">if</span> <span class="n">min_obsdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Time</span><span class="p">(</span><span class="s1">&#39;1990-01-01&#39;</span><span class="p">)</span>
            <span class="n">max_obs_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">flexible_time_parser</span><span class="p">(</span><span class="n">max_obsdate</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_obsdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid date format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>          
        
        <span class="c1"># Mask for images before max_obsdate</span>
        <span class="n">valid_obs_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsdate_time</span> <span class="o">&lt;</span> <span class="n">max_obs_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">obsdate_time</span> <span class="o">&gt;</span> <span class="n">min_obs_time</span><span class="p">)</span>
        
        <span class="c1"># Also apply validity mask for seeing, depth, ellipticity</span>
        <span class="n">seeinglist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seeinglist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">depthlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">depthlist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">ellipticitylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ellipticitylist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">valid_value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">depthlist</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_value_mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
                    
        <span class="c1"># Apply limits mask</span>
        <span class="n">valid_seeing_mask</span> <span class="o">=</span> <span class="n">seeinglist</span> <span class="o">&lt;</span> <span class="n">seeing_limit</span>
        <span class="n">valid_ellipticity_mask</span> <span class="o">=</span> <span class="n">ellipticitylist</span> <span class="o">&lt;</span> <span class="n">ellipticity_limit</span>
        <span class="n">valid_depth_mask</span> <span class="o">=</span> <span class="n">depthlist</span> <span class="o">&gt;</span> <span class="n">depth_limit</span>
        
        <span class="c1"># Final combined mask (same length as target_imglist)</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">valid_obs_mask</span> <span class="o">&amp;</span>
            <span class="n">valid_value_mask</span> <span class="o">&amp;</span>
            <span class="n">valid_seeing_mask</span> <span class="o">&amp;</span>
            <span class="n">valid_ellipticity_mask</span> <span class="o">&amp;</span>
            <span class="n">valid_depth_mask</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="c1"># Apply final mask</span>
        <span class="n">ell_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">)[</span><span class="n">valid_value_mask</span><span class="p">]</span>
        <span class="n">see_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">)[</span><span class="n">valid_value_mask</span><span class="p">]</span>
        <span class="n">dep_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depthlist</span><span class="p">)[</span><span class="n">valid_value_mask</span><span class="p">]</span>
        <span class="n">obsdate_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsdatelist</span><span class="p">)[</span><span class="n">valid_value_mask</span><span class="p">]</span>
        
        <span class="n">ell_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ellipticitylist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">see_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeinglist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">dep_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depthlist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">imgs_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="n">obsdate_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsdate_time</span><span class="p">)[</span><span class="n">combined_mask</span><span class="p">]</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSpec</span>

        <span class="c1"># Normalize</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">ell_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">ell_filtered</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">see_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">see_filtered</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dep_norm</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dep_filtered</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Compute combined score</span>
        <span class="c1"># You can adjust weights if needed</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ell_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_ellipticity</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">see_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_seeing</span> <span class="o">+</span> <span class="n">dep_norm</span> <span class="o">*</span> <span class="n">weight_depth</span>

        <span class="c1"># Rank and select best images</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">score</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># descending</span>
        <span class="n">best_images</span> <span class="o">=</span> <span class="n">imgs_filtered</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_numbers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_select</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_idx</span><span class="p">)))</span>  <span class="c1"># select top 90%</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_select</span> <span class="o">=</span> <span class="n">max_numbers</span>
        <span class="n">selected_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[:</span><span class="n">num_select</span><span class="p">]</span>

        <span class="c1"># Top N or just best</span>
        <span class="n">best_image</span> <span class="o">=</span> <span class="n">best_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Data for plotting</span>
        <span class="n">x_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">see_all</span><span class="p">)</span>
        <span class="n">y_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dep_all</span><span class="p">)</span>
        <span class="n">c_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ell_all</span><span class="p">)</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">see_filtered</span><span class="p">)</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dep_filtered</span><span class="p">)</span>
        <span class="n">c_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ell_filtered</span><span class="p">)</span>
        <span class="n">x_selected</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">y_selected</span> <span class="o">=</span> <span class="n">y_valid</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">c_selected</span> <span class="o">=</span> <span class="n">c_valid</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        <span class="n">idx_best</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_best</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">[</span><span class="n">idx_best</span><span class="p">]</span>
        <span class="n">y_best</span> <span class="o">=</span> <span class="n">y_valid</span><span class="p">[</span><span class="n">idx_best</span><span class="p">]</span>
        <span class="n">c_best</span> <span class="o">=</span> <span class="n">c_valid</span><span class="p">[</span><span class="n">idx_best</span><span class="p">]</span>

        <span class="c1"># Create marker masks with full length</span>
        <span class="n">marker_sizes_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">marker_alphas_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># Apply valid_value_mask to match x_all, y_all</span>
        <span class="n">marker_sizes</span> <span class="o">=</span> <span class="n">marker_sizes_full</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">]</span>
        <span class="n">marker_alphas</span> <span class="o">=</span> <span class="n">marker_alphas_full</span><span class="p">[</span><span class="n">valid_value_mask</span><span class="p">]</span>

        <span class="c1"># Calculate percentiles (90%, 75%, and 50%)</span>
        <span class="n">p90_x</span><span class="p">,</span> <span class="n">p75_x</span><span class="p">,</span> <span class="n">p50_x</span><span class="p">,</span> <span class="n">p25_x</span><span class="p">,</span> <span class="n">p10_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x_all</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
        <span class="n">p90_y</span><span class="p">,</span> <span class="n">p75_y</span><span class="p">,</span> <span class="n">p50_y</span><span class="p">,</span> <span class="n">p25_y</span><span class="p">,</span> <span class="n">p10_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">y_all</span><span class="p">,</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

        <span class="c1"># Calculate the number of images for each percentile</span>
        <span class="n">num_images_p90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_all</span> <span class="o">&lt;=</span> <span class="n">p90_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_all</span> <span class="o">&gt;=</span> <span class="n">p90_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 10th percentile</span>
        <span class="n">num_images_p75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_all</span> <span class="o">&lt;=</span> <span class="n">p75_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_all</span> <span class="o">&gt;=</span> <span class="n">p75_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 25th percentile</span>
        <span class="n">num_images_p50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_all</span> <span class="o">&lt;=</span> <span class="n">p50_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_all</span> <span class="o">&gt;=</span> <span class="n">p50_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 50th percentile</span>
        <span class="n">num_images_p25</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_all</span> <span class="o">&lt;=</span> <span class="n">p25_x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_all</span> <span class="o">&gt;=</span> <span class="n">p25_y</span><span class="p">))</span>  <span class="c1"># Number of images below or equal to the 75th percentile</span>

        <span class="c1"># Create figure with GridSpec layout</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="c1"># Create scatter plot</span>
            <span class="n">ax_main</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_all</span><span class="p">,</span> <span class="n">y_all</span><span class="p">,</span>
                                <span class="n">c</span><span class="o">=</span><span class="n">c_all</span><span class="p">,</span>
                                <span class="n">s</span><span class="o">=</span><span class="n">marker_sizes</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="n">marker_alphas</span><span class="p">,</span>
                                <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;All images (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_all</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>        
            <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Filtered out images (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_all</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">x_selected</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_main</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Ellipticity&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p90_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p75_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p50_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p25_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p90_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p75_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p50_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p25_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">p90_x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">p10_x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">p10_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p90_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Seeing [arcsec]&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Depth [AB]&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_selected</span><span class="p">,</span> <span class="n">y_selected</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Selected (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_idx</span><span class="p">)</span><span class="si">}</span><span class="s1">) images&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_best</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_best</span><span class="p">,</span> <span class="n">y_best</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Best</span><span class="se">\n</span><span class="s2">Seeing = </span><span class="si">{</span><span class="n">x_best</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec</span><span class="se">\n</span><span class="s2">Depth = </span><span class="si">{</span><span class="n">y_best</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> AB</span><span class="se">\n</span><span class="s2">Ellipticity = </span><span class="si">{</span><span class="n">c_best</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


            <span class="c1"># Create top histogram</span>
            <span class="n">ax_histx</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_main</span><span class="p">)</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide top spine</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide right spine</span>

            <span class="c1"># Create right histogram</span>
            <span class="n">ax_histy</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_main</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide top spine</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide right spine</span>

            <span class="c1"># Set limits for histograms to fit within the black box</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax_main</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax_main</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>

            <span class="c1"># Plot vertical regions for percentiles in histograms</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p90_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">)</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p75_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">)</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p50_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">)</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p25_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>

            <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p90_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p75_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p50_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">p25_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>

            <span class="c1"># Add text annotation in the upper right region of the scatter plot</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Percentile (# of images, Seeing, Depth):</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;90% (</span><span class="si">{</span><span class="n">num_images_p90</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p90_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p90_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;75% (</span><span class="si">{</span><span class="n">num_images_p75</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p75_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p75_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;50% (</span><span class="si">{</span><span class="n">num_images_p50</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p50_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p50_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;25% (</span><span class="si">{</span><span class="n">num_images_p25</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p25_x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p25_y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="n">ax_main</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">ax_main</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.5&#39;</span><span class="p">))</span>
            
            <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

            <span class="n">dashed_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90%&#39;</span><span class="p">),</span>
                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">),</span>
                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">),</span>
                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">dashed_lines</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span>
                    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="n">selected_images</span> <span class="o">=</span> <span class="n">imgs_filtered</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">selected_images</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">match_zeropoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">target_imglist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">]],</span>
                         <span class="n">target_errormaplist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
                         <span class="n">zp_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ZP_APER_1&#39;</span><span class="p">,</span>
                         
                         <span class="c1"># Other parameters</span>
                         <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match the zero points of multiple images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[Union[ScienceImage, CalibrationImage]]</span>
<span class="sd">            List of images to match zero points.</span>
<span class="sd">        target_errormaplist : Optional[List[Errormap]]</span>
<span class="sd">            Optional list of error maps to match zero points.</span>
<span class="sd">        method : str</span>
<span class="sd">            Method to determine reference ZP (&#39;min&#39;, &#39;max&#39;, or &#39;median&#39;).</span>
<span class="sd">        zp_key : str</span>
<span class="sd">            Header keyword for zero point.</span>
<span class="sd">        save : bool</span>
<span class="sd">            Whether to save scaled images and error maps.</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            Whether to overwrite existing files.</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Print progress messages.</span>
<span class="sd">        n_proc : int, optional</span>
<span class="sd">            The number of processes to use for the stacking.</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (scaled_imglist, scaled_errormaplist) : Tuple[List[Union[ScienceImage, CalibrationImage]], Optional[List[Errormap]]]</span>
<span class="sd">            List of zero-matched images and optionally zero-matched error maps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Extract ZPs</span>
        <span class="n">zp_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">load_header</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">zp_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing ZP key &#39;</span><span class="si">{</span><span class="n">zp_key</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">zp_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">zp_key</span><span class="p">]))</span>

        <span class="c1"># Determine reference ZP</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">ref_zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">zp_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">ref_zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">zp_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">ref_zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zp_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[match_zeropoints] Reference ZP: </span><span class="si">{</span><span class="n">ref_zp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> using &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare tasks</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">errormap</span><span class="p">,</span> <span class="n">ref_zp</span><span class="p">,</span> <span class="n">zp_key</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">errormap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_errormaplist</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="c1"># Run with process_map</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Matching ZP...&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">process_map</span><span class="p">(</span><span class="n">_scale_worker</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
        <span class="n">scaled_imglist</span><span class="p">,</span> <span class="n">scaled_errormaplist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">scaled_imglist</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">scaled_errormaplist</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_errormaplist</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">match_seeing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">target_imglist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">]],</span>
                     <span class="n">target_errormaplist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Errormap</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">target_bkglist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Background</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">seeing_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SEEING&#39;</span><span class="p">,</span>
                     <span class="n">kernel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="c1"># gaussian or image</span>
                     
                     <span class="c1"># Other parameters</span>
                     <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ScienceImage</span><span class="p">,</span> <span class="n">CalibrationImage</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match the seeing (PSF FWHM) of multiple images using convolution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_imglist : List[Union[ScienceImage, CalibrationImage]]</span>
<span class="sd">            List of images to match seeing</span>
<span class="sd">        target_errormaplist : Optional[List[Errormap]]</span>
<span class="sd">            Corresponding error maps to also convolve</span>
<span class="sd">        target_bkglist : Optional[List[Background]]</span>
<span class="sd">            Corresponding background maps to also convolve</span>
<span class="sd">        seeing_key : str</span>
<span class="sd">            Header keyword for seeing/FWHM in pixel units</span>
<span class="sd">        kernel : str</span>
<span class="sd">            Convolution kernel type (&#39;gaussian&#39;)</span>
<span class="sd">        save : bool</span>
<span class="sd">            Whether to save the matched images and error maps</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            Whether to overwrite existing files</span>
<span class="sd">        visualize : bool</span>
<span class="sd">            Whether to visualize the matched images and error maps</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Print progress messages</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (matched_imglist, matched_errormaplist) : Tuple[List[Union[ScienceImage, CalibrationImage]], Optional[List[Errormap]]]</span>
<span class="sd">            List of seeing-matched images and optionally their convolved error maps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_matching_kernel</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.convolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">convolve_fft</span>

        <span class="c1"># Get all seeing values</span>
        <span class="n">seeing_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_img</span> <span class="ow">in</span> <span class="n">target_imglist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seeing_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seeing key &#39;</span><span class="si">{</span><span class="n">seeing_key</span><span class="si">}</span><span class="s2">&#39; not found in header of </span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">seeing_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">seeing_key</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)))</span>  <span class="c1"># Convert to pixel units</span>
        
        <span class="c1"># Determine reference seeing based on method</span>
        <span class="n">ref_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">seeing_values</span><span class="p">)</span>
        <span class="n">ref_seeing</span> <span class="o">=</span> <span class="n">seeing_values</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">]</span>  <span class="c1"># Get the actual reference seeing value</span>
        <span class="n">ref_target_img</span> <span class="o">=</span> <span class="n">target_imglist</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">]</span>
        <span class="n">ref_target_bkg</span> <span class="o">=</span> <span class="n">target_bkglist</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">target_bkglist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ref_psf_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ref_seeing</span> <span class="o">*</span> <span class="mi">6</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span>
        
        <span class="c1"># If kernel is &#39;image&#39;, build the PSF model from the reference image</span>
        <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ref_target_img</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">BKGSUB</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
                <span class="n">ref_target_bkg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ref_psf_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfphot</span><span class="o">.</span><span class="n">build_epsf_model_psfex</span><span class="p">(</span>
                <span class="n">target_img</span><span class="o">=</span><span class="n">ref_target_img</span><span class="p">,</span>
                <span class="n">target_bkg</span><span class="o">=</span><span class="n">ref_target_bkg</span><span class="p">,</span>
                <span class="n">fwhm_estimate_pixel</span><span class="o">=</span><span class="n">ref_seeing</span><span class="p">,</span>
                <span class="n">num_grids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">oversampling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">psf_size</span> <span class="o">=</span> <span class="n">ref_psf_size</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">visualize</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">elif</span> <span class="n">kernel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported kernel type &#39;</span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&#39;. Use &#39;image&#39; or &#39;gaussian&#39;&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matching seeing to reference FWHM = </span><span class="si">{</span><span class="n">ref_seeing</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> using </span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2"> method&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        
        <span class="c1"># Convolve each image to match reference seeing</span>
        <span class="n">matched_imglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matched_errormaplist</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">target_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_errormaplist</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Matching seeing...&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">,</span> <span class="n">target_errormaplist</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imglist</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">target_img</span><span class="p">,</span> <span class="n">target_errormap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
            <span class="n">current_seeing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">seeing_key</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">))</span>  <span class="c1"># Convert to pixel units</span>

            <span class="c1"># Define output path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">target_img_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;convolved_</span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">target_errormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">target_errormap_path</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;convolved_</span><span class="si">{</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_img_path</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span>
                <span class="n">target_errormap_path</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">savepath</span><span class="o">.</span><span class="n">savepath</span> <span class="k">if</span> <span class="n">target_errormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                        
            <span class="c1"># Skip convolution if seeing already matches (within small tolerance)</span>
            <span class="n">seeing_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_seeing</span> <span class="o">-</span> <span class="n">ref_seeing</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>  <span class="c1"># Convert to arcseconds</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">3e-1</span>  <span class="c1"># 0.3arcsec</span>
            <span class="k">if</span> <span class="n">seeing_diff</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">matched_img</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">matched_img</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_img_path</span>
                <span class="n">matched_imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_img</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">matched_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_errormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matched_errormap</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">matched_errormap</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">target_errormap_path</span>
                    <span class="n">matched_errormaplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_errormap</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">matched_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">matched_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">matched_errormap</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping convolution for </span><span class="si">{</span><span class="n">target_img</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (already matches reference seeing with the tolerenace </span><span class="si">{</span><span class="n">tolerance</span><span class="si">}</span><span class="s2">arcsec) [diff = </span><span class="si">{</span><span class="n">seeing_diff</span><span class="si">}</span><span class="s2">arcsec]&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Convolve the target image</span>
            <span class="n">target_bkg</span> <span class="o">=</span> <span class="n">target_bkglist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">target_bkglist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">convolved_data</span><span class="p">,</span> <span class="n">updated_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">img_convolve</span><span class="p">(</span>
                    <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">input_type</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
                    <span class="n">target_header</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                    <span class="n">fwhm_target</span><span class="o">=</span><span class="n">current_seeing</span><span class="p">,</span>
                    <span class="n">fwhm_reference</span><span class="o">=</span><span class="n">ref_seeing</span><span class="p">,</span>
                    <span class="n">fwhm_key</span><span class="o">=</span><span class="n">seeing_key</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Build the PSF model for the target image</span>
                <span class="n">target_psf_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfphot</span><span class="o">.</span><span class="n">build_epsf_model_psfex</span><span class="p">(</span>
                    <span class="n">target_img</span><span class="o">=</span><span class="n">target_img</span><span class="p">,</span>
                    <span class="n">target_bkg</span><span class="o">=</span><span class="n">target_bkg</span><span class="p">,</span>
                    <span class="n">fwhm_estimate_pixel</span><span class="o">=</span><span class="n">current_seeing</span><span class="p">,</span>
                    <span class="n">num_grids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">oversampling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">psf_size</span> <span class="o">=</span> <span class="n">ref_psf_size</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span>

                <span class="n">psf_input</span> <span class="o">=</span> <span class="n">target_psf_model</span> <span class="o">/</span> <span class="n">target_psf_model</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">psf_ref</span> <span class="o">=</span> <span class="n">ref_psf_model</span> <span class="o">/</span> <span class="n">ref_psf_model</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">CosineBellWindow</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">TopHatWindow</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">CosineBellWindow</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#window = TopHatWindow(0.35)</span>
                <span class="n">conv_kernel</span> <span class="o">=</span> <span class="n">create_matching_kernel</span><span class="p">(</span><span class="n">psf_input</span><span class="p">,</span> <span class="n">psf_ref</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf_input</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input PSF&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf_ref</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reference PSF&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">conv_kernel</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Convolution Kernel&#39;</span><span class="p">)</span>

                <span class="n">convolved_data</span> <span class="o">=</span> <span class="n">convolve_fft</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">normalize_kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">updated_header</span> <span class="o">=</span> <span class="n">target_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">updated_header</span><span class="p">[</span><span class="n">seeing_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_seeing</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_img</span><span class="o">.</span><span class="n">pixelscale</span><span class="p">)</span>
                
            <span class="n">matched_img</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_img</span><span class="p">)(</span><span class="n">path</span><span class="o">=</span><span class="n">target_img_path</span><span class="p">,</span> <span class="n">telinfo</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">telinfo</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">target_img</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">matched_img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convolved_data</span>
            <span class="n">matched_img</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">updated_header</span>
            <span class="n">matched_imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_img</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">matched_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_errormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                    <span class="n">convolved_error</span> <span class="o">=</span> <span class="n">convolve_fft</span><span class="p">(</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">normalize_kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">convolved_error</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_convolve</span><span class="p">(</span>
                    <span class="n">target_img</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">input_type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
                    <span class="n">target_header</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                    <span class="n">fwhm_target</span><span class="o">=</span><span class="n">current_seeing</span><span class="p">,</span>
                    <span class="n">fwhm_reference</span><span class="o">=</span><span class="n">ref_seeing</span><span class="p">,</span>
                    <span class="n">fwhm_key</span><span class="o">=</span><span class="n">seeing_key</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                    <span class="p">)</span>

                <span class="n">matched_errormap</span> <span class="o">=</span> <span class="n">Errormap</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">target_errormap_path</span><span class="p">,</span> <span class="n">emaptype</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">emaptype</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">target_errormap</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">matched_errormap</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convolved_error</span>
                <span class="n">matched_errormap</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">target_errormap</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">matched_errormaplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_errormap</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">matched_img</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">matched_errormaplist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_errormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matched_errormap</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully matched seeing for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_imglist</span><span class="p">)</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matched_imglist</span><span class="p">,</span> <span class="n">matched_errormaplist</span></div>

<span class="c1"># %%</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hyeonho Choi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>